<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>éœæ ¼æ²ƒèŒ¨QQæ¨¡æ‹Ÿå™¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root {
            --theme-dark: #1a472a; --theme-light: #5d8a5f; --theme-bubble: rgba(26, 71, 42, 0.3); --theme-accent: #d3a625;
            --slytherin-dark: #1a472a; --slytherin-light: #5d8a5f; --gryffindor-dark: #740001; --gryffindor-light: #ae0001;
            --hufflepuff-dark: #372e29; --hufflepuff-light: #ecb939; --ravenclaw-dark: #1C51A3; --ravenclaw-light: #4993C5;
            --dark-bg: #111418; --light-bg: #1c252e;
            --main-font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--main-font); -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        html, body { height: 100%; width: 100%; overflow: hidden; }
        body { background: linear-gradient(135deg, #0a1429 0%, #1c252e 50%, #283446 100%); color: #f0e6d2; display: flex; justify-content: center; align-items: center; position: relative; }
        body::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="none" stroke="%230d1522" stroke-width="2"/></svg>'); background-size: 60px; opacity: 0.4; z-index: -1; }
        
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111418;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            transition: opacity 0.5s ease-out;
            font-family: 'Cinzel', serif;
        }
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .splash-logo {
            font-size: 28px;
            color: var(--theme-accent);
            text-shadow: 0 0 10px var(--theme-accent);
            margin-bottom: 25px;
        }
        .splash-loader {
            width: 50px;
            height: 50px;
            border: 3px solid var(--theme-bubble);
            border-top-color: var(--theme-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .setup-container { width: 100%; max-width: 700px; padding: 25px; border-radius: 20px; background: rgba(24, 30, 40, 0.9); backdrop-filter: blur(5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 1px solid rgba(255,255,255,0.1); }
        .setup-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { margin-bottom: 8px; font-weight: 600; opacity: 0.9; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(20, 30, 40, 0.8); color: white; font-size: 16px; -webkit-user-select: text; user-select: text; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .wand-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        #startAdventureBtn { grid-column: 1 / -1; margin-top: 15px; padding: 15px; border-radius: 10px; border: none; background: linear-gradient(to right, var(--theme-dark), var(--theme-light)); color: white; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; }
        .container { display: flex; flex-direction: column; width: 100%; height: 100vh; height: 100svh; background: rgba(24, 30, 40, 0.9); backdrop-filter: blur(5px); position: relative; }
        .view-header { background: linear-gradient(135deg, var(--theme-dark), var(--theme-light)); padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; box-shadow: 0 4px 10px rgba(0,0,0,0.3); flex-shrink: 0; }
        .view-header h2 { font-weight: 700; font-size: 22px; text-shadow: 0 2px 4px rgba(0,0,0,0.4); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .view-header .back-button { background: rgba(0,0,0,0.2); border: none; color: white; padding: 7px 12px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        .view-header i { font-size: 22px; cursor: pointer; }
        .view-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; -webkit-overflow-scrolling: touch; }
        .navigation { display: grid; grid-template-columns: repeat(4, 1fr); background: rgba(30, 40, 50, 0.8); padding: 8px 0; border-top: 1px solid rgba(255, 255, 255, 0.2); flex-shrink: 0; }
        .nav-item { text-align: center; padding: 8px; font-size: 14px; cursor: pointer; transition: all 0.3s; border-radius: 8px; margin: 0 5px; }
        .nav-item:hover, .nav-item.active { background: var(--theme-bubble); }
        .nav-item i { font-size: 22px; margin-bottom: 4px; display: block; }
        .card { background: rgba(40, 50, 65, 0.7); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); }
        .avatar { background-size: cover; background-position: center; cursor: pointer; }
        .profile-header { display: flex; align-items: center; margin-bottom: 25px; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.7); background-color: #2c3e50; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-right: 20px; flex-shrink: 0; }
        .profile-details { flex: 1; min-width: 0; }
        .profile-name { font-size: 24px; font-weight: 700; margin-bottom: 5px; display: flex; align-items: center; flex-wrap: wrap; cursor: pointer; }
        .info-grid { display: grid; grid-template-columns: auto 1fr; gap: 12px 20px; margin-top: 15px; padding: 10px 0; }
        .info-label { font-weight: bold; color: var(--theme-light); text-align: right; }
        .info-value { font-weight: 500; white-space: pre-wrap; word-break: break-word; }
        .info-value.editable:hover { background-color: var(--theme-bubble); cursor: pointer; border-radius: 5px; padding: 2px 5px; }
        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; color: white; margin: 0 5px 10px 0; }
        .btn.primary { background: linear-gradient(to right, var(--theme-dark), var(--theme-light)); }
        .btn.logout { background: linear-gradient(to right, #c0392b, #e74c3c); }
        .chat-list { display: flex; flex-direction: column; gap: 12px; }
        .chat-item { display: flex; padding: 12px; border-radius: 12px; background: rgba(40, 50, 65, 0.5); border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s; position: relative; }
        .chat-avatar { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; display: flex; justify-content: center; align-items: center; font-size: 28px; color: white; flex-shrink: 0; }
        .chat-content { flex: 1; min-width: 0; }
        .chat-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 600; }
        .chat-header div:last-child { font-size: 13px; opacity: 0.7; flex-shrink: 0; }
        .chat-window { display: flex; flex-direction: column; height: 100%; position: relative; }
        .chat-history { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; background: rgba(15, 22, 33, 0.4); border-radius: 12px; transition: background-image 0.5s ease; -webkit-overflow-scrolling: touch; }
        .chat-history.has-custom-bg .message.incoming { background: rgba(60, 80, 100, 0.85); }
        .chat-history.has-custom-bg .message.outgoing { background: linear-gradient(to right, rgba(93, 138, 95, 0.85), rgba(26, 71, 42, 0.85)); }
        .message { max-width: 80%; padding: 12px 15px; border-radius: 18px; margin: 5px 0; position: relative; animation: fadeIn 0.3s; word-wrap: break-word; box-shadow: 0 2px 4px rgba(0,0,0,0.1); -webkit-user-select: none; user-select: none; }
        .message.incoming { background: rgba(60, 80, 100, 0.6); align-self: flex-start; }
        .message.outgoing { background: var(--theme-light); align-self: flex-end; }
        .message-sender { font-size: 12px; font-weight: bold; margin-bottom: 4px; color: var(--theme-accent); }
        .message-time { font-size: 10px; opacity: 0.7; padding-left: 10px; display: inline-block; }
        .message-text { display: inline; white-space: pre-wrap; -webkit-user-select: text; user-select: text; line-height: 1.6; letter-spacing: 0.5px; }
        .message-image { max-width: 100%; border-radius: 10px; margin-top: 8px; }
        .message-emoji { max-width: 100px; max-height: 100px; display: block; }
        .message-quote { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 8px; position: relative; padding-left: 25px; }
        .message-quote::before { content: 'â€œ'; font-family: 'Cinzel', serif; font-size: 40px; position: absolute; left: 5px; top: 0; line-height: 1; opacity: 0.5; }
        .gift-card { display: flex; align-items: center; gap: 15px; background: #f0e6d2; color: #333; padding: 15px; border-radius: 10px; max-width: 300px; }
        .gift-image { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
        .gift-image-default { width: 60px; height: 60px; border-radius: 8px; flex-shrink: 0; font-size: 3em; display: flex; align-items: center; justify-content: center; background-color: #ddd; color: #333;}
        .gift-details { flex-grow: 1; }
        .gift-title { font-weight: bold; font-size: 1.1em; }
        .gift-message { font-size: 0.9em; opacity: 0.8; margin: 4px 0; }
        .gift-price { font-size: 1.1em; font-weight: bold; color: #c0392b; }
        .chat-input-area { display: flex; flex-direction: column; gap: 10px; padding: 10px; background: transparent; flex-shrink: 0; position: relative; }
        .chat-input-row { display: flex; gap: 8px; align-items: center; }
        .chat-input { flex: 1; position: relative; }
        .chat-input input { width: 100%; padding: 12px 15px; border-radius: 20px; border: none; background: rgba(20, 30, 40, 0.8); color: white; font-size: 16px; -webkit-user-select: text; user-select: text;}
        .chat-actions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
        .action-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px; border-radius: 10px; background: var(--theme-light); color: white; border: none; cursor: pointer; font-size: 12px; gap: 4px; }
        .action-btn.active { background: var(--theme-accent); color: var(--dark-bg); }
        .action-btn i { font-size: 18px; }
        .send-btn { background: #F5F5DC; color: #000000; border: none; cursor: pointer; border-radius: 20px; padding: 0 18px; height: 45px; font-size: 16px; font-weight: 600; }
        .emoji-panel { position: absolute; bottom: 100%; left: 0; right: 0; background: var(--dark-bg); border-top: 1px solid var(--theme-light); border-radius: 15px 15px 0 0; padding: 15px; z-index: 100; display: none; }
        .emoji-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; }
        .emoji-item { width: 60px; height: 60px; object-fit: contain; cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 8px; padding: 5px; }
        .emoji-item-add { display: flex; justify-content: center; align-items: center; font-size: 24px; border: 2px dashed var(--theme-light); }
        .moment-item { background: rgba(40, 50, 65, 0.7); border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .moment-header { display: flex; align-items: center; margin-bottom: 15px; }
        .moment-avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; display: flex; justify-content: center; align-items: center; font-size: 24px; color: white; flex-shrink: 0; }
        .moment-user { flex: 1; min-width: 0; }
        .moment-name { font-weight: 600; font-size: 16px; }
        .moment-time { font-size: 13px; opacity: 0.7; }
        .moment-content { margin-bottom: 15px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; -webkit-user-select: text; user-select: text; }
        .moment-image { width: 100%; max-height: 300px; object-fit: cover; border-radius: 10px; margin-top: 10px; }
        .moment-footer { display: flex; gap: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; margin-top: 15px; }
        .moment-footer-action { cursor: pointer; display: flex; align-items: center; gap: 5px; opacity: 0.8; transition: all 0.2s; }
        .moment-footer-action.liked { color: #e74c3c; opacity: 1; }
        .moment-footer-action:hover { opacity: 1; color: var(--theme-light); }
        .moment-comments { margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        .comment { font-size: 14px; margin-bottom: 8px; cursor: pointer; padding: 4px 6px; border-radius: 4px; transition: background-color 0.2s; }
        .comment:hover { background-color: rgba(255,255,255,0.05); }
        .comment strong { color: var(--theme-light); }
        .comment .reply-to { color: var(--theme-accent); opacity: 0.9; }
        .moment-comment-input-wrapper { margin-top: 15px; display: none; }
        .moment-comment-input-wrapper.active { display: flex; gap: 8px; }
        .moment-comment-input-wrapper input { flex: 1; padding: 8px 12px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); background: rgba(20, 30, 40, 0.8); color: white; -webkit-user-select: text; user-select: text; }
        .moment-comment-input-wrapper button { padding: 8px 15px; border-radius: 15px; border: none; background: var(--theme-light); color: white; cursor: pointer; }
        .friends-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .friend-item { position: relative; background: rgba(40, 50, 65, 0.6); border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .friend-avatar { width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 10px; border: 2px solid var(--theme-light); display: flex; justify-content: center; align-items: center; font-size: 32px; color: white;}
        .view-title { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--theme-bubble); display: flex; align-items: center; gap: 10px; }
        .hidden { display: none !important; }
        .wizard-dialog { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .dialog-content { background: var(--dark-bg); border-radius: 15px; padding: 25px; width: 90%; max-width: 500px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); border: 2px solid var(--theme-light); position: relative; }
        .dialog-title { font-size: 1.5rem; margin-bottom: 20px; color: var(--theme-light); text-align: center; }
        .dialog-actions { display: flex; flex-direction: row; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .dialog-btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: var(--theme-light); color: white; text-align: center; }
        .dialog-btn.cancel-btn { background: #6c757d; }
        .close-dialog-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; color: #f0e6d2; font-size: 2rem; cursor: pointer; line-height: 1; padding: 0; }
        .tabs { display: flex; border-bottom: 1px solid var(--theme-bubble); margin-bottom: 15px; }
        .tab { padding: 10px 15px; cursor: pointer; opacity: 0.7; flex-grow: 1; text-align: center; }
        .tab.active { opacity: 1; border-bottom: 2px solid var(--theme-light); }
        .image-preview { max-width: 100px; max-height: 100px; border-radius: 8px; margin-top: 10px; }
        #context-menu { position: fixed; z-index: 2000; background: var(--dark-bg); border: 1px solid var(--theme-light); border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); padding: 5px 0; min-width: 150px; }
        .context-menu-item { padding: 8px 15px; cursor: pointer; }
        .context-menu-item:hover { background-color: var(--theme-light); }
        .context-menu-item.disabled { opacity: 0.5; cursor: not-allowed; }
        .model-group { display: flex; gap: 10px; align-items: center; }
        .model-group select { flex-grow: 1; }
        .group-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 5px; margin-top: 15px; border-bottom: 1px solid var(--theme-bubble); }
        .group-name { color: var(--theme-light); font-size: 1.1em; }
        .manage-groups-list { max-height: 60vh; overflow-y: auto; padding-right: 10px;}
        .group-manage-item { border: 1px solid var(--theme-bubble); border-radius: 8px; margin-bottom: 10px; overflow: hidden; }
        .group-manage-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.05); cursor: pointer; }
        .group-manage-header-name { display: flex; align-items: center; gap: 10px; }
        .group-manage-header-name .fa-thumbtack { color: var(--theme-accent); }
        .header-arrow { transition: transform 0.3s ease; }
        .header-arrow.expanded { transform: rotate(180deg); }
        .group-manage-members { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: rgba(0,0,0,0.2); }
        .group-manage-members.expanded { max-height: 500px; }
        .group-member-item { display: flex; align-items: center; gap: 12px; padding: 8px 15px; border-top: 1px solid var(--theme-bubble); }
        .group-member-item .avatar { width: 35px; height: 35px; flex-shrink: 0; font-size: 18px; }
        .move-to-group-option { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 8px; background: rgba(255,255,255,0.05); transition: background-color 0.2s; }
        .move-to-group-option:hover { background-color: var(--theme-bubble); }
        .move-to-group-option.current { font-weight: bold; color: var(--theme-accent); }
        .twt-button-list { display: flex; flex-direction: column; gap: 15px; }
        .twt-button { padding: 15px 20px; border-radius: 12px; border: 1px solid var(--theme-accent); background: linear-gradient(135deg, rgba(211, 166, 37, 0.1), rgba(211, 166, 37, 0.2)); color: #f0e6d2; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-align: left; }
        .twt-button:hover { background: linear-gradient(135deg, rgba(211, 166, 37, 0.2), rgba(211, 166, 37, 0.3)); border-color: #f0e6d2; }
        .save-slot-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--theme-bubble); border-radius: 8px; margin-bottom: 10px; }
        .save-slot-item label { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
        .save-slot-info { display: flex; flex-direction: column; }
        .save-slot-info .main-record-tag { font-size: 10px; color: var(--theme-accent); font-weight: bold; }
        
        /* âœ¨ æ–°å¢çš„æœç´¢ç»“æœæ ·å¼ */
        .search-results-container {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid var(--theme-bubble);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .search-result-item:hover {
            background-color: var(--theme-bubble);
        }
        .search-result-header {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 6px;
            opacity: 0.8;
        }
        .search-result-header .time {
            font-size: 12px;
        }
        .search-result-content {
            font-size: 15px;
            line-height: 1.5;
            word-break: break-word;
        }
        .search-result-content .highlight {
            background-color: var(--theme-accent);
            color: var(--dark-bg);
            padding: 1px 3px;
            border-radius: 3px;
        }
        @media (max-width: 768px) {
            .setup-container { width: 100%; height: 100%; max-height: 100vh; border-radius: 0; overflow-y: auto; padding: 20px 15px; }
            .setup-grid { grid-template-columns: 1fr; }
            .wand-group { grid-template-columns: 1fr; }
            .profile-name { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div id="splash-screen">
        <div class="splash-logo">Welcome to Hogwarts</div>
        <div class="splash-loader"></div>
    </div>
    <div id="app-root"></div>
    <div id="context-menu" class="hidden"></div>
<script>
function startApp() {
    (async function() {
        let appHasInitialized = false; 
        setTimeout(() => {
            if (!appHasInitialized) {
                const splash = document.getElementById('splash-screen');
                if (splash) {
                    splash.innerHTML = `
                        <div style="color: #ff4d4d; text-align: center; padding: 20px; font-family: sans-serif;">
                            <h3 style="margin-bottom: 15px;">åº”ç”¨åŠ è½½è¶…æ—¶</h3>
                            <p style="font-size: 14px; line-height: 1.6;">åº”ç”¨æœªèƒ½æˆåŠŸå¯åŠ¨ï¼Œå¯èƒ½æ˜¯ç”±äºæµè§ˆå™¨é™åˆ¶æˆ–æ•°æ®æŸåã€‚</p>
                            <p style="font-size: 12px; margin-top: 20px; color: #aaa;">è¯·å°è¯•ä»¥ä¸‹æ“ä½œï¼š<br>1. å½»åº•å…³é—­å¹¶é‡å¯æµè§ˆå™¨ã€‚<br>2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜/ç½‘ç«™æ•°æ®ã€‚<br>3. åœ¨éšç§/æ— ç—•æ¨¡å¼ä¸‹æ‰“å¼€æ–‡ä»¶ã€‚</p>
                        </div>
                    `;
                }
            }
        }, 10000); 
        const appRoot = document.getElementById('app-root');
        const contextMenu = document.getElementById('context-menu');
        const setupTemplate = `<div class="setup-container" id="setupContainer"><h2 class="setup-title">åˆ›å»ºä½ çš„å·«å¸ˆæ¡£æ¡ˆ</h2><div class="setup-grid"><div class="form-group"><label>å§“</label><input type="text" id="userLastName" placeholder="å¸ƒè±å…‹"></div><div class="form-group"><label>å</label><input type="text" id="userFirstName" placeholder="å¥¥åˆ©ç»´å¨…"></div><div class="form-group"><label>æ€§åˆ«</label><select id="userGender"><option value="å¥³">å¥³</option><option value="ç”·">ç”·</option></select></div><div class="form-group"><label>å­¦é™¢</label><select id="userHouse"><option value="slytherin">æ–¯è±ç‰¹æ—</option><option value="gryffindor">æ ¼å…°èŠ¬å¤š</option><option value="hufflepuff">èµ«å¥‡å¸•å¥‡</option><option value="ravenclaw">æ‹‰æ–‡å…‹åŠ³</option></select></div><div class="form-group"><label>è¡€ç»Ÿ</label><select id="userBlood"><option value="çº¯è¡€">çº¯è¡€</option><option value="æ··è¡€">æ··è¡€</option><option value="éº»ç“œå‡ºèº«">éº»ç“œå‡ºèº«</option></select></div><div class="form-group"><label>å¹´é¾„</label><select id="userAgeYear"><option value="11å² (ä¸€å¹´çº§)">11å² (ä¸€å¹´çº§)</option><option value="12å² (äºŒå¹´çº§)">12å² (äºŒå¹´çº§)</option><option value="13å² (ä¸‰å¹´çº§)">13å² (ä¸‰å¹´çº§)</option><option value="14å² (å››å¹´çº§)" selected>14å² (å››å¹´çº§)</option><option value="15å² (äº”å¹´çº§)">15å² (äº”å¹´çº§)</option><option value="16å² (å…­å¹´çº§)">16å² (å…­å¹´çº§)</option><option value="17å² (ä¸ƒå¹´çº§)">17å² (ä¸ƒå¹´çº§)</option></select></div><div class="form-group full-width"><label>é­”æ–</label><div class="wand-group"><select id="wandCore"><option value="é¾™å¿ƒå¼¦">æ–èŠ¯ï¼šé¾™å¿ƒå¼¦</option><option value="å‡¤å‡°å°¾ç¾½">æ–èŠ¯ï¼šå‡¤å‡°å°¾ç¾½</option><option value="ç‹¬è§’å…½æ¯›">æ–èŠ¯ï¼šç‹¬è§’å…½æ¯›</option></select><input type="text" id="wandWood" placeholder="æœ¨æ"><input type="text" id="wandLength" placeholder="é•¿åº¦"><input type="text" id="wandFlex" placeholder="æŸ”éŸ§åº¦"></div></div><div class="form-group"><label>å®ˆæŠ¤ç¥</label><input type="text" id="userPatronus" placeholder="ä¾‹å¦‚ï¼šé»‘æ›¼å·´è›‡"></div><div class="form-group"><label>å® ç‰©</label><input type="text" id="userPet" placeholder="ä¾‹å¦‚ï¼šæ —è‰²çŒ«å¤´é¹°"></div><div class="form-group full-width"><label>å¤–è²Œç‰¹å¾</label><textarea id="userAppearance" placeholder="ä¾‹å¦‚ï¼šæ·±æ£•è‰²å·å‘ï¼Œç°è‰²è™¹è†œ"></textarea></div><div class="form-group full-width"><label>æ€§æ ¼ç‰¹å¾</label><textarea id="userPersonality" placeholder="ä¾‹å¦‚ï¼šéª„å‚²æ•é”ï¼Œé‡è§†ä¼ ç»Ÿ"></textarea></div><div class="form-group full-width"><label>èº«ä»½èƒŒæ™¯</label><textarea id="userIdentity" placeholder="ä¾‹å¦‚ï¼šæ¥è‡ªä¸€ä¸ªå¤è€çš„çº¯è¡€å®¶æ—ï¼Œå¯¹é»‘é­”æ³•æœ‰æµ“åšå…´è¶£"></textarea></div><div class="form-group full-width"><label>ä¸ªæ€§ç­¾å</label><input type="text" id="userSignature" placeholder="è£è€€æ°¸æ’"></div><button id="startAdventureBtn">è¿›å…¥éœæ ¼æ²ƒèŒ¨</button></div></div>`;
        const mainTemplate = `<div style="position: absolute; width: 300px; height: 300px; border-radius: 50%; background: radial-gradient(circle, var(--theme-bubble) 0%, rgba(0,0,0,0) 70%); pointer-events: none; top: -100px; right: -100px; animation: float 6s ease-in-out infinite;"></div><div style="position: absolute; width: 300px; height: 300px; border-radius: 50%; background: radial-gradient(circle, var(--theme-bubble) 0%, rgba(0,0,0,0) 70%); pointer-events: none; bottom: -80px; left: -50px; animation: float 8s ease-in-out infinite; animation-delay: 1s;"></div><div class="container" id="mainContainer"><div class="view-header"><button class="back-button hidden" id="backButton"><i class="fas fa-arrow-left"></i> è¿”å›</button><h2 id="viewTitle">éœæ ¼æ²ƒèŒ¨QQ</h2><i class="fas fa-cog" id="settingsBtn"></i></div><div class="view-content" id="viewContent"></div><div class="navigation"><div class="nav-item active" data-view="messages"><i class="fas fa-comment-alt"></i><span>æ¶ˆæ¯</span></div><div class="nav-item" data-view="contacts"><i class="fas fa-user-friends"></i><span>è”ç³»äºº</span></div><div class="nav-item" data-view="moments"><i class="fas fa-newspaper"></i><span>åŠ¨æ€</span></div><div class="nav-item" data-view="profile"><i class="fas fa-user"></i><span>æˆ‘</span></div></div></div><div class="wizard-dialog hidden" id="wizardDialog"><div class="dialog-content" id="dialogContent"></div></div>`;
        
        const db = new Dexie('HogwartsVaultDB-v4');
        db.version(6).stores({
            appState: 'id',
            userProfile: 'id',
            apiConfig: 'id',
            contacts: 'id',
            chats: 'id, contactId, isGroup', 
            myMoments: 'id',
            friendMoments: 'id',
            groups: 'id',
            triwizardChapters: 'id'
        });
        
        function getDefaultContacts() { return {
            professors: [ { id: 'prof1', name: "ç±³å‹’å¨ƒÂ·éº¦æ ¼", house: 'gryffindor', icon: 'ğŸ§‘â€ğŸ«', info: "å§“åï¼šç±³å‹’å¨ƒÂ·éº¦æ ¼\nèŒä½ï¼šå˜å½¢æœ¯æ•™æˆã€æ ¼å…°èŠ¬å¤šé™¢é•¿\nç®€ä»‹ï¼šçºªå¾‹ä¸¥æ˜ä½†å†…å¿ƒå…¬æ­£ã€‚", sharedHistory: "", avatar: null }, { id: 'prof2', name: "è¥¿å¼—å‹’æ–¯Â·æ–¯å†…æ™®", house: 'slytherin', icon: 'ğŸ§‘â€ğŸ«', info: "å§“åï¼šè¥¿å¼—å‹’æ–¯Â·æ–¯å†…æ™®\nèŒä½ï¼šé­”è¯å­¦æ•™æˆã€æ–¯è±ç‰¹æ—é™¢é•¿\nç®€ä»‹ï¼šæ€åº¦ä¸¥è‹›ï¼Œè¨€è¾å°–é…¸ã€‚", sharedHistory: "", avatar: null }, { id: 'prof3', name: "è²åˆ©ä¹Œæ–¯Â·å¼—ç«‹ç»´", house: 'ravenclaw', icon: 'ğŸ§‘â€ğŸ«', info: "å§“åï¼šè²åˆ©ä¹Œæ–¯Â·å¼—ç«‹ç»´\nèŒä½ï¼šé­”å’’å­¦æ•™æˆã€æ‹‰æ–‡å…‹åŠ³é™¢é•¿\nç®€ä»‹ï¼šå­¦è¯†æ¸Šåšï¼Œå–„è‰¯ä¸”å¼ºå¤§ã€‚", sharedHistory: "", avatar: null }, { id: 'prof4', name: "æ³¢è«å¨œÂ·æ–¯æ™®åŠ³ç‰¹", house: 'hufflepuff', icon: 'ğŸ§‘â€ğŸ«', info: "å§“åï¼šæ³¢è«å¨œÂ·æ–¯æ™®åŠ³ç‰¹\nèŒä½ï¼šè‰è¯å­¦æ•™æˆã€èµ«å¥‡å¸•å¥‡é™¢é•¿\nç®€ä»‹ï¼šå’Œè”¼å¯äº²ï¼Œçƒ­çˆ±æ¤ç‰©ã€‚", sharedHistory: "", avatar: null }, { id: 'prof5', name: "ç½—å…°è¾¾Â·éœç¦", house: 'hogwarts', icon: 'ğŸ§‘â€ğŸ«', info: "å§“åï¼šç½—å…°è¾¾Â·éœç¦\nèŒä½ï¼šé£è¡Œè¯¾æ•™æˆã€é­åœ°å¥‡è£åˆ¤\nç®€ä»‹ï¼šå¯¹é£è¡Œè§„åˆ™ä¸€ä¸ä¸è‹Ÿã€‚", sharedHistory: "", avatar: null }, { id: 'prof6', name: "é²ä¼¯Â·æµ·æ ¼", house: 'hogwarts', icon: 'ğŸ§‘â€ğŸ«', info: "å§“åï¼šé²ä¼¯Â·æµ·æ ¼\nèŒä½ï¼šéœæ ¼æ²ƒèŒ¨çŒåœºçœ‹å®ˆï¼Œä¿æŠ¤ç¥å¥‡ç”Ÿç‰©è¯¾æ•™æˆ\nç®€ä»‹ï¼šåŠå·¨äººï¼Œæ€§æ ¼æ†¨åšæ€ç»´ç®€å•ï¼Œæ•™å­¦æ°´å¹³å·®ï¼Œè®¤ä¸ºä¼¤å®³æ€§å¼ºçš„ç¥å¥‡ç”Ÿç‰©å¾ˆå¯çˆ±ï¼Œå¾ˆéš¾ä¿å®ˆç§˜å¯†ã€‚", sharedHistory: "", avatar: null }, { id: 'prof7', name: "æ³¢æ¯”Â·åºå¼—é›·", house: 'hogwarts', icon: 'ğŸ§‘â€ğŸ«', info: "å§“åï¼šæ³¢æ¯”Â·åºå¼—é›·\nèŒä½ï¼šéœæ ¼æ²ƒèŒ¨æ ¡åŒ»\nç®€ä»‹ï¼šåŒ»æœ¯é«˜è¶…ã€‚", sharedHistory: "", avatar: null }, { id: 'prof8', name: "é˜¿æ ¼æ–¯Â·è´¹å°”å¥‡", house: 'hogwarts', icon: 'ğŸ§‘â€ğŸ«', info: "å§“åï¼šé˜¿æ ¼æ–¯Â·è´¹å°”å¥‡\nèŒä½ï¼šéœæ ¼æ²ƒèŒ¨ç®¡ç†å‘˜\nç®€ä»‹ï¼šå“‘ç‚®ï¼Œä¸ä¼šé­”æ³•ï¼Œæ€§æ ¼å°–é…¸æ‰­æ›²ï¼Œå–œæ¬¢åˆéš¾å­¦ç”Ÿã€‚", sharedHistory: "", avatar: null }, { id: 'prof9', name: "å¥¥ç½—æ‹‰Â·è¾›å°¼æ–¯å¡”", house: 'hogwarts', icon: 'ğŸ§‘â€ğŸ«', info: "å§“åï¼šå¥¥ç½—æ‹‰Â·è¾›å°¼æ–¯å¡”\nèŒä½ï¼šå¤©æ–‡å­¦æ•™æˆ\nç®€ä»‹ï¼šæ€§æ ¼ç–ç¦»ï¼Œçƒ­çˆ±å¤©æ–‡å­¦ã€‚", sharedHistory: "", avatar: null }, { id: 'prof10', name: "å¡æ–¯ä¼¯ç‰¹Â·å®¾æ–¯", house: 'hogwarts', icon: 'ğŸ§‘â€ğŸ«', info: "å§“åï¼šå¡æ–¯ä¼¯ç‰¹Â·å®¾æ–¯\nèŒä½ï¼šé­”æ³•å²æ•™æˆ\nç®€ä»‹ï¼šå¹½çµï¼Œè®²è¯¾éå¸¸æ— èŠï¼Œæ²‰æµ¸åœ¨è‡ªå·±çš„ä¸–ç•Œé‡Œï¼ŒåªçŸ¥é“è®²è¯¾ï¼Œä¸å…³å¿ƒä»»ä½•äººã€‚", sharedHistory: "", avatar: null }, { id: 'prof11', name: "ä¼Šå°”ç›Â·å¹³æ–¯", house: 'hogwarts', icon: 'ğŸ§‘â€ğŸ«', info: "å§“åï¼šä¼Šå°”ç›Â·å¹³æ–¯\nèŒä½ï¼šéœæ ¼æ²ƒèŒ¨å›¾ä¹¦ç®¡ç†å‘˜\nç®€ä»‹ï¼šæ€§æ ¼ä¸¥è‹›ï¼Œè®¨åŒä»»ä½•æ‰°ä¹±å›¾ä¹¦é¦†ç§©åºçš„ç”Ÿç‰©å’Œéç”Ÿç‰©ã€‚", sharedHistory: "", avatar: null },  ],
            slytherin: [ { id: 'sly1', name: "å¾·æ‹‰ç§‘Â·é©¬å°”ç¦", house: "slytherin", icon: 'ğŸ', info: "è¡€ç»Ÿï¼šçº¯è¡€", sharedHistory: "", avatar: null }, { id: 'sly2', name: "æ½˜è¥¿Â·å¸•é‡‘æ£®", house: "slytherin", icon: 'ğŸ', info: "è¡€ç»Ÿï¼šçº¯è¡€", sharedHistory: "", avatar: null }, { id: 'sly3', name: "è¥¿å¥¥å¤šÂ·è¯ºç‰¹", house: "slytherin", icon: 'ğŸ', info: "è¡€ç»Ÿï¼šçº¯è¡€", sharedHistory: "", avatar: null }, { id: 'sly4', name: "å¸ƒé›·æ–¯Â·æ‰æ¯”å°¼", house: "slytherin", icon: 'ğŸ', info: "è¡€ç»Ÿï¼šçº¯è¡€", sharedHistory: "", avatar: null }, { id: 'sly5', name: "æ–‡æ£®ç‰¹Â·å…‹æ‹‰å¸ƒ", house: "slytherin", icon: 'ğŸ', info: "è¡€ç»Ÿï¼šçº¯è¡€", sharedHistory: "", avatar: null }, { id: 'sly6', name: "æ ¼é›·æˆˆé‡ŒÂ·é«˜å°”", house: "slytherin", icon: 'ğŸ', info: "è¡€ç»Ÿï¼šçº¯è¡€", sharedHistory: "", avatar: null }, { id: 'sly7', name: "è¾¾èŠ™å¦®Â·æ ¼æ—æ ¼æ‹‰æ–¯", house: "slytherin", icon: 'ğŸ', info: "è¡€ç»Ÿï¼šçº¯è¡€", sharedHistory: "", avatar: null }, { id: 'sly8', name: "ç‰¹ä¼¦æ–¯Â·å¸Œæ ¼æ–¯", house: "slytherin", icon: 'ğŸ', info: "èŒä½ï¼šé­åœ°å¥‡æ‰¾çƒæ‰‹", sharedHistory: "", avatar: null }, { id: 'sly9', name: "å¾·é‡Œå®‰Â·æ™®å¡", house: "slytherin", icon: 'ğŸ', info: "èŒä½ï¼šé­åœ°å¥‡è¿½çƒæ‰‹", sharedHistory: "", avatar: null }, { id: 'sly10', name: "æ°ç›Â·æ³•åˆ©", house: "slytherin", icon: 'ğŸ', info: "èŒä½ï¼šçº§é•¿", sharedHistory: "", avatar: null }, ],
            gryffindor: [ { id: 'gry1', name: "å“ˆåˆ©Â·æ³¢ç‰¹", house: "gryffindor", icon: 'ğŸ¦', info: "ç®€ä»‹ï¼šå¤§éš¾ä¸æ­»çš„ç”·å­©", sharedHistory: "", avatar: null }, { id: 'gry2', name: "ç½—æ©Â·éŸ¦æ–¯è±", house: "gryffindor", icon: 'ğŸ¦', info: "è¡€ç»Ÿï¼šçº¯è¡€", sharedHistory: "", avatar: null }, { id: 'gry3', name: "èµ«æ•Â·æ ¼å…°æ°", house: "gryffindor", icon: 'ğŸ¦', info: "è¡€ç»Ÿï¼šéº»ç“œå‡ºèº«", sharedHistory: "", avatar: null }, { id: 'gry4', name: "å¼—é›·å¾·Â·éŸ¦æ–¯è±", house: "gryffindor", icon: 'ğŸ¦', info: "èŒä½ï¼šé­åœ°å¥‡å‡»çƒæ‰‹", sharedHistory: "", avatar: null }, { id: 'gry5', name: "ä¹”æ²»Â·éŸ¦æ–¯è±", house: "gryffindor", icon: 'ğŸ¦', info: "èŒä½ï¼šé­åœ°å¥‡å‡»çƒæ‰‹", sharedHistory: "", avatar: null }, { id: 'gry6', name: "å®‰å‰ä¸½å¨œÂ·çº¦ç¿°é€Š", house: "gryffindor", icon: 'ğŸ¦', info: "èŒä½ï¼šé­åœ°å¥‡è¿½çƒæ‰‹", sharedHistory: "", avatar: null }, { id: 'gry7', name: "ç€è¥¿Â·éŸ¦æ–¯è±", house: "gryffindor", icon: 'ğŸ¦', info: "èŒä½ï¼šçº§é•¿", sharedHistory: "", avatar: null }, { id: 'gry8', name: "å¸•ç“¦è’‚Â·ä½©è’‚å°”", house: "gryffindor", icon: 'ğŸ¦', info: "è¡€ç»Ÿï¼šæ··è¡€", sharedHistory: "", avatar: null }, { id: 'gry9', name: "æ‹‰æ–‡å¾·Â·å¸ƒæœ—", house: "gryffindor", icon: 'ğŸ¦', info: "è¡€ç»Ÿï¼šçº¯è¡€", sharedHistory: "", avatar: null }, { id: 'gry10', name: "è¿ªå®‰Â·æ‰˜é©¬æ–¯", house: "gryffindor", icon: 'ğŸ¦', info: "è¡€ç»Ÿï¼šæ··è¡€", sharedHistory: "", avatar: null }, { id: 'gry11', name: "è¥¿è«Â·æ–å°¼ç”˜", house: "gryffindor", icon: 'ğŸ¦', info: "è¡€ç»Ÿï¼šæ··è¡€", sharedHistory: "", avatar: null }, ],
            ravenclaw: [ { id: 'rav1', name: "æ³°ç‘Â·å¸ƒç‰¹", house: "ravenclaw", icon: 'ğŸ¦…', info: "è¡€ç»Ÿï¼šæ··è¡€", sharedHistory: "", avatar: null }, { id: 'rav2', name: "è¿ˆå…‹å°”Â·ç§‘çº³", house: "ravenclaw", icon: 'ğŸ¦…', info: "è¡€ç»Ÿï¼šæ··è¡€", sharedHistory: "", avatar: null }, { id: 'rav3', name: "å¢å¨œÂ·æ´›å¤«å¤å¾·", house: "ravenclaw", icon: 'ğŸ¦…', info: "ç®€ä»‹ï¼šæ€æƒ³å¤©é©¬è¡Œç©º", sharedHistory: "", avatar: null }, { id: 'rav4', name: "ç§‹Â·å¼ ", house: "ravenclaw", icon: 'ğŸ¦…', info: "èŒä½ï¼šé­åœ°å¥‡æ‰¾çƒæ‰‹", sharedHistory: "", avatar: null }, { id: 'rav5', name: "å®‰ä¸œå°¼Â·æˆˆå¾·æ–¯å¦", house: "ravenclaw", icon: 'ğŸ¦…', info: "è¡€ç»Ÿï¼šæ··è¡€", sharedHistory: "", avatar: null }, { id: 'rav6', name: "å¸•å¾·ç›Â·ä½©è’‚å°”", house: "ravenclaw", icon: 'ğŸ¦…', info: "è¡€ç»Ÿï¼šæ··è¡€", sharedHistory: "", avatar: null }, { id: 'rav7', name: "ä½©å†…æ´›Â·å…‹é‡Œç“¦ç‰¹", house: "ravenclaw", icon: 'ğŸ¦…', info: "èŒä½ï¼šçº§é•¿", sharedHistory: "", avatar: null }, ],
            hufflepuff: [ { id: 'huf1', name: "æ±‰å¨œÂ·è‰¾åš", house: "hufflepuff", icon: 'ğŸ¦¡', info: "è¡€ç»Ÿï¼šæ··è¡€", sharedHistory: "", avatar: null }, { id: 'huf2', name: "å¡å¾·é‡Œå…‹Â·è¿ªæˆˆé‡Œ", house: "hufflepuff", icon: 'ğŸ¦¡', info: "èŒä½ï¼šçº§é•¿ã€é­åœ°å¥‡é˜Ÿé•¿", sharedHistory: "", avatar: null }, { id: 'huf3', name: "è‹çŠÂ·åšæ©æ–¯", house: "hufflepuff", icon: 'ğŸ¦¡', info: "è¡€ç»Ÿï¼šæ··è¡€", sharedHistory: "", avatar: null }, { id: 'huf4', name: "å„å°¼Â·éº¦å…‹ç±³å…°", house: "hufflepuff", icon: 'ğŸ¦¡', info: "è¡€ç»Ÿï¼šçº¯è¡€", sharedHistory: "", avatar: null }, { id: 'huf5', name: "è´¾æ–¯å»·Â·èŠ¬åˆ—é‡Œ", house: "hufflepuff", icon: 'ğŸ¦¡', info: "è¡€ç»Ÿï¼šéº»ç“œå‡ºèº«", sharedHistory: "", avatar: null }, { id: 'huf6', name: "æ‰å¡èµ–æ–¯Â·å²å¯†æ–¯", house: "hufflepuff", icon: 'ğŸ¦¡', info: "è¡€ç»Ÿï¼šæ··è¡€", sharedHistory: "", avatar: null }, ]
        };}
        const HOUSE_INFO = { slytherin: { name: 'æ–¯è±ç‰¹æ—', icon: 'ğŸ', colors: { dark: 'var(--slytherin-dark)', light: 'var(--slytherin-light)' } }, gryffindor: { name: 'æ ¼å…°èŠ¬å¤š', icon: 'ğŸ¦', colors: { dark: 'var(--gryffindor-dark)', light: 'var(--gryffindor-light)' } }, ravenclaw: { name: 'æ‹‰æ–‡å…‹åŠ³', icon: 'ğŸ¦…', colors: { dark: 'var(--ravenclaw-dark)', light: 'var(--ravenclaw-light)' } }, hufflepuff: { name: 'èµ«å¥‡å¸•å¥‡', icon: 'ğŸ¦¡', colors: { dark: 'var(--hufflepuff-dark)', light: 'var(--hufflepuff-light)' } }, hogwarts: { name: 'éœæ ¼æ²ƒèŒ¨', icon: 'ğŸ°', colors: { dark: '#4a4a4a', light: '#888888'} }, };
        let state = {};
        async function loadDataFromDB() {
            try {
                await db.open();
                console.log("æ•°æ®åº“å·²æˆåŠŸæ‰“å¼€ã€‚");
                const [appState, userProfile, apiConfig, contacts, chats, myMoments, friendMoments, groups, triwizardChapters] = await Promise.all([
                    db.appState.get('main'),
                    db.userProfile.get('main'),
                    db.apiConfig.get('main'),
                    db.contacts.toArray(),
                    db.chats.toArray(), 
                    db.myMoments.toArray(),
                    db.friendMoments.toArray(),
                    db.groups.toArray(),
                    db.triwizardChapters.toArray()
                ]);
                
                state = {
                    appInitialized: appState ? appState.initialized : false,
                    currentView: appState ? appState.currentView : 'messages',
                    userProfile: userProfile || { customEmojis: {} },
                    apiConfig: apiConfig || { provider: 'Google', url: '', key: '', model: '' },
                    chats: chats || [], 
                    contacts: contacts || [],
                    groups: groups || [],
                    myMoments: myMoments || [],
                    friendMoments: friendMoments || [],
                    triwizardChapters: triwizardChapters || [],
                    activeContactId: appState ? appState.activeContactId : null,
                    previousView: appState ? appState.previousView : null,
                    replyingTo: appState ? appState.replyingTo : null
                };
                return state.appInitialized;
            } catch (error) {
                console.error("æ•°æ®åº“åˆå§‹åŒ–æˆ–åŠ è½½å¤±è´¥:", error);
                alert(`ä¸¥é‡é”™è¯¯ï¼šæ— æ³•åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨ã€‚æ‚¨çš„æ•°æ®å¯èƒ½æ— æ³•ä¿å­˜ã€‚\né”™è¯¯è¯¦æƒ…: ${error.stack}\nè¯·å°è¯•æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡è¯•ã€‚`);
                return false;
            }
        }
        async function updateAppState() {
            state.appInitialized = true;
            await db.appState.put({
                id: 'main',
                initialized: state.appInitialized,
                currentView: state.currentView,
                activeContactId: state.activeContactId,
                previousView: state.previousView,
                replyingTo: state.replyingTo
            });
        }
        let viewContent, navItems, viewTitle, backButton, wizardDialog, dialogContent, navigation;
        function queryDOMElements() { viewContent = document.getElementById('viewContent'); navItems = document.querySelectorAll('.nav-item'); viewTitle = document.getElementById('viewTitle'); backButton = document.getElementById('backButton'); wizardDialog = document.getElementById('wizardDialog'); dialogContent = document.getElementById('dialogContent'); navigation = document.querySelector('.navigation'); }
        
        async function initializeDefaultData(playerHouse) {
            const d = getDefaultContacts();
            const allHouses = ['slytherin', 'gryffindor', 'ravenclaw', 'hufflepuff'];
            const otherHouses = allHouses.filter(h => h !== playerHouse);
        
            const contacts = [
                ...d.professors,
                ...d[playerHouse],
                ...otherHouses.flatMap(h => d[h]),
                { id: 'åŸåˆ›è§’è‰²1', name: "åŸåˆ›è§’è‰²1", house: 'hogwarts', oc: true, icon: 'ğŸ‘¤', info: "", sharedHistory: "", avatar: null },
                { id: 'åŸåˆ›è§’è‰²2', name: "åŸåˆ›è§’è‰²2", house: 'hogwarts', oc: true, icon: 'ğŸ‘¤', info: "", sharedHistory: "", avatar: null },
                { id: 'åŸåˆ›è§’è‰²3', name: "åŸåˆ›è§’è‰²3", house: 'hogwarts', oc: true, icon: 'ğŸ‘¤', info: "", sharedHistory: "", avatar: null },
                { id: 'åŸåˆ›è§’è‰²4', name: "åŸåˆ›è§’è‰²4", house: 'hogwarts', oc: true, icon: 'ğŸ‘¤', info: "", sharedHistory: "", avatar: null },
                { id: 'åŸåˆ›è§’è‰²5', name: "åŸåˆ›è§’è‰²5", house: 'hogwarts', oc: true, icon: 'ğŸ‘¤', info: "", sharedHistory: "", avatar: null },
                { id: 'åŸåˆ›è§’è‰²6', name: "åŸåˆ›è§’è‰²6", house: 'hogwarts', oc: true, icon: 'ğŸ‘¤', info: "", sharedHistory: "", avatar: null }
            ];
            contacts.forEach(c => c.isPinned = false);
            state.contacts = contacts;
            await db.contacts.bulkPut(contacts);
        
            const defaultGroups = [
                { id: 'group_professors', name: 'æ•™æˆ', contactIds: d.professors.map(c => c.id), isDeletable: true, isRenamable: true, isPinned: false },
                { id: `group_${playerHouse}`, name: HOUSE_INFO[playerHouse].name, contactIds: d[playerHouse].map(c => c.id), isDeletable: true, isRenamable: true, isPinned: false },
                { id: 'group_other_houses', name: 'å…¶ä»–å­¦é™¢', contactIds: otherHouses.flatMap(h => d[h].map(c => c.id)), isDeletable: true, isRenamable: true, isPinned: false },
                { id: 'group_oc', name: 'åŸåˆ›è§’è‰²', contactIds: contacts.filter(c => c.oc).map(c => c.id), isDeletable: true, isRenamable: true, isPinned: false }
            ];
            state.groups = defaultGroups;
            await db.groups.bulkPut(defaultGroups);
        
            await initializeDefaultGroups(playerHouse);
            await initializeTriwizardChapters(playerHouse);
        }
        function applyHouseTheme(house) { if(!house) return; const r = document.documentElement; const c = HOUSE_INFO[house].colors; r.style.setProperty('--theme-dark', c.dark); r.style.setProperty('--theme-light', c.light); }
        
        async function switchView(view, skipHistory = false) { 
            if (!skipHistory) state.previousView = state.currentView; 
            state.currentView = view; 
            const complexViews = ['chat', 'newMoment', 'editFriend', 'triwizard']; 
            if (!complexViews.includes(view)) { 
                navItems.forEach(item => item.classList.toggle('active', item.dataset.view === view)); 
            } 
            backButton.classList.toggle('hidden', !complexViews.includes(view)); 
            if (navigation) navigation.classList.toggle('hidden', view === 'chat'); 
            viewContent.innerHTML = window[`generate${view.charAt(0).toUpperCase() + view.slice(1)}View`](); 
            window[`bind${view.charAt(0).toUpperCase() + view.slice(1)}Events`](); 
            const titles = { messages: 'æ¶ˆæ¯', contacts: 'è”ç³»äºº', moments: 'é­”æ³•åŠ¨æ€', profile: 'æˆ‘çš„ä¸»é¡µ', newMoment: 'å‘å¸ƒåŠ¨æ€', triwizard: 'ä¸‰å¼ºäº‰éœ¸èµ›' }; 
            if(titles[view]) viewTitle.textContent = titles[view]; 
            await updateAppState();
        }
        function showDialog(content, maxWidth = '500px') { dialogContent.style.maxWidth = maxWidth; dialogContent.innerHTML = `<button class="close-dialog-btn">&times;</button>${content}`; wizardDialog.classList.remove('hidden'); wizardDialog.querySelector('.close-dialog-btn').onclick = hideDialog; wizardDialog.onclick = (e) => { if (e.target === wizardDialog) hideDialog(); };}
        function hideDialog() { wizardDialog.classList.add('hidden'); dialogContent.style.maxWidth = '500px'; }
        function handleAvatarUpload(event, callback) { const file = event.target.files[0]; if (!file || !file.type.startsWith('image/')) return; const reader = new FileReader(); reader.onload = (e) => callback(e.target.result); reader.readAsDataURL(file); }
        function getAvatarStyle(avatarUrl, color) { return avatarUrl ? `background-image: url(${avatarUrl})` : `background-color: ${color}`; }
        async function applyCustomFont(url, family) {
            const existingLink = document.getElementById('custom-font-stylesheet');
            if (existingLink) existingLink.remove();
            state.userProfile.fontUrl = url;
            state.userProfile.fontFamily = family;
            await db.userProfile.put({id: 'main', ...state.userProfile});
            const applyFamily = () => {
                const finalFamily = family || `'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
                document.documentElement.style.setProperty('--main-font', finalFamily);
            };
            if (url) {
                const link = document.createElement('link');
                link.id = 'custom-font-stylesheet';
                link.rel = 'stylesheet';
                link.href = url;
                link.onload = applyFamily;
                link.onerror = () => {
                    console.error('Failed to load custom font stylesheet.');
                    alert('è‡ªå®šä¹‰å­—ä½“æ ·å¼è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®ã€‚');
                    applyFamily(); 
                };
                document.head.appendChild(link);
            } else {
                applyFamily();
            }
        }
        window.generateMessagesView = function() {
            const visibleChats = (state.chats || []).filter(chat => !chat.isHidden);
            const header = `<button class="btn primary" id="startTriwizardBtn" style="width:100%; margin-bottom: 20px; background: linear-gradient(to right, #d3a625, #f0e6d2); color: #111418; text-shadow: none;"><i class="fas fa-trophy"></i> ç‚¹å‡»å‚åŠ ä¸‰å¼ºäº‰éœ¸èµ›</button>`;
            if (visibleChats.length === 0) return header + `<div class="card">è¿˜æ²¡æœ‰æ¶ˆæ¯ã€‚å»è”ç³»äººåˆ—è¡¨é‡Œæ‰¾äººèŠèŠå§ï¼</div>`;
            
            let html = header + '<div class="view-title"><i class="fas fa-comments"></i> é­”æ³•æ¶ˆæ¯</div><div class="chat-list">';
            const sortedChats = [...visibleChats].sort((a, b) => (b.isPinned || 0) - (a.isPinned || 0));
            sortedChats.forEach(chat => {
                const contact = chat.isGroup ? null : state.contacts.find(c => c.id === chat.contactId);
                const house = chat.isGroup ? state.userProfile.house : (contact ? contact.house : 'hogwarts');
                const colors = HOUSE_INFO[house].colors;
                const pinIcon = chat.isPinned ? '<i class="fas fa-thumbtack" style="color: var(--theme-accent); position: absolute; top: 12px; right: 12px; font-size: 12px;"></i>' : '';
                
                const isGroupWithAvatar = chat.isGroup && chat.avatar;
                const avatarContent = isGroupWithAvatar ? '' : (chat.isGroup ? 'ğŸ‘¥' : (contact && !contact.avatar ? contact.icon || 'ğŸ‘¤' : ''));
                const avatarStyle = isGroupWithAvatar ? getAvatarStyle(chat.avatar, colors.dark) : (chat.isGroup ? `background-color: ${colors.dark}` : getAvatarStyle(contact?.avatar, colors.dark));
                
                html += `<div class="chat-item" data-chat-id="${chat.id}">
                            <div class="chat-avatar avatar" style="${avatarStyle}">${avatarContent}</div>
                            <div class="chat-content">
                                <div class="chat-header"><div>${chat.name}</div><div>${chat.time}</div></div>
                                <div>${chat.lastMessage}</div>
                            </div>
                            ${pinIcon}
                         </div>`;
            });
            return html + '</div>';
        }
        window.generateContactsView = function() {
            return `
                <div class="tabs">
                    <div class="tab active" data-tab="friends">å¥½å‹</div>
                    <div class="tab" data-tab="groups">ç¾¤èŠ</div>
                </div>
                <div id="contactsContent"></div>
            `;
        }
        
        function renderGroupedContacts() {
            const contactsContent = document.getElementById('contactsContent');
            if (!contactsContent) return;
        
            let html = `<button class="btn primary" id="manageGroupsBtn" style="width:100%;"><i class="fas fa-edit"></i> ç®¡ç†åˆ†ç»„</button><div id="groupsContainer">`;
            const allContactIdsInGroups = new Set(state.groups.flatMap(g => g.contactIds));
        
            const sortedGroups = [...state.groups].sort((a, b) => (b.isPinned || 0) - (a.isPinned || 0));
        
            for (const group of sortedGroups) {
                html += `<div class="group-wrapper" data-group-id="${group.id}">
                            <div class="group-header">
                                <h3 class="group-name">${group.name}</h3>
                            </div>
                            <div class="friends-list">`;
                const members = state.contacts.filter(c => group.contactIds.includes(c.id));
                members.sort((a, b) => (b.isPinned || 0) - (a.isPinned || 0));
                if (members.length > 0) {
                    members.forEach(contact => {
                         const house = contact.house || 'hogwarts';
                         const colors = HOUSE_INFO[house].colors;
                         const pinIcon = contact.isPinned ? '<i class="fas fa-thumbtack" style="color: var(--theme-accent); position: absolute; top: 10px; right: 10px; font-size: 12px;"></i>' : '';
                         html += `<div class="friend-item" data-contact-id="${contact.id}">
                                     ${pinIcon}
                                     <div class="friend-avatar avatar" style="${getAvatarStyle(contact.avatar, colors.dark)}; border-color: ${colors.light};">${!contact.avatar ? contact.icon || 'ğŸ‘¤' : ''}</div>
                                     <div class="friend-name">${contact.name}</div>
                                  </div>`;
                    });
                } else {
                    html += `<p style="opacity: 0.6; padding: 10px 15px;">è¯¥åˆ†ç»„ä¸ºç©º</p>`;
                }
                html += `</div></div>`;
            }
        
            const ungroupedContacts = state.contacts.filter(contact => !allContactIdsInGroups.has(contact.id));
            ungroupedContacts.sort((a, b) => (b.isPinned || 0) - (a.isPinned || 0));
            if (ungroupedContacts.length > 0) {
                html += `<div class="group-wrapper" data-group-id="ungrouped">
                            <div class="group-header"><h3 class="group-name">æœªåˆ†ç»„</h3></div>
                            <div class="friends-list">`;
                ungroupedContacts.forEach(contact => {
                    const house = contact.house || 'hogwarts';
                    const colors = HOUSE_INFO[house].colors;
                    const pinIcon = contact.isPinned ? '<i class="fas fa-thumbtack" style="color: var(--theme-accent); position: absolute; top: 10px; right: 10px; font-size: 12px;"></i>' : '';
                    html += `<div class="friend-item" data-contact-id="${contact.id}">
                                 ${pinIcon}
                                 <div class="friend-avatar avatar" style="${getAvatarStyle(contact.avatar, colors.dark)}; border-color: ${colors.light};">${!contact.avatar ? contact.icon || 'ğŸ‘¤' : ''}</div>
                                 <div class="friend-name">${contact.name}</div>
                              </div>`;
                });
                html += `</div></div>`;
            }
        
            html += `</div>`;
            contactsContent.innerHTML = html;
            bindFriendItemEvents();
            bindFriendsTabEvents();
        }
        function renderGroupsList() {
            const contactsContent = document.getElementById('contactsContent');
            if (!contactsContent) return;
            let html = `<button class="btn primary" id="createGroupBtn" style="width:100%; margin-bottom: 15px;"><i class="fas fa-users"></i> åˆ›å»ºç¾¤èŠ</button><div class="chat-list">`;
            const groupChats = state.chats.filter(c => c.isGroup).sort((a, b) => (b.isPinned || 0) - (a.isPinned || 0));;
            if(groupChats.length === 0) {
                 html += `<div class="card">è¿˜æ²¡æœ‰ç¾¤èŠï¼Œå¿«åˆ›å»ºä¸€ä¸ªå§ï¼</div>`;
            } else {
                groupChats.forEach(chat => {
                    const house = state.userProfile.house;
                    const colors = HOUSE_INFO[house].colors;
                    const pinIcon = chat.isPinned ? '<i class="fas fa-thumbtack" style="color: var(--theme-accent); position: absolute; top: 12px; right: 12px; font-size: 12px;"></i>' : '';
                    const avatarContent = chat.avatar ? '' : 'ğŸ‘¥';
                    const avatarStyle = getAvatarStyle(chat.avatar, colors.dark);
                    html += `<div class="chat-item" data-chat-id="${chat.id}">
                                <div class="chat-avatar avatar" style="${avatarStyle}">${avatarContent}</div>
                                <div class="chat-content">
                                    <div class="chat-header"><div>${chat.name}</div><div>${chat.members.length}äºº</div></div>
                                </div>
                                ${pinIcon}
                            </div>`;
                });
            }
            contactsContent.innerHTML = html + '</div>';
            document.getElementById('createGroupBtn').addEventListener('click', showGroupCreationDialog);
            contactsContent.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('click', function() {
                    state.currentChat = state.chats.find(c => c.id === this.dataset.chatId);
                    if(state.currentChat) switchView('chat');
                });
                addLongPressListener(item, (e) => {
                    e.preventDefault();
                    showContextMenu(e, 'groupChatItem', item.dataset.chatId);
                });
            });
        }
        
        window.generateProfileView = function() {
            const p = state.userProfile;
            const houseName = HOUSE_INFO[p.house].name;
            return `<div class="card"><div class="profile-header"><label for="profileAvatarUpload"><div class="profile-avatar avatar" style="${getAvatarStyle(p.avatar, '#2c3e50')}"></div></label><input type="file" id="profileAvatarUpload" class="hidden" accept="image/*"><div class="profile-details"><div class="profile-name" title="ç‚¹å‡»ä¿®æ”¹å§“å">${p.name}<span class="house-badge" style="background-color: var(--theme-light);">${houseName}</span></div><div>è¡€ç»Ÿ: ${p.blood}</div><div class="editable" data-key="signature" title="ç‚¹å‡»ä¿®æ”¹">${p.signature}</div></div></div></div><div class="card"><h3><i class="fas fa-id-card"></i> å·«å¸ˆæ¡£æ¡ˆ</h3><div class="info-grid"><span class="info-label">å­¦é™¢ï¼š</span><span>${houseName} ${HOUSE_INFO[p.house].icon}</span><span class="info-label">å¹´é¾„ï¼š</span><span class="info-value editable" data-key="age" title="ç‚¹å‡»ä¿®æ”¹">${p.age || 'æœªçŸ¥'}</span><span class="info-label">é­”æ–ï¼š</span><span class="info-value editable" data-parent-key="wand" data-key="wood" title="ç‚¹å‡»ä¿®æ”¹æœ¨æ">${p.wand.wood}</span><span class="info-label"></span><span class="info-value editable" data-parent-key="wand" data-key="core" title="ç‚¹å‡»ä¿®æ”¹æ–èŠ¯">${p.wand.core}</span><span class="info-label"></span><span class="info-value editable" data-parent-key="wand" data-key="length" title="ç‚¹å‡»ä¿®æ”¹é•¿åº¦">${p.wand.length}</span><span class="info-label"></span><span class="info-value editable" data-parent-key="wand" data-key="flex" title="ç‚¹å‡»ä¿®æ”¹æŸ”éŸ§åº¦">${p.wand.flex}</span><span class="info-label">å®ˆæŠ¤ç¥ï¼š</span><span class="info-value editable" data-key="patronus" title="ç‚¹å‡»ä¿®æ”¹">${p.patronus}</span><span class="info-label">å® ç‰©ï¼š</span><span class="info-value editable" data-key="pet" title="ç‚¹å‡»ä¿®æ”¹">${p.pet}</span><span class="info-label">å¤–è²Œï¼š</span><span class="info-value editable" data-key="appearance" title="ç‚¹å‡»ä¿®æ”¹">${p.appearance}</span><span class="info-label">æ€§æ ¼ï¼š</span><span class="info-value editable" data-key="personality" title="ç‚¹å‡»ä¿®æ”¹">${p.personality}</span></div></div><div class="card"><h3><i class="fas fa-robot"></i> å¯¹è¯APIè®¾ç½®</h3><div class="form-group"><label>APIå‚å®¶</label><input type="text" id="apiProvider" value="${state.apiConfig.provider || ''}" placeholder="ä¾‹å¦‚: Google, OpenAI, Groq"></div><div class="form-group"><label>API URL (æ— éœ€æ·»åŠ  /v1/chat/completions)</label><input type="text" id="apiUrl" value="${state.apiConfig.url || ''}" placeholder="ä¾‹å¦‚: https://api.openai.com"></div><div class="form-group"><label>API å¯†é’¥</label><input type="password" id="apiKey" value="${state.apiConfig.key || ''}" placeholder="è¾“å…¥ä½ çš„API Key"></div><div class="form-group"><label>æ¨¡å‹åç§°</label><div class="model-group"><select id="apiModelSelect"><option value="">è¯·å…ˆè·å–æ¨¡å‹åˆ—è¡¨</option></select><button class="btn primary" id="fetchModelsBtn" style="padding: 8px 12px; font-size: 14px; flex-shrink: 0;">è·å–æ¨¡å‹</button></div></div><button class="btn primary" id="testApiBtn" style="margin-top:10px;">æµ‹è¯•è¿æ¥</button><button class="btn primary" id="saveApiConfig" style="margin-top: 15px;"><i class="fas fa-save"></i> ä¿å­˜è®¾ç½®</button></div><div class="card"><h3><i class="fas fa-paint-brush"></i> å¤–è§‚è®¾ç½®</h3><div class="form-group"><label>å­—ä½“CSS URL</label><input type="text" id="fontUrlInput" value="${p.fontUrl || ''}" placeholder="è¾“å…¥.cssæ ¼å¼çš„å­—ä½“é“¾æ¥"></div><div class="form-group"><label>å­—ä½“æ—å (Font Family)</label><input type="text" id="fontFamilyInput" value="${p.fontFamily || ''}" placeholder="ä¾‹å¦‚: 'Noto Sans SC', sans-serif"></div><button class="btn primary" id="applyFontBtn" style="margin-top: 10px;">åº”ç”¨å­—ä½“</button></div><div class="card"><h3><i class="fas fa-cog"></i> è´¦å·è®¾ç½®</h3><button class="btn logout" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> åˆ é™¤æ•°æ®å¹¶é‡å¯</button></div><div class="card"><h3><i class="fas fa-database"></i> æ•°æ®ç®¡ç†</h3><button class="btn primary" id="exportDataBtn"><i class="fas fa-file-export"></i> å¯¼å‡ºå…¨éƒ¨æ•°æ®</button><button class="btn primary" id="importDataBtn"><i class="fas fa-file-import"></i> å¯¼å…¥å…¨éƒ¨æ•°æ®</button><input type="file" id="importDataInput" class="hidden" accept=".json,application/json,text/plain"></div>`;
        }
        window.generateChatView = function() {
            viewTitle.textContent = state.currentChat.name;
            const isGroupChat = state.currentChat.isGroup;
            const isTriwizard = state.currentChat.isTriwizard;
            const historyHtml = (state.currentChat.messages || []).map(msg => {
                let content;
                switch(msg.type) {
                    case 'image': content = `<div class="message-text">${msg.text}</div><img src="${msg.imageData}" class="message-image">`; break;
                    case 'emoji': content = `<img src="${msg.url}" class="message-emoji" alt="${msg.name}">`; break;
                    case 'gift': 
                        const giftImageHtml = msg.gift.image ? `<img src="${msg.gift.image}" class="gift-image">` : `<div class="gift-image-default">ğŸ</div>`;
                        const recipientText = msg.gift.recipient ? ` to <strong>${msg.gift.recipient}</strong>` : '';
                        content = `<div class="gift-card">${giftImageHtml}<div class="gift-details"><div class="gift-title">${msg.gift.name}${recipientText}</div><div class="gift-message">${msg.gift.message}</div><div class="gift-price">Â¥${msg.gift.price}</div></div></div>`; 
                        break;
                    default: content = `${msg.quote ? `<div class="message-quote"><strong>${msg.quote.sender}:</strong> ${msg.quote.text}</div>` : ''}<div class="message-text">${msg.text}</div>`;
                }
                
                let senderHtml = '';
                if (isTriwizard && msg.incoming) {
                    senderHtml = `<div class="message-sender">${msg.sender || 'æ—ç™½'}</div>`;
                }
                else if (isGroupChat && msg.incoming) {
                    senderHtml = `<div class="message-sender">${msg.sender}</div>`;
                } else if ((isGroupChat || isTriwizard) && !msg.incoming) {
                    const myNickname = state.currentChat.myNickname || state.userProfile.name;
                    senderHtml = `<div class="message-sender" style="text-align: right;">${myNickname}</div>`;
                }
                return `<div class="message ${msg.incoming ? 'incoming' : 'outgoing'}" data-message-id="${msg.id}">${senderHtml}${content}<span class="message-time">${msg.time}</span></div>`;
            }).join('');
            
            const groupSettingsButton = isGroupChat ? `<button class="action-btn" id="groupSettingsBtn" title="ç¾¤èŠè®¾ç½®"><i class="fas fa-users-cog"></i><span>ç¾¤è®¾ç½®</span></button>` : '';
            const regularActions = `
                <button class="action-btn" id="searchChatBtn" title="æœç´¢è®°å½•"><i class="fas fa-search"></i><span>æœç´¢</span></button>
                <button class="action-btn" id="aiInitiateMessageBtn" title="AIå‘èµ·å¯¹è¯"><i class="fas fa-magic"></i><span>AIå›å¤</span></button>
                <button class="action-btn" id="offlineModeBtn" title="åˆ‡æ¢çº¿ä¸‹æ¨¡å¼"><i class="fas fa-street-view"></i><span>çº¿ä¸‹æ¨¡å¼</span></button>
                <button class="action-btn" id="emojiBtn" title="å‘é€è¡¨æƒ…"><i class="fas fa-smile"></i><span>è¡¨æƒ…</span></button>
                <button class="action-btn" id="sendImageBtn" title="å‘é€å›¾ç‰‡"><i class="fas fa-image"></i><span>å›¾ç‰‡</span></button>
                <button class="action-btn" id="memoryBtn" title="è®°å¿†"><i class="fas fa-brain"></i><span>è®°å¿†</span></button>
                <button class="action-btn" id="sendGiftBtn" title="èµ é€ç¤¼ç‰©"><i class="fas fa-gift"></i><span>ç¤¼ç‰©</span></button>
                <button class="action-btn" id="chatSettingsBtn" title="èŠå¤©è®¾ç½®"><i class="fas fa-cog"></i><span>è®¾ç½®</span></button>
                ${groupSettingsButton}
            `;
            const triwizardActions = `
                <button class="action-btn" id="searchChatBtn" title="æœç´¢è®°å½•"><i class="fas fa-search"></i><span>æœç´¢</span></button>
                <button class="action-btn" id="aiInitiateMessageBtn" title="å‰§æƒ…æ¨è¿›"><i class="fas fa-magic"></i><span>å‰§æƒ…æ¨è¿›</span></button>
                <button class="action-btn" id="saveStoryBtn" title="ä¿å­˜è®°å½•"><i class="fas fa-save"></i><span>ä¿å­˜è®°å½•</span></button>
            `;
            return `<div class="chat-window">
                        <div class="chat-history" id="chatHistory">${historyHtml}</div>
                        <div class="chat-input-area">
                            <div class="chat-input-row">
                                <div class="chat-input"><input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off"></div>
                                <button class="send-btn" id="sendMessageBtn">å‘é€</button>
                            </div>
                            <div class="chat-actions-grid">
                                ${isTriwizard ? triwizardActions : regularActions}
                            </div>
                            <div class="emoji-panel" id="emojiPanel">
                                <div class="emoji-panel-header">
                                    <h3>è¡¨æƒ…åŒ…</h3>
                                    <div>
                                        <button class="btn primary" id="addEmojiBtn" style="padding: 5px 10px; font-size: 12px;">æ·»åŠ </button>
                                        <button class="btn logout" id="deleteEmojiBtn" style="padding: 5px 10px; font-size: 12px;">åˆ é™¤</button>
                                    </div>
                                </div>
                                <div class="emoji-grid" id="emojiGrid"></div>
                            </div>
                        </div>
                    </div>`;
        }
        window.generateMomentsView = function() { return `<div class="tabs"><div class="tab active" data-tab="friends">å¥½å‹åŠ¨æ€</div><div class="tab" data-tab="mine">æˆ‘çš„åŠ¨æ€</div></div><div id="momentsContent"></div>`; }
        window.generateNewMomentView = function() { 
            return `<div class="card"><h3><i class="fas fa-feather"></i> åˆ†äº«é­”æ³•æ—¶åˆ»</h3><div class="form-group"><label>åŠ¨æ€å†…å®¹</label><textarea id="momentContent" placeholder="..."></textarea></div><div class="form-group"><label>é™„åŠ å›¾ç‰‡</label><input type="file" id="momentImageUpload" accept="image/*"><img id="momentImagePreview" class="image-preview hidden"></div><div class="form-group"><label>å¯è§èŒƒå›´</label><button class="btn primary" id="momentVisibilityBtn" style="justify-content: flex-start;">å…¬å¼€</button></div><div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"><button class="btn logout" id="cancelMoment">å–æ¶ˆ</button><button class="btn primary" id="publishMoment"><i class="fas fa-paper-plane"></i> å‘å¸ƒ</button></div></div>`; 
        }
        window.generateEditFriendView = function() { const c = state.contacts.find(c => c.id === state.activeContactId); viewTitle.textContent = `ç¼–è¾‘ - ${c.name}`; return `<div class="card"><div style="text-align: center; margin-bottom: 20px;"><label for="friendAvatarUpload"><div class="friend-avatar avatar" style="${getAvatarStyle(c.avatar, HOUSE_INFO[c.house].colors.dark)}; margin: 0 auto 10px;">${!c.avatar ? c.icon : ''}</div></label><input type="file" id="friendAvatarUpload" class="hidden" accept="image/*"></div><div class="tabs"><div class="tab active" data-tab="info">å¥½å‹ä¿¡æ¯</div><div class="tab" data-tab="history">å…±åŒç»å†</div></div><div id="tabContent">${c.oc ? `<div class="form-group"><label>è§’è‰²ID</label><input type="text" id="friendId" value="${c.id}"></div>` : ''}<div class="form-group"><label>åŸºæœ¬ä¿¡æ¯</label><textarea id="friendInfo" rows="6">${c.info}</textarea></div></div><button class="btn primary" id="saveFriendInfoBtn" style="width: 100%; margin-top: 20px;"><i class="fas fa-save"></i> ä¿å­˜</button></div>`; }
        window.generateTriwizardView = function() {
            const chapters = [
                { id: 'twt_chap1', name: 'ä¸€ï¼šå‹‡å£«é€‰æ‹”' },
                { id: 'twt_chap2', name: 'äºŒï¼šä¼‘æ¯å®¤çš„å¤œæ™š' },
                { id: 'twt_chap3', name: 'ä¸‰ï¼šå¤œæ¢ç«é¾™' },
                { id: 'twt_chap4', name: 'å››ï¼šæŒ‘æˆ˜ç«é¾™' },
                { id: 'twt_chap5', name: 'äº”ï¼šåœ£è¯èˆä¼šçš„å‰å¥' },
                { id: 'twt_chap6', name: 'å…­ï¼šåœ£è¯èˆä¼šä¹‹å¤œ' },
                { id: 'twt_chap7', name: 'ä¸ƒï¼šæ·±æ¹–çš„è€ƒéªŒ' },
                { id: 'twt_chap8', name: 'å…«ï¼šè¿·å®«çš„ç»ˆç‚¹' },
                { id: 'twt_chap9', name: 'ä¹ï¼šå¢“åœ°çš„å®¿å‘½' }
            ];
            let html = '<div class="twt-button-list">';
            chapters.forEach(chap => {
                html += `<button class="twt-button" data-chapter-id="${chap.id}">${chap.name}</button>`;
            });
            return html + '</div>';
        }
        async function initializeDefaultGroups(playerHouse) {
            const d = getDefaultContacts();
            const allStudents = [...d.slytherin, ...d.gryffindor, ...d.ravenclaw, ...d.hufflepuff];
            
            const dumbledore = {
                id: 'virtual_dumbledore',
                name: 'é˜¿ä¸æ€Â·é‚“å¸ƒåˆ©å¤š',
                nickname: 'é‚“å¸ƒåˆ©å¤šæ ¡é•¿',
                persona: 'éœæ ¼æ²ƒèŒ¨æ ¡é•¿ï¼Œç¿æ™ºã€å¼ºå¤§ä¸”å¶å°”æœ‰äº›å¤æ€ªï¼Œå…³å¿ƒç€æ¯ä¸€ä¸ªå­¦ç”Ÿã€‚',
                sharedHistory: 'ä½œä¸ºæ ¡é•¿ï¼Œä»–ä¸€ç›´é»˜é»˜å…³æ³¨ç€ä½ çš„æˆé•¿ã€‚'
            };
            
            const allContacts = [...d.professors, ...allStudents].filter(c => !c.oc);
            const hogwartsMembers = allContacts.map(c => ({
                id: c.id, name: c.name, nickname: null, persona: c.info, sharedHistory: c.sharedHistory
            }));
            hogwartsMembers.push(dumbledore);
            const hogwartsGroup = {
                id: 'group_hogwarts_default',
                name: 'éœæ ¼æ²ƒèŒ¨ç¾¤',
                isGroup: true,
                members: hogwartsMembers,
                contactId: null,
                lastMessage: 'æ¬¢è¿æ¥åˆ°éœæ ¼æ²ƒèŒ¨ï¼',
                time: new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                messages: [{
                    id: `msg_${Date.now()}`, type: 'text', text: 'æ¬¢è¿æ¥åˆ°éœæ ¼æ²ƒèŒ¨ï¼åœ¨è¿™é‡Œä½ å¯ä»¥å’Œæ‰€æœ‰çš„æ•™æˆã€åŒå­¦äº¤æµã€‚',
                    time: new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                    incoming: true, sender: 'é˜¿ä¸æ€Â·é‚“å¸ƒåˆ©å¤š'
                }],
                background: null, isPinned: false, summary: "éœæ ¼æ²ƒèŒ¨å…¨ä½“å¸ˆç”Ÿçš„äº¤æµç¾¤ã€‚", isHidden: false, isOfflineMode: false, avatar: null, myNickname: null
            };
            
            const houseMembers = d[playerHouse].map(c => ({
                id: c.id, name: c.name, nickname: null, persona: c.info, sharedHistory: c.sharedHistory
            }));
            const houseGroupName = `${HOUSE_INFO[playerHouse].name}å­¦é™¢ç¾¤`;
            const houseGroup = {
                id: `group_${playerHouse}_default`,
                name: houseGroupName,
                isGroup: true,
                members: houseMembers,
                contactId: null,
                lastMessage: 'æ¬¢è¿æ¥åˆ°ä½ çš„å­¦é™¢ï¼',
                time: new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                messages: [{
                    id: `msg_${Date.now() + 1}`, type: 'text', text: `æ¬¢è¿æ‰€æœ‰æ–°ç”Ÿæ¥åˆ°${HOUSE_INFO[playerHouse].name}ï¼è¿™é‡Œæ˜¯æˆ‘ä»¬çš„ä¸“å±äº¤æµåœ°ã€‚`,
                    time: new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                    incoming: true, sender: 'çº§é•¿' 
                }],
                background: null, isPinned: false, summary: `ä¸“å±äº${HOUSE_INFO[playerHouse].name}å­¦é™¢çš„å†…éƒ¨äº¤æµç¾¤ã€‚`, isHidden: false, isOfflineMode: false, avatar: null, myNickname: null
            };
            await db.chats.bulkPut([hogwartsGroup, houseGroup]);
            state.chats = await db.chats.toArray();
        }
        function generateDefaultTriwizardChapters(playerHouse) {
             const intros = {
                twt_chap1: 'ä¸‡åœ£èŠ‚çš„æ™šå®´æ€»æ˜¯éœæ ¼æ²ƒèŒ¨ä¸€å¹´ä¸­æœ€ç››å¤§çš„åº†å…¸ä¹‹ä¸€ï¼Œä½†ä»Šæ™šï¼Œç©ºæ°”ä¸­å¼¥æ¼«çš„ä¸å…¶è¯´æ˜¯èŠ‚æ—¥çš„æ¬¢æ„‰ï¼Œä¸å¦‚è¯´æ˜¯ä¸€ç§è¿‘ä¹æ²¸è…¾çš„æœŸå¾…ã€‚\nå—ç“œç¯çš„çƒ›ç«åœ¨æ¯ä¸€å¼ å¹´è½»çš„è„¸ä¸Šè·³è·ƒï¼Œæ˜ ç…§å‡ºä»–ä»¬ç´§å¼ è€Œå…´å¥‹çš„ç¥æƒ…ã€‚é‚“å¸ƒåˆ©å¤šç«™åœ¨ä¸»å®¾å¸­å‰ï¼Œä»–æ·±é‚ƒçš„è“çœ¼ç›ä¼¼ä¹èƒ½ç©¿é€æ¯ä¸€ä¸ªå­¦ç”Ÿçš„å†…å¿ƒã€‚\néšç€ä»–çš„å®£å‘Šï¼Œç«ç„°æ¯â€”â€”é‚£åªå¤è€ã€å¸ƒæ»¡ç¬¦æ–‡ä¸”æ•£å‘ç€å¹½è“è‰²å…‰èŠ’çš„é­”æ³•å™¨ç‰©â€”â€”ç»ˆäºè¦æ­æ™“å®ƒçš„é€‰æ‹©äº†ã€‚å¾·å§†æ–¯ç‰¹æœ—çš„å¨å…‹å¤šå°”Â·å…‹é²å§†ï¼Œå¸ƒæ–¯å·´é¡¿çš„èŠ™è“‰Â·å¾·æ‹‰åº“å°”ï¼Œä»¥åŠéœæ ¼æ²ƒèŒ¨çš„å¡å¾·é‡Œå…‹Â·è¿ªæˆˆé‡Œï¼Œä¸‰ä¸ªåå­—è¢«ç«ç„°ä¾æ¬¡åå‡ºï¼Œæ¯ä¸€æ¬¡éƒ½ä¼´éšç€é›·é¸£èˆ¬çš„æŒå£°ä¸æ¬¢å‘¼ã€‚\nç„¶è€Œï¼Œå½“æ‰€æœ‰äººéƒ½ä»¥ä¸ºå°˜åŸƒè½å®šæ—¶ï¼Œç«ç„°æ¯çš„è“è‰²ç«ç„°å´çŒ›åœ°å†æ¬¡çªœé«˜ï¼Œå˜æˆäº†ä¸ç¥¥çš„çº¢è‰²ã€‚ä¸€å¼ çƒ§ç„¦çš„ç¾Šçš®çº¸è¢«å–·å°„å‡ºæ¥ï¼Œé‚“å¸ƒåˆ©å¤šä¸‹æ„è¯†åœ°æŠ“ä½å®ƒï¼Œå¿µå‡ºäº†é‚£ä¸ªè®©æ•´ä¸ªç¤¼å ‚é™·å…¥æ­»å¯‚çš„åå­—ï¼šâ€œå“ˆåˆ©Â·æ³¢ç‰¹â€ã€‚\néªšåŠ¨ã€è´¨ç–‘ä¸æ„¤æ€’å¦‚åŒç˜Ÿç–«èˆ¬è”“å»¶å¼€æ¥ã€‚å°±åœ¨è¿™æ··ä¹±çš„é¡¶ç‚¹ï¼Œåœ¨ä½ å‡ ä¹è¦å› å‘¨å›´çš„å–§åš£ä»¥ä¸ºè¿™ä¸€åˆ‡ä¸è¿‡æ˜¯ä¸€åœºè’å”çš„é—¹å‰§æ—¶ï¼Œé‚£è¯¥æ­»çš„ç«ç„°æ¯ï¼Œå±…ç„¶åˆä¸€æ¬¡åå‡ºäº†ä¸€å¼ å­—æ¡ã€‚\né‚“å¸ƒåˆ©å¤šçš„å£°éŸ³ç¬¬ä¸‰æ¬¡å“å½»ç¤¼å ‚ï¼Œè€Œè¿™ä¸€æ¬¡ï¼Œä»–å¿µå‡ºçš„ï¼Œæ˜¯ä½ çš„åå­—ã€‚',
                twt_chap2: {
                    gryffindor: 'ä½ å¤´ç–¼åœ°å¬ç€ä¸»åŠæ–¹ä»¬çš„äº‰è®ºï¼Œä»€ä¹ˆéƒ½æ²¡å¬è¿›å»ï¼ŒåªçŸ¥é“è¿«äºç«ç„°æ¯é€‰ä¸­çš„å‹‡å£«å¿…é¡»å‚èµ›çš„è§„çŸ©ï¼Œä½ å’Œå“ˆåˆ©æœ€ç»ˆä»ç„¶æˆä¸ºäº†ä¸‰å¼ºäº‰éœ¸èµ›çš„ç¬¬å››ã€ç¬¬äº”åå‹‡å£«ã€‚\nä½ å‡ ä¹ä¸è®°å¾—è‡ªå·±æ˜¯å¦‚ä½•ç©¿è¿‡é‚£äº›å……æ»¡å®¡è§†ã€æ€€ç–‘ã€å«‰å¦’ä¸å›°æƒ‘çš„çœ¼ç¥ï¼Œå›åˆ°å…¬å…±ä¼‘æ¯å®¤çš„â€”â€”æ˜¯çš„ï¼Œè¿é—¨å£çš„èƒ–å¤«äººä¹Ÿå¼€å§‹å…«å¦ä½ å’Œå“ˆåˆ©è¿™ä¸¤ä¸ªâ€œåˆšè¢«é€‰ä¸­çš„å‹‡å£«â€ã€‚\nå“ˆåˆ©çš„æƒ…ç»ªè¿˜ç®—ç¨³å®šï¼Œæˆ–è®¸æ˜¯å› ä¸ºä½ ä»¬ä¸¤äººå…±åŒå—éš¾åœ¨ä»–çœ¼é‡Œæ€»å¥½è¿‡ä»–ä¸€ä¸ªäººå€’éœ‰ã€‚\nè‚–åƒç”»æ‰“å¼€æ—¶ï¼Œçªç„¶çŒè¿›è€³æœµçš„å–§å“—å£°éœ‡å¾—ä½ ä»¬å·®ç‚¹å„¿ä»°é¢æ‘”å€’ã€‚æ¥ç€ï¼Œä½ ä»¬ä¿©è¢«å¤§çº¦åå‡ åŒæ‰‹æ‹½è¿›äº†å…¬å…±ä¼‘æ¯å®¤ï¼Œé¢å¯¹ç€æ ¼å…°èŠ¬å¤šå­¦é™¢çš„å…¨ä½“åŒå­¦ã€‚ä»–ä»¬å…¨éƒ½åœ¨å°–å«ã€æ¬¢å‘¼ã€å¹å£å“¨ã€‚\nâ€œä½ ä»¬åº”è¯¥å‘Šè¯‰æˆ‘ä»¬ä½ ä»¬æŠ¥äº†åï¼â€å¼—é›·å¾·å¤§å£°å¼é“ã€‚ä»–çœ‹ä¸Šå»åŠæ˜¯æ¼æ€’ã€åŠæ˜¯æ¿€åŠ¨ã€‚\nâ€œä½ ä»¬æ€ä¹ˆèƒ½ä¸é•¿èƒ¡å­å°±é¡ºåˆ©è¿‡å…³äº†ï¼Ÿâ€ä¹”æ²»åš·åš·é“ã€‚\nå®‰å‰åˆ©å¨œæ—‹é£èˆ¬åœ°å†²åˆ°ä½ ä»¬é¢å‰ï¼Œâ€œå“¦ï¼Œå³ä½¿ä¸å¯èƒ½æ˜¯æˆ‘ï¼Œè‡³å°‘ä¹Ÿæ˜¯æ ¼å…°èŠ¬å¤šçš„ä¸€å‘˜å•Šâ€”â€”å•Šä¸ï¼Œæ˜¯ä¸¤ä½ï¼â€\nâ€œæˆ‘ä»¬å‡†å¤‡äº†åƒçš„ä¸œè¥¿ï¼Œä½ ä»¬å¿«è¿‡æ¥åƒç‚¹å„¿â€”â€”â€\næ²¡æœ‰äººæ„¿æ„å¬ä½ ä»¬è¯´ä½ ä»¬æ²¡æœ‰æŠŠåå­—æŠ•è¿›é«˜è„šæ¯ï¼Œä¼¼ä¹è°ä¹Ÿæ²¡æœ‰æ³¨æ„åˆ°ä½ ä»¬æ ¹æœ¬å°±æ²¡æœ‰æƒ…ç»ªåº†ç¥è¿™ä»¶äº‹â€¦â€¦ä½ ä»¬æ²¡æœ‰åŠæ³•è„±èº«ï¼Œæ¯å½“ä½ ä»¬æƒ³å·å·æºœå‘é€šå¾€å®¿èˆçš„æ¥¼æ¢¯æ—¶ï¼Œäººç¾¤å°±å‘ä½ ä»¬é æ‹¢ï¼ŒæŠŠä½ ä»¬å›¢å›¢å›´ä½ï¼Œå¼ºè¿«ç€å†å–ä¸€æ¯é»„æ²¹å•¤é…’ï¼Œæˆ–æŠŠé¥¼å¹²å’ŒèŠ±ç”Ÿç¡¬å¡è¿›ä½ ä»¬æ‰‹é‡Œâ€¦â€¦æ¯ä¸ªäººéƒ½æƒ³çŸ¥é“ä½ ä»¬æ˜¯æ€ä¹ˆåŠæˆçš„ï¼Œä½ ä»¬æ˜¯æ€ä¹ˆéª—è¿‡é‚“å¸ƒåˆ©å¤šçš„å¹´é¾„çº¿ï¼ŒæŠŠåå­—æŠ•è¿›é«˜è„šæ¯çš„â€¦â€¦\nä¸çŸ¥ç‹‚æ¬¢äº†å¤šä¹…ï¼Œäººç¾¤é€æ¸æ•£å»ï¼Œä½ å’Œå“ˆåˆ©æ‹–ç€ç–²æƒ«çš„èº«ä½“å‡†å¤‡å›åˆ°å¯å®¤ï¼Œå´çœ‹è§è§’è½é‡Œçš„ä¸€ä¸ªæ ¼å…°èŠ¬å¤šå­¦ç”Ÿå‘ä½ ä»¬æ‹›æ‰‹ã€‚\nâ€œå˜¿ï¼Œä¸¤ä½ï¼æˆ‘æˆ–è®¸çŸ¥é“ä½ ä»¬çš„åå­—æ˜¯æ€ä¹ˆè¢«æ‰”è¿›å»çš„ï¼â€é‚£å°å­©çœ‹ä¸Šå»å¹¶ä¸å¤§ï¼Œä½†ä¸€å‰¯è¦åˆ†äº«ä¸€ä¸ªå·¨å¤§ç§˜å¯†çš„æ¨¡æ ·ç€å®è®©ä½ ä»¬å¿ƒä¸‹ä¸€åŠ¨ã€‚\nâ€œå¬ç€ï¼Œå‰äº›å¤©ï¼Œå¤§åŠå¤œçš„æ—¶å€™ï¼Œæˆ‘çœ‹è§æœ‰ä¸ªæ‹‰æ–‡å…‹åŠ³çš„é«˜å¹´çº§å­¦ç”Ÿï¼ŒèƒŒäº†é‚£â€”â€”ä¹ˆå¤šçš„çº¸æ¡ï¼Œâ€é‚£ä¸ªå­¦ç”Ÿå¤¸å¼ åœ°å¼ å¤§åŒè‡‚ï¼Œâ€œè·¨è¿›å¹´é¾„çº¿åä¸€è‚¡è„‘å­éƒ½æ‰”è¿›äº†ç«ç„°æ¯é‡Œé¢ï¼ä»–çš„æ‰‹ä¸Šè¿˜åœ¨åšè®°å½•ï¼æˆ‘æ¡äº†ä¸€å¼ æ¼å‡ºæ¥çš„çº¸æ¡ï¼Œä¸Šé¢å°±æ˜¯ä¸ªäººåï¼æˆ‘çŒœåˆæ˜¯ä¸ªæƒ³æµ‹è¯•ç«ç„°æ¯æœºåˆ¶çš„æ‹‰æ–‡å…‹åŠ³ã€‚â€\nä½ å’Œå“ˆåˆ©é¢é¢ç›¸è§‘ï¼Œå¿ƒé‡Œå´å·²ç»ä¿¡äº†å‡ åˆ†ã€‚\nä¸€åœºè®©ä½ ä»¬æ— æ³•æ‹’ç»å‚åŠ çš„å¯èƒ½ä¸§å‘½çš„æ¯”èµ›ï¼ŒåŸæ¥æ˜¯ä¸ªåšç ”ç©¶çš„æ‹‰æ–‡å…‹åŠ³å¹²çš„ï¼ŒçœŸä»–å¦ˆçš„åˆç†ï¼ŒçœŸä»–å¦ˆçš„æ¼‚äº®ã€‚',
                    slytherin: 'ä½ å¤´ç–¼åœ°å¬ç€ä¸»åŠæ–¹ä»¬çš„äº‰è®ºï¼Œä»€ä¹ˆéƒ½æ²¡å¬è¿›å»ã€‚æœ€ç»ˆï¼Œåœ¨â€œå¥‘çº¦é­”æ³•ä¸å¯è¿èƒŒâ€çš„å¤è€è§„åˆ™ä¸‹ï¼Œä½ å’Œå“ˆåˆ©Â·æ³¢ç‰¹æˆä¸ºäº†è¿™åœºé—¹å‰§é‡Œå¤šå‡ºæ¥çš„ä¸¤ä¸ªå°ä¸‘ã€‚\nå›åœ°çª–çš„è·¯ä¸Šï¼Œä½ æ„Ÿå—åˆ°çš„ä¸æ˜¯æ ¼å…°èŠ¬å¤šå¼çš„å–§é—¹ï¼Œè€Œæ˜¯ä¸€ç§æ›´ä¸ºå†°å†·ã€æ›´ä¸ºå°–é”çš„æ²‰é»˜ã€‚æ¯ä¸€ä¸ªä¸ä½ æ“¦è‚©è€Œè¿‡çš„æ–¯è±ç‰¹æ—å­¦ç”Ÿï¼Œçœ¼ç¥ä¸­éƒ½å¸¦ç€æ¯«ä¸æ©é¥°çš„å®¡è§†ä¸è¯„ä¼°ã€‚\né€šå¾€å…¬å…±ä¼‘æ¯å®¤çš„å£ä»¤ä»¿ä½›æ˜¯ä¸€ä¸ªåˆ†ç•Œçº¿ï¼Œå½“ä½ è¸å…¥é‚£ç‰‡è¢«æ¹–æ°´æ˜ æˆå¹½ç»¿è‰²çš„ç©ºé—´æ—¶ï¼Œä½ ç«‹åˆ»æˆä¸ºäº†æ‰€æœ‰ç›®å…‰çš„ç„¦ç‚¹ã€‚è¿™é‡Œæ²¡æœ‰æ¬¢å‘¼ï¼Œæ²¡æœ‰åº†ç¥ï¼Œåªæœ‰å£ç‚‰é‡Œç‡ƒçƒ§çš„ç«ç„°å‘å‡ºå™¼å•ªçš„å£°å“ï¼Œä»¥åŠå¾·æ‹‰ç§‘Â·é©¬å°”ç¦é‚£æ ‡å¿—æ€§çš„ã€æ‹–é•¿äº†çš„å˜²è®½å£°è°ƒï¼šâ€œå“¦ï¼Œçœ‹çœ‹è°å›æ¥äº†ï¼Ÿæˆ‘ä»¬ä¼Ÿå¤§çš„ã€å‡ºäººæ„æ–™çš„å‹‡å£«ã€‚çœŸæ²¡æƒ³åˆ°ï¼Œæˆ‘ä»¬å­¦é™¢ç«Ÿç„¶æœ‰äººä¼šç”¨å¦‚æ­¤â€¦â€¦â€˜æ ¼å…°èŠ¬å¤šå¼â€™çš„é²è½æ–¹å¼å»è¿½æ±‚è£èª‰ï¼Œç”šè‡³ä¸æƒœå’Œé‚£ä¸ªåœ£äººæ³¢ç‰¹ä¸€èµ·åˆ†äº«é£å¤´ã€‚â€\nä»–çš„è¯å¼•æ¥äº†ä¸€é˜µå‹æŠ‘çš„çªƒç¬‘ã€‚æ½˜è¥¿Â·å¸•é‡‘æ£®é åœ¨ä»–çš„èº«è¾¹ï¼Œç”¨ä¸€ç§æ‰“é‡è´§ç‰©çš„çœ¼ç¥çœ‹ç€ä½ ï¼šâ€œç’è¿‡é‚“å¸ƒåˆ©å¤šçš„å¹´é¾„çº¿ï¼Œè¿™æ‰‹æ³•å€’è¿˜ç®—èªæ˜ã€‚ä½†ä½ å›¾ä»€ä¹ˆå‘¢ï¼Ÿè®©æ–¯è±ç‰¹æ—çš„è£è€€ä¸ä¸€ä¸ªæ³¢ç‰¹å¹¶åˆ—ï¼Ÿè¿˜æ˜¯è¯´ï¼Œä½ æ ¹æœ¬å°±æ˜¯ä¸ªå½»å¤´å½»å°¾çš„è ¢è´§ï¼Œè¢«äººåˆ©ç”¨äº†ï¼Ÿâ€å‘¨å›´æ²¡æœ‰äººä¸ºä½ è¾©è§£ï¼Œä»–ä»¬åªæ˜¯å†·çœ¼æ—è§‚ï¼Œä¼¼ä¹åœ¨ç­‰å¾…ä½ ç»™å‡ºä¸€ä¸ªèƒ½è®©ä»–ä»¬ä¿¡æœçš„ã€ç¬¦åˆæ–¯è±ç‰¹æ—åˆ©ç›Šçš„è§£é‡Šã€‚\nè¿™æ—¶ï¼Œä¸€ä¸ªå¹³æ—¥é‡Œå¹¶ä¸èµ·çœ¼çš„åŒçº§ç”Ÿæ‚„æ‚„å‡‘åˆ°ä½ èº«è¾¹ï¼Œç”¨åªæœ‰ä½ ä»¬ä¸¤äººèƒ½å¬åˆ°çš„å£°éŸ³è¯´ï¼šâ€œåˆ«ç†ä»–ä»¬ï¼Œå›å¤åªä¼šè®©ä»–ä»¬è§‰å¾—ä½ æ›´æ„šè ¢ã€‚ä¸è¿‡â€¦â€¦æˆ‘å¯èƒ½çŸ¥é“è¿™æ˜¯æ€ä¹ˆå›äº‹ã€‚å‰å‡ å¤©æ™šä¸Šï¼Œæˆ‘çœ‹åˆ°ä¸€ä¸ªæ‹‰æ–‡å…‹åŠ³çš„ç–¯å­å¾€ç«ç„°æ¯é‡Œæ‰”äº†ä¸€å¤§å †åå­—ï¼Œåƒæ˜¯åœ¨æµ‹è¯•ç«ç„°æ¯çš„ä»€ä¹ˆé­”æ³•æé™ã€‚æˆ‘çŒœï¼Œä½ åªæ˜¯ä»–é‚£ä¸ªæ„šè ¢å®éªŒé‡Œæœ€å€’éœ‰çš„æ ·æœ¬ã€‚åˆ«è®©ä»–ä»¬çŸ¥é“ï¼Œå¦åˆ™ä½ ä¼šä»â€˜æ„šè ¢çš„è¿½åè€…â€™å˜æˆâ€˜è¢«æ‹‰æ–‡å…‹åŠ³è€äº†çš„å‚»ç“œâ€™ï¼Œé‚£æ›´ç³Ÿã€‚â€',
                    ravenclaw: 'ä½ å¤´ç–¼åœ°å¬ç€ä¸»åŠæ–¹ä»¬çš„äº‰è®ºï¼Œæœ€ç»ˆåœ¨é­”æ³•å¥‘çº¦çš„çº¦æŸä¸‹ï¼Œä½ å’Œå“ˆåˆ©Â·æ³¢ç‰¹æˆä¸ºäº†è¿™åœºæ¯”èµ›ä¸­ä¸¤ä¸ªæœ€ä¸åˆé€»è¾‘çš„å˜é‡ã€‚\nå½“ä½ æ€€ç€å¤æ‚çš„å¿ƒæƒ…å›åˆ°æ‹‰æ–‡å…‹åŠ³å…¬å…±ä¼‘æ¯å®¤æ—¶ï¼Œè¿æ¥ä½ çš„æ—¢ä¸æ˜¯çƒ­çƒˆçš„åº†ç¥ï¼Œä¹Ÿä¸æ˜¯å†°å†·çš„å®¡è§†ï¼Œè€Œæ˜¯ä¸€ç§â€¦â€¦è¿‘ä¹ç‹‚çƒ­çš„å­¦æœ¯æ¢ç©¶æ°›å›´ã€‚\nä½ ä¸€è¸å…¥ä¼‘æ¯å®¤ï¼Œç«‹åˆ»è¢«ä¸€ç¾¤åŒå­¦å›´å¾—æ°´æ³„ä¸é€šï¼Œä»–ä»¬æ‰‹é‡Œç”šè‡³è¿˜æ‹¿ç€ç¬”è®°æœ¬å’Œç¾½æ¯›ç¬”ã€‚â€œä½ æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿâ€ä¸€ä¸ªçº§é•¿æ¨äº†æ¨çœ¼é•œï¼Œçœ¼ç¥é‡Œé—ªçƒç€æ±‚çŸ¥çš„å…‰èŠ’ï¼Œâ€œé‚“å¸ƒåˆ©å¤šçš„å¹´é¾„çº¿æ˜¯ä¸€ç§éå¸¸é«˜æ·±çš„é­”æ³•ï¼Œæˆ‘ä»¬æ¨ç®—äº†åä¸ƒç§ç ´è§£æ–¹æ³•ï¼Œä½†éƒ½å­˜åœ¨æ‚–è®ºã€‚ä½ ç”¨çš„æ··æ·†å’’å—ï¼Ÿè¿˜æ˜¯æŸç§ç½•è§çš„ç‚¼é‡‘æœ¯ç‰©å“ï¼Ÿâ€â€œç«ç„°æ¯çš„é€‰æ‹©æœºåˆ¶åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿâ€å¦ä¸€ä¸ªå¥³ç”Ÿæ€¥åˆ‡åœ°é—®ï¼Œâ€œå®ƒçš„è¾¨è¯†æ ¸å¿ƒæ˜¯åŸºäºæ„æ„¿å¼ºåº¦ï¼Œè¿˜æ˜¯å•çº¯çš„é­”æ³•ç­¾åï¼Ÿä½ çš„åå­—è¢«é€‰ä¸­ï¼Œæ˜¯å¦æ„å‘³ç€æŠ•å…¥å¤šä¸ªåå­—ä¼šå¹²æ‰°å®ƒçš„åˆ¤æ–­é€»è¾‘ï¼Ÿâ€\nä»–ä»¬çš„é—®é¢˜ä¸€ä¸ªæ¥ä¸€ä¸ªï¼Œä»¿ä½›ä½ ä¸æ˜¯å»å‚åŠ ä¸€åœºå±é™©çš„æ¯”èµ›ï¼Œè€Œæ˜¯åˆšåˆšæ”»å…‹äº†ä¸€é“æ‚¬èµå¤šå¹´çš„å­¦æœ¯éš¾é¢˜ã€‚ä½ è¢«è¿™è‚¡æ±‚çŸ¥æ¬²çš„æµªæ½®æ·¹æ²¡ï¼Œç™¾å£è«è¾©ã€‚\nå°±åœ¨è¿™æ—¶ï¼Œäººç¾¤å¤–ä¼ æ¥ä¸€ä¸ªå¸¦ç€æ­‰æ„çš„å£°éŸ³ï¼šâ€œé‚£ä¸ªâ€¦â€¦å„ä½ï¼Œè¯·è®©æˆ‘è¿›å»ä¸€ä¸‹ã€‚â€\nä¸€ä¸ªé«˜å¹´çº§çš„å­¦ç”ŸæŒ¤äº†è¿›æ¥ï¼Œä»–è„¸è‰²è‹ç™½ï¼Œçœ‹ä¸Šå»æ¯”ä½ è¿˜è¦ç´§å¼ ã€‚ä»–èµ°åˆ°ä½ é¢å‰ï¼Œæ·±æ·±åœ°é äº†ä¸€èº¬ï¼šâ€œå¯¹ä¸èµ·ï¼çœŸçš„éå¸¸å¯¹ä¸èµ·ï¼é‚£æ˜¯æˆ‘å¹²çš„ï¼â€\nåœ¨ä¼—äººæƒŠè®¶çš„ç›®å…‰ä¸­ï¼Œä»–ç»“ç»“å·´å·´åœ°è§£é‡Šé“ï¼šâ€œæˆ‘åªæ˜¯æƒ³ç ”ç©¶ç«ç„°æ¯çš„å“åº”æœºåˆ¶å’Œæ··æ·†å’’çš„è¾¹ç•Œæ•ˆåº”â€¦â€¦æˆ‘å¾€é‡Œé¢æŠ•äº†åå‡ ä¸ªéšæœºçš„åå­—åšæ ·æœ¬â€¦â€¦æˆ‘å‘èª“æˆ‘æ²¡æƒ³åˆ°çœŸçš„ä¼šé€‰ä¸­ä¸€ä¸ªï¼æˆ‘â€¦â€¦æˆ‘æ„¿æ„å‘é‚“å¸ƒåˆ©å¤šæ•™æˆè§£é‡Šä¸€åˆ‡ï¼â€ä½ çœ‹ç€çœ¼å‰è¿™ä¸ªå‡ ä¹è¦å“­å‡ºæ¥çš„â€œç½ªé­ç¥¸é¦–â€ï¼Œä¸€æ—¶é—´ç«Ÿä¸çŸ¥é“æ˜¯è¯¥ç”Ÿæ°”è¿˜æ˜¯è¯¥è§‰å¾—è’è°¬ã€‚åŸæ¥ï¼Œä½ ä¹‹æ‰€ä»¥èº«é™·å›¹åœ„ï¼Œç«ŸçœŸçš„æ˜¯å› ä¸ºä¸€åœºè¯¥æ­»çš„å­¦æœ¯å®éªŒã€‚',
                    hufflepuff: 'ä½ å¤´ç–¼åœ°å¬ç€ä¸»åŠæ–¹ä»¬çš„äº‰è®ºï¼Œå½“é‚“å¸ƒåˆ©å¤šæœ€ç»ˆå®£å¸ƒï¼Œè¿«äºé­”æ³•å¥‘çº¦ï¼Œä½ å’Œå“ˆåˆ©ä¹Ÿå¿…é¡»å‚èµ›æ—¶ï¼Œä½ æ„Ÿåˆ°ä¸€é˜µçœ©æ™•ã€‚\nç„¶è€Œï¼Œå½“ä½ æ‹–ç€æ²‰é‡çš„æ­¥ä¼ï¼Œå’Œå¡å¾·é‡Œå…‹Â·è¿ªæˆˆé‡Œä¸€èµ·å›åˆ°èµ«å¥‡å¸•å¥‡çš„å…¬å…±ä¼‘æ¯å®¤æ—¶ï¼Œæ‰€æœ‰çš„ä¸å®‰å’Œç„¦è™‘éƒ½è¢«ä¸€è‚¡æ¸©æš–çš„æµªæ½®æ‰€åæ²¡ã€‚\né€šå¾€ä¼‘æ¯å®¤çš„æœ¨æ¡¶é€šé“é‡Œå°±å·²ç»ä¼ å‡ºäº†æ¬¢å¿«çš„å£°éŸ³ï¼Œä½ ä»¬ä¸€è¿›å»ï¼Œç«‹åˆ»è¢«å¿«ä¹çš„é»„è‰²ä¸é»‘è‰²æ‰€åŒ…å›´ã€‚åŒå­¦ä»¬ä¸¾ç€å¡å¾·é‡Œå…‹å’Œä½ åå­—çš„æ¨ªå¹…ï¼Œçƒ­æƒ…åœ°æ‹¥æŠ±ä½ ä»¬ï¼Œå°†ä½ ä»¬ä¿©é«˜é«˜åœ°ä¸¾åˆ°ç©ºä¸­æŠ›èµ·æ¥ã€‚â€œæˆ‘ä»¬æœ‰ä¸¤ä¸ªå‹‡å£«ï¼èµ«å¥‡å¸•å¥‡æœ‰ä¸¤ä¸ªå‹‡å£«ï¼â€ä»–ä»¬æ¬¢å‘¼ç€ï¼Œå…´å¥‹å¾—æ»¡è„¸é€šçº¢ã€‚\nå¨æˆ¿é‡Œçš„å®¶å…»å°ç²¾çµä»¬é€æ¥äº†å †ç§¯å¦‚å±±çš„è›‹ç³•ã€é¦…é¥¼å’Œå—ç“œæ±ï¼Œæ•´ä¸ªä¼‘æ¯å®¤å˜æˆäº†ä¸€åœºç››å¤§çš„æ´¾å¯¹ã€‚å¡å¾·é‡Œå…‹çœ‹ä¸Šå»ä¹Ÿä¸ºä½ æ„Ÿåˆ°é«˜å…´ï¼Œä»–æ‹ç€ä½ çš„è‚©è†€è¯´ï¼šâ€œçœŸæ²¡æƒ³åˆ°ï¼ä½†å¤ªæ£’äº†ï¼Œä¸æ˜¯å—ï¼Ÿæˆ‘ä»¬ä¸€èµ·ä¸ºèµ«å¥‡å¸•å¥‡äº‰å…‰ï¼â€\nå½“ç„¶ï¼Œä¹Ÿæœ‰å‡ ä¸ªåŒå­¦å‡‘åˆ°ä½ èº«è¾¹ï¼Œå¥½å¥‡åœ°å°å£°é—®ï¼šâ€œè¯´çœŸçš„ï¼Œä½ æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿä½ çœ‹èµ·æ¥ä¸åƒä¼šç”¨é»‘é­”æ³•ä½œå¼Šçš„æ ·å­å•Šâ€¦â€¦â€ä½†ä»–ä»¬è¯è¿˜æ²¡è¯´å®Œï¼Œæ—è¾¹ç«‹åˆ»å°±æœ‰äººç”¨èƒ³è†Šè‚˜æ…äº†ä»–ä»¬ä¸€ä¸‹ï¼Œæˆ–è€…æ‹äº†æ‹ä»–ä»¬çš„åè„‘å‹ºï¼Œä½å£°æ–¥è´£é“ï¼šâ€œå˜¿ï¼åˆ«é—®è¿™ä¸ªï¼ä¸ç®¡æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Œä»–ä»¬ç°åœ¨éƒ½æ˜¯æˆ‘ä»¬çš„å‹‡å£«ï¼Œæˆ‘ä»¬æ”¯æŒå°±å¯¹äº†ï¼â€é‚£ç§æ— æ¡ä»¶çš„æ¥çº³å’Œä¿¡ä»»è®©ä½ æ·±å—æ„ŸåŠ¨ã€‚\nåœ¨è¿™ç‰‡æ¬¢ä¹çš„æµ·æ´‹ä¸­ï¼Œä¸€ä¸ªå¹³æ—¥é‡Œå…³ç³»ä¸é”™çš„æœ‹å‹å‡‘åˆ°ä½ è€³è¾¹ï¼Œåˆ†äº«äº†ä¸€ä¸ªå°ç§˜å¯†ï¼šâ€œæ‚„æ‚„å‘Šè¯‰ä½ ï¼Œæˆ‘å‰å‡ å¤©çœ‹åˆ°ä¸€ä¸ªæ‹‰æ–‡å…‹åŠ³çš„å­¦é•¿ï¼Œåœ¨ç«ç„°æ¯å‰é¢ç¥ç¥å¨å¨çš„ï¼Œå¾€é‡Œé¢æ‰”äº†ä¸€å¤§æŠŠçº¸æ¡ï¼Œçœ‹ä¸Šå»çœŸåƒæ˜¯åœ¨åšä»€ä¹ˆç¥ˆç¦ä»ªå¼ã€‚è¯´ä¸å®šï¼Œä½ å°±æ˜¯ä»–ç»™èµ«å¥‡å¸•å¥‡ç¥ˆæ¥çš„å¥½è¿ï¼â€è¿™ç•ªè¯è®©ä½ å“­ç¬‘ä¸å¾—ï¼Œä½†å¿ƒä¸­æœ€åçš„ä¸€ä¸é˜´éœ¾ï¼Œä¹Ÿåœ¨è¿™æ¸©æš–å‹å¥½çš„æ°›å›´ä¸­æ‚„ç„¶æ•£å»äº†ã€‚'
                },
                twt_chap3: 'æˆä¸ºå‹‡å£«æ‰€å¸¦æ¥çš„çŸ­æš‚â€œè£è€€â€æ„Ÿå¾ˆå¿«ä¾¿è¢«ç°å®çš„æ®‹é…·æ‰€å†²æ·¡ã€‚åœ¨é‚£ä¸ªå¯’å†·çš„å¤œæ™šï¼Œæµ·æ ¼å°†ä½ å’Œå“ˆåˆ©æ‚„æ‚„å¸¦åˆ°ç¦æ—è¾¹ç¼˜ï¼Œä½ äº²çœ¼ç›®ç¹äº†ç¬¬ä¸€ä¸ªé¡¹ç›®çš„å†…å®¹â€”â€”ç«é¾™ã€‚é‚£æ˜¯çº¯ç²¹çš„ã€æ¥è‡ªè¿œå¤çš„ææƒ§ã€‚äº”å¤´ä½“å‹åºå¤§ã€è„¾æ°”æš´èºçš„æˆå¹´ç«é¾™è¢«å…³åœ¨ä¸´æ—¶çš„å›´æ é‡Œï¼Œæ¯ä¸€æ¬¡å‘¼å¸éƒ½å–·å‡ºè‡´å‘½çš„çƒˆç„°ï¼Œè¶³ä»¥å°†å²©çŸ³èåŒ–ã€‚å®ƒä»¬å˜¶å¼ç€ï¼Œæ‰‡åŠ¨ç€å·¨å¤§çš„ç¿…è†€ï¼Œå®ˆæŠ¤ç€ä¸€çªé‡‘è‰²çš„è›‹ï¼Œè€Œä½ çš„ä»»åŠ¡ï¼Œå°±æ˜¯åœ¨å…¨åœºçš„æ³¨è§†ä¸‹ï¼Œä»è¿™æ ·ä¸€å¤´æš´æ€’çš„å·¨å…½çˆªä¸‹ï¼Œå–èµ°å…¶ä¸­ä¸€é¢—ã€‚',
                twt_chap4: 'æ¯”èµ›çš„å·è§’ç»ˆäºåœ¨éœæ ¼æ²ƒèŒ¨ä¸Šç©ºå¹å“ï¼Œé‚£å£°éŸ³ä»¿ä½›æ˜¯å¯¹å³å°†è¸å…¥æˆ˜åœºçš„å‹‡å£«çš„å‚¬å‘½ç¬¦ã€‚ä½ ç«™åœ¨é€šå¾€é¾™ç©´çš„å¸ç¯·é‡Œï¼Œèƒ½æ¸…æ™°åœ°å¬åˆ°å¤–é¢å±±å‘¼æµ·å•¸èˆ¬çš„æ¬¢å‘¼å’Œå¢å¤šÂ·å·´æ ¼æ›¼ç”¨é­”æ³•æ”¾å¤§çš„ã€è¿‡åˆ†æ¿€åŠ¨çš„è§£è¯´å£°ã€‚\nåœ¨æ­¤ä¹‹å‰ï¼Œä½ æˆ–è®¸å·²ç»åºŸå¯å¿˜é£Ÿåœ°æŸ¥é˜…äº†æ— æ•°å…³äºé¾™çš„èµ„æ–™ï¼Œå‘æ•™æˆæˆ–æœ‹å‹è¯·æ•™ï¼Œç»ƒä¹ äº†ä¸Šç™¾éä½ è®¤ä¸ºå¯èƒ½å¥æ•ˆçš„å’’è¯­ã€‚ä½†å½“å¸ç¯·çš„é—¨å¸˜è¢«å·¥ä½œäººå‘˜æ— æƒ…åœ°æ‹‰å¼€ï¼Œåˆºçœ¼çš„é˜³å…‰å’Œæ•°åƒé“ç›®å…‰åŒæ—¶èšç„¦åœ¨ä½ èº«ä¸Šæ—¶ï¼Œæ‰€æœ‰çš„å‡†å¤‡ä¼¼ä¹éƒ½åœ¨ä¸€ç¬é—´è¢«æŠ½ç©ºã€‚\nâ€‹ä½ è¿ˆç€åƒµç¡¬çš„æ­¥ä¼èµ°è¿›èµ›åœºï¼Œè„šä¸‹çš„çŸ³å­åœ°è¢«æ­£åˆçš„å¤ªé˜³æ™’å¾—æ»šçƒ«ã€‚åœ¨åœºåœ°çš„å¦ä¸€ç«¯ï¼Œä½ çš„å¯¹æ‰‹â€”â€”é‚£å¤´æ¥è‡ªå–€å°”å·´é˜¡å±±è„‰çš„ç½—é©¬å°¼äºšè§’é¾™ï¼Œæ­£ç›˜è¸åœ¨ä¸€çªé‡‘è›‹ä¹‹ä¸Šã€‚å®ƒçš„èº«èº¯æ¯”ä½ æƒ³è±¡çš„è¿˜è¦åºå¤§ï¼Œé»‘ç»¿è‰²çš„é³ç‰‡åœ¨é˜³å…‰ä¸‹æŠ˜å°„å‡ºé‡‘å±èˆ¬å†·ç¡¬çš„å…‰æ³½ï¼Œå®›å¦‚è¦†ç›–ç€ä¸€å±‚å¤è€çš„é’é“œç›”ç”²ã€‚ç„¶è€Œï¼Œæœ€ä»¤äººå¿ƒæ‚¸çš„ï¼Œæ˜¯å®ƒå¤´é¡¶ä¸Šé‚£å¯¹å¼•ä»¥ä¸ºå‚²çš„é•¿çŠ„è§’ã€‚é‚£å¯¹çŠ„è§’é•¿è€Œä¼˜ç¾ï¼Œå‘ˆç°å‡ºä¸€ç§ç‚«ç›®çš„é‡‘è‰²ï¼Œä»¿ä½›ç”±çº¯é‡‘é“¸é€ è€Œæˆï¼Œåœ¨é˜³å…‰ä¸‹é‡‘å…‰é—ªçƒã€‚\nâ€‹å®ƒæ„Ÿå—åˆ°äº†ä½ çš„é—¯å…¥ï¼Œå·¨å¤§çš„å¤´é¢…ç¼“ç¼“è½¬å‘ä½ ï¼Œç¥ç€è‰²çš„ç«–ç³é‡Œå…¨ç„¶æ˜¯å®¡è§†å’Œæ•Œæ„ã€‚å®ƒè½»è½»åœ°ç”¨é‚£å¯¹åä¸½çš„é•¿è§’æ‘©æ“¦äº†ä¸€ä¸‹åœ°é¢ï¼Œåšç¡¬çš„å²©çŸ³ç«‹åˆ»è¢«åˆ’å‡ºæ·±æ·±çš„æ²Ÿå£‘ï¼Œå¹¶å‘å‡ºäº†åˆºè€³çš„å£°å“â€”â€”ä½ åœ¨ä¹¦ä¸Šè¯»åˆ°è¿‡ï¼Œè¿™æ˜¯å®ƒçš„æ•çŒä¹ æƒ¯ï¼Œå…ˆç”¨çŠ„è§’å°†çŒç‰©æŠµæ­»ã€æ’•è£‚ï¼Œç„¶åå†ç”¨é¾™ç„°å°†å…¶çƒ¤ç†Ÿäº«ç”¨ã€‚ä¸€ç¼•ç°çƒŸä»å®ƒå¸ƒæ»¡åˆ©é½¿çš„å£é¼»é—´å–·å‡ºï¼Œå¸¦ç€ç¡«ç£ºå’Œç„¦ç‚­çš„æ°”å‘³ï¼Œå°†ä½ é¢å‰çš„ç©ºæ°”ç¼çƒ§å¾—å¾®å¾®æ‰­æ›²ã€‚è§‚ä¼—çš„å–§å“—å£°ä»¿ä½›è¿œåœ¨å¤©è¾¹ï¼Œæ­¤åˆ»ï¼Œä½ çš„ä¸–ç•Œé‡Œåªå‰©ä¸‹ä½ å’Œè¿™å¤´æ²‰é»˜è€Œè‡´å‘½çš„å·¨å…½ã€‚å®ƒåœ¨ç­‰ä½ ï¼Œç­‰ä½ è¸å…¥å®ƒé‚£å¯¹é»„é‡‘é•¿è§’çš„æ”»å‡»èŒƒå›´ã€‚æ²¡æœ‰é€€è·¯ï¼Œæ²¡æœ‰æ´åŠ©ï¼Œåªæœ‰ä½ å’Œä½ æ‰‹ä¸­çš„é­”æ–ã€‚æ·±å‘¼å¸ï¼Œç¨³ä½é¢¤æŠ–çš„æ‰‹ï¼Œè¿™åœºç”Ÿæ­»å¯¹å†³ï¼Œç°åœ¨å¼€å§‹ã€‚',
                twt_chap5: 'ç¬¬ä¸€ä¸ªé¡¹ç›®çš„æƒŠå¿ƒåŠ¨é­„å°šæœªå®Œå…¨å¹³æ¯ï¼Œä¸€ä¸ªå…¨æ–°çš„ã€æˆªç„¶ä¸åŒçš„æŒ‘æˆ˜æ‚„ç„¶è€Œè‡³â€”â€”åœ£è¯èˆä¼šã€‚è¿™æ˜¯ä¸‰å¼ºäº‰éœ¸èµ›çš„ä¼ ç»Ÿç¯èŠ‚ï¼Œæ—¨åœ¨ä¿ƒè¿›å›½é™…é—´çš„å‹è°Šã€‚å¯¹äºå¤§å¤šæ•°å­¦ç”Ÿæ¥è¯´ï¼Œè¿™æ˜¯ä¸€åœºå……æ»¡æœŸå¾…çš„ç››å¤§æ´¾å¯¹ï¼›ä½†å¯¹äºä½ â€”â€”éœæ ¼æ²ƒèŒ¨çš„ç¬¬äº”ä½ï¼Œä¹Ÿæ˜¯æœ€å‡ºäººæ„æ–™çš„å‹‡å£«â€”â€”è¿™æ„å‘³ç€ä½ å¿…é¡»æ‰¾åˆ°ä¸€ä½èˆä¼´ï¼Œå¹¶ä½œä¸ºå¼€åœºèˆçš„å¼•é¢†è€…ä¹‹ä¸€ï¼Œæ¥å—æ‰€æœ‰äººçš„ç©ç›®ã€‚ä¸€æ—¶é—´ï¼Œå¯»æ‰¾èˆä¼´æˆäº†åŸå ¡é‡Œæœ€çƒ­é—¨çš„è¯é¢˜ã€‚èµ°å»Šé‡Œã€è¯¾å ‚ä¸Šã€å…¬å…±ä¼‘æ¯å®¤é‡Œï¼Œåˆ°å¤„éƒ½æ˜¯å…³äºé‚€è¯·ä¸è¢«é‚€çš„çªƒçªƒç§è¯­ã€‚ä½ å‘ç°è‡ªå·±å†æ¬¡è¢«æ¨åˆ°äº†èšå…‰ç¯ä¸‹ï¼Œä¸€äº›äººå› ä¸ºä½ çš„â€œå‹‡å£«â€èº«ä»½è€ŒæŠ•æ¥å¥½å¥‡æˆ–å€¾æ…•çš„ç›®å…‰ï¼Œå¦ä¸€äº›äººåˆ™ä¾æ—§æŠ±ç€çœ‹çƒ­é—¹çš„å¿ƒæ€ã€‚ä½ éœ€è¦åœ¨äººç¾¤ä¸­åšå‡ºé€‰æ‹©ï¼Œæ˜¯é‚€è¯·ä½ å¿ƒä»ªå·²ä¹…çš„äººï¼Œè¿˜æ˜¯å‡ºäºç¤¼èŠ‚é€‰æ‹©ä¸€ä½æœ‹å‹ï¼Ÿä¸æ­¤åŒæ—¶ï¼Œä½ è¿˜éœ€è¦ä¸ºè‡ªå·±å‡†å¤‡ä¸€å¥—å¾—ä½“çš„ç¤¼æœã€‚è¿™æ„å‘³ç€è¦å»éœæ ¼è«å¾·æ‘çš„å•†åº—ç²¾å¿ƒæŒ‘é€‰ï¼Œæˆ–æ˜¯æ‹œæ‰˜å®¶äººä»å®¶é‡Œå¯„æ¥ã€‚åœ¨è¿™æ®µçœ‹ä¼¼è½»æ¾æ„‰å¿«çš„æ—¶å…‰é‡Œï¼Œä½ æš‚æ—¶ä»è‡´å‘½çš„æ¯”èµ›ä¸­æŠ½èº«ï¼Œå´é™·å…¥äº†å¦ä¸€ç§å±äºé’æ˜¥æœŸçš„ã€ç”œèœœåˆçƒ¦æ¼çš„ç¤¾äº¤å›°å¢ƒä¹‹ä¸­ã€‚',
                twt_chap6: 'åœ£è¯èˆä¼šå½“æ™šï¼Œéœæ ¼æ²ƒèŒ¨å¤§ç¤¼å ‚è¢«è£…ç‚¹å¾—å¦‚åŒä¸€ä¸ªä»™å¢ƒã€‚å¤©èŠ±æ¿ä¸Šæ´’ä¸‹æ™¶è¹çš„é›ªèŠ±ï¼Œå´ä¸ä¼šè®©äººæ„Ÿåˆ°å¯’å†·ã€‚å¢™å£ä¸ŠæŒ‚ç€é—ªé—ªå‘å…‰çš„é“¶è‰²å½©å¸¦ï¼Œå·¨å¤§çš„åœ£è¯æ ‘ä¸Šè£…é¥°ç€æ´»ç”Ÿç”Ÿçš„ä»™å­ã€‚ä½ ç©¿ç€ç²¾å¿ƒå‡†å¤‡çš„ç¤¼æœï¼Œä¸ä½ çš„èˆä¼´ä¸€èµ·ï¼Œå’Œå…¶ä»–ä¸‰ä½å‹‡å£«åŠä»–ä»¬çš„èˆä¼´ç«™åœ¨å¤§ç¤¼å ‚çš„é—¨å‰ï¼Œç­‰å¾…ç€å…¥åœºã€‚éŸ³ä¹å“èµ·ï¼Œå½“æ²‰é‡çš„æ©¡æœ¨é—¨ç¼“ç¼“æ‰“å¼€ï¼Œä½ è¸å…¥é‚£ç‰‡ç’€ç’¨çš„ç¯æµ·æ—¶ï¼Œæ‰€æœ‰äººçš„ç›®å…‰éƒ½é›†ä¸­åœ¨ä½ ä»¬èº«ä¸Šã€‚ä½œä¸ºå‹‡å£«ï¼Œä½ å¿…é¡»å¼•é¢†å¼€åœºèˆã€‚åœ¨æ‚ æ‰¬çš„åå°”å…¹èˆæ›²ä¸­ï¼Œä½ å’Œèˆä¼´æ»‘å…¥èˆæ± ä¸­å¤®ï¼Œæ¯ä¸€ä¸ªèˆæ­¥éƒ½æš´éœ²åœ¨ä¼—ç›®ç½ç½ä¹‹ä¸‹ã€‚è¿™ä¸€åˆ»ï¼Œæ²¡æœ‰ç«é¾™ï¼Œæ²¡æœ‰æ¶å’’ï¼Œåªæœ‰æ—‹è½¬çš„èˆæ­¥ã€é—ªçƒçš„ç¯å…‰å’Œèº«è¾¹é‚£ä¸ªäººçš„å¾®ç¬‘ã€‚èˆä¼šçš„æ°”æ°›çƒ­çƒˆè€Œæ¬¢å¿«ï¼Œæ€ªå§å¦¹ä¹é˜Ÿçš„æ‘‡æ»šä¹ç‚¹ç‡ƒäº†å…¨åœºçš„çƒ­æƒ…ã€‚è¿™æ˜¯ä¸€ä¸ªå¯ä»¥æš‚æ—¶å¿˜è®°æ¯”èµ›å‹åŠ›çš„å¤œæ™šï¼Œä½ å¯ä»¥ä¸æœ‹å‹ä»¬å°½æƒ…æ¬¢ç¬‘ï¼Œäº«å—ç¾é£Ÿï¼Œç”šè‡³åœ¨æŸä¸ªå®‰é™çš„è§’è½ï¼Œä¸ä½ çš„èˆä¼´åˆ†äº«ä¸€äº›åªå±äºä½ ä»¬çš„ç§˜å¯†ã€‚è¿™æ˜¯é£æš´æ¥ä¸´å‰ï¼Œéš¾å¾—çš„å¹³é™ä¸ç¾å¥½ã€‚',
                twt_chap7: 'ç¬¬äºŒä¸ªé¡¹ç›®çš„ç¥ç§˜é¢çº±ç»ˆäºæ­æ™“ï¼Œé‚£é¢—ä»ç«é¾™çˆªä¸‹å¤ºæ¥çš„é‡‘è›‹åœ¨æ°´ä¸­å‘å‡ºäº†å‡„å‰è€Œæ¸…æ™°çš„æ­Œå£°ï¼ŒæŒ‡å¼•ç€ä½ ä»¬å‰å¾€é»‘æ¹–çš„æ·±å¤„ã€‚ä»»åŠ¡æ˜¯ï¼šåœ¨ä¸€ä¸ªå°æ—¶å†…ï¼Œä»æ¹–åº•æ•‘å‡ºä½ â€œæœ€çè§†çš„å®ç‰©â€ã€‚\nå½“ä½ å¾—çŸ¥æ‰€è°“çš„â€œå®ç‰©â€å…¶å®æ˜¯ä½ æœ€äº²è¿‘çš„æœ‹å‹æˆ–å®¶äººæ—¶ï¼Œæ¯”èµ›çš„æ€§è´¨ç¬é—´æ”¹å˜äº†ã€‚è¿™ä¸å†æ˜¯å•çº¯ä¸ºäº†è£èª‰ï¼Œè€Œæ˜¯ä¸ºäº†æ‹¯æ•‘ä½ æ‰€çˆ±çš„äººã€‚\nå†°å†·åˆºéª¨çš„æ¹–æ°´åœ¨äºŒæœˆçš„å¯’é£ä¸­ç¿»æ¶Œç€é»‘è‰²çš„æ³¢æµªï¼Œæ¹–åº•æ½œè—ç€æœªçŸ¥çš„å±é™©â€”â€”æ ¼æ—è¿ªæ´›ã€æ°´æ€ªï¼Œä»¥åŠé»˜ç„¶æ³¨è§†ç€ä¸€åˆ‡çš„äººé±¼éƒ¨è½ã€‚\nä½ å¿…é¡»æ‰¾åˆ°ä¸€ç§æ–¹æ³•ï¼Œè®©ä½ è¿™ä¸ªä¹ æƒ¯äº†é™†åœ°ç”Ÿæ´»çš„å·«å¸ˆï¼Œèƒ½å¤Ÿåœ¨æ°´ä¸‹å‘¼å¸å’Œæ´»åŠ¨é•¿è¾¾ä¸€ä¸ªå°æ—¶ã€‚æ—¶é—´ç´§è¿«ï¼Œæ¯ä¸€ä¸ªå†³å®šéƒ½è‡³å…³é‡è¦ã€‚\nåŠ æ²¹å§ï¼Œæˆ‘çš„å‹‡å£«ï¼Œæ—¶é—´æ‹¨å›åˆ°æ¯”èµ›å¼€å§‹çš„å‰ä¸€å‘¨ï¼Œä½ çš„å‡†å¤‡æ—¶é—´å´å·²ä¸ç®—å……è£•ã€‚',
                twt_chap8: 'ç»å†äº†ç«é¾™çš„å’†å“®ä¸é»‘æ¹–çš„æ²‰å¯‚ï¼Œä¸‰å¼ºäº‰éœ¸èµ›ç»ˆäºè¿æ¥äº†æœ€åä¸€ä¸ªï¼Œä¹Ÿæ˜¯æœ€è‰°é™©çš„é¡¹ç›®â€”â€”è¿·å®«ã€‚åœ¨é­åœ°å¥‡çƒåœºä¸Šï¼Œé«˜è€¸çš„æ ‘ç¯±ä¸€å¤œä¹‹é—´æ‹”åœ°è€Œèµ·ï¼Œæ„æˆäº†ä¸€åº§å·¨å¤§è€Œå¤æ‚çš„è¿·å®«ã€‚å®ƒçš„å†…éƒ¨å˜å¹»è«æµ‹ï¼Œå……æ»¡äº†å„ç§é­”æ³•éšœç¢ã€ç¥å¥‡ç”Ÿç‰©å’Œè¿·æƒ‘äººå¿ƒçš„é™·é˜±ã€‚é‚“å¸ƒåˆ©å¤šä¸¥è‚ƒåœ°è­¦å‘Šä½ ä»¬ï¼Œè¿·å®«ä¼šæ”¹å˜è¿›å…¥å…¶ä¸­çš„äººã€‚ä½ ä»¬å°†æ ¹æ®å‰ä¸¤ä¸ªé¡¹ç›®çš„å¾—åˆ†ä¾æ¬¡è¿›å…¥ã€‚\nç›®æ ‡åªæœ‰ä¸€ä¸ªï¼šç©¿è¿‡é‡é‡é™©é˜»ï¼Œæœ€å…ˆè§¦æ‘¸åˆ°ä½äºè¿·å®«ä¸­å¿ƒçš„ä¸‰å¼ºæ¯ã€‚å½“ä½ è¸å…¥é‚£æ¡è¢«é˜´å½±ç¬¼ç½©çš„ç‹­çª„é€šé“ï¼Œèº«åçš„å…¥å£ç¼“ç¼“å…³é—­æ—¶ï¼Œä¸–ç•Œç¬é—´å®‰é™ä¸‹æ¥ï¼Œåªå‰©ä¸‹ä½ è‡ªå·±çš„å¿ƒè·³å’Œé£å¹è¿‡æ ‘ç¯±çš„æ²™æ²™å£°ã€‚ä½ å°†ç‹¬è‡ªé¢å¯¹æœªçŸ¥çš„ææƒ§ï¼šä¼šå–·ç«çš„ç‚¸å°¾èºã€é¢ å€’ä½ æ–¹å‘çš„é­”æ³•è¿·é›¾ï¼Œä»¥åŠå¯èƒ½æ¯”ä»»ä½•æ€ªç‰©éƒ½æ›´å±é™©çš„â€”â€”å…¶ä»–åŒæ ·æ¸´æœ›èƒœåˆ©çš„ç«äº‰è€…ã€‚',
                twt_chap9: 'ä½ å‡ ä¹ä¸æ•¢ç›¸ä¿¡è‡ªå·±çš„å¥½è¿ï¼Œè¿™ä¸€è·¯ä¸Šå‡ºä¹æ„æ–™åœ°æ²¡æœ‰é‡åˆ°ä»€ä¹ˆè¿‡åˆ†çš„é˜»ç¢ï¼Œä¸‰å¼ºæ¯å°±åœ¨ä½ çš„çœ¼å‰ï¼Œé—ªè€€ç€èƒœåˆ©çš„å…‰èŠ’ã€‚å“ˆåˆ©Â·æ³¢ç‰¹å‡ ä¹åœ¨åŒä¸€æ—¶é—´ä¹Ÿèµ¶åˆ°äº†è¿™é‡Œã€‚æˆ–è®¸æ˜¯å‡ºäºä¸€è·¯èµ°æ¥çš„æƒºæƒºç›¸æƒœï¼Œä½ ä»¬å†³å®šä¸€åŒä¸¾èµ·å¥–æ¯ï¼Œå…±äº«è¿™ä»½å±äºéœæ ¼æ²ƒèŒ¨çš„è£è€€ã€‚\nç„¶è€Œï¼Œå½“ä½ å’Œå“ˆåˆ©çš„æ‰‹æŒ‡è§¦ç¢°åˆ°å†°å†·çš„æ¯æŸ„æ—¶ï¼Œä½ æ„Ÿå—åˆ°çš„å¹¶éèƒœåˆ©çš„å–œæ‚¦ï¼Œè€Œæ˜¯ä¸€é˜µå‰§çƒˆçš„ã€ä»¤äººä½œå‘•çš„æ‹‰æ‰¯æ„Ÿã€‚å‘¨å›´çš„æ™¯è‰²ç¬é—´æ‰­æ›²ã€æ—‹è½¬ï¼Œä½ è¢«ä¸€è‚¡æ— æ³•æŠ—æ‹’çš„åŠ›é‡å¸¦ç¦»äº†éœæ ¼æ²ƒèŒ¨ã€‚åŒè„šé‡é‡åœ°è½åœ¨ä¸€ç‰‡é˜´å†·æ½®æ¹¿çš„åœŸåœ°ä¸Šï¼Œä½ å‘ç°è‡ªå·±èº«å¤„ä¸€ä¸ªè’å‡‰çš„å¢“åœ°ï¼Œå››å‘¨å¼¥æ¼«ç€æ­»äº¡çš„æ°”æ¯ã€‚ä¸€ä¸ªä¸‘é™‹çŸ®å°çš„èº«å½±ï¼Œæ­£æŠ±ç€ä¸€å›¢è™šå¼±è€Œé‚ªæ¶çš„ä¸œè¥¿ï¼Œç«™åœ¨ä¸€åº§å·¨å¤§çš„æ²¸è…¾å©åŸšæ—ã€‚\nå“ˆåˆ©é¢å¤´ä¸Šçš„ä¼¤ç–¤ä¼ æ¥å‰§ç—›ï¼Œä»–ç—›è‹¦åœ°å€’åœ¨åœ°ä¸Šã€‚ä½ ç«‹åˆ»æ„è¯†åˆ°ï¼Œè¿™ä¸æ˜¯æ¯”èµ›çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ˜¯ä¸€ä¸ªç²¾å¿ƒç­–åˆ’çš„é™·é˜±ã€‚ä¸‰å¼ºæ¯æ˜¯ä¸€ä¸ªé—¨é’¥åŒ™ï¼Œå¤§éš¾ä¸æ­»çš„ç”·å­©æ˜¯æœ€åçš„ç¥­å“ã€‚è€Œä½ â€”â€”æˆ–è®¸åªæ˜¯ä¸€ä¸ªç¢äº‹çš„å®¶ä¼™ã€‚'
            };
            const chapters = [
                { id: 'twt_chap1', name: 'ä¸€ï¼šå‹‡å£«é€‰æ‹”', intro: intros.twt_chap1, savedSlots: [], mainSaveSlotIndex: -1 },
                { id: 'twt_chap2', name: 'äºŒï¼šä¼‘æ¯å®¤çš„å¤œæ™š', intro: intros.twt_chap2[playerHouse], savedSlots: [], mainSaveSlotIndex: -1 },
                { id: 'twt_chap3', name: 'ä¸‰ï¼šå¤œæ¢ç«é¾™', intro: intros.twt_chap3, savedSlots: [], mainSaveSlotIndex: -1 },
                { id: 'twt_chap4', name: 'å››ï¼šæŒ‘æˆ˜ç«é¾™', intro: intros.twt_chap4, savedSlots: [], mainSaveSlotIndex: -1 },
                { id: 'twt_chap5', name: 'äº”ï¼šåœ£è¯èˆä¼šçš„å‰å¥', intro: intros.twt_chap5, savedSlots: [], mainSaveSlotIndex: -1 },
                { id: 'twt_chap6', name: 'å…­ï¼šåœ£è¯èˆä¼šä¹‹å¤œ', intro: intros.twt_chap6, savedSlots: [], mainSaveSlotIndex: -1 },
                { id: 'twt_chap7', name: 'ä¸ƒï¼šæ·±æ¹–çš„è€ƒéªŒ', intro: intros.twt_chap7, savedSlots: [], mainSaveSlotIndex: -1 },
                { id: 'twt_chap8', name: 'å…«ï¼šè¿·å®«çš„ç»ˆç‚¹', intro: intros.twt_chap8, savedSlots: [], mainSaveSlotIndex: -1 },
                { id: 'twt_chap9', name: 'ä¹ï¼šå¢“åœ°çš„å®¿å‘½', intro: intros.twt_chap9, savedSlots: [], mainSaveSlotIndex: -1 },
            ];
            return chapters;
        }
        async function initializeTriwizardChapters(playerHouse) {
            const chapters = generateDefaultTriwizardChapters(playerHouse);
            await db.triwizardChapters.bulkPut(chapters);
            state.triwizardChapters = chapters;
        }
        
        async function bindSetupEvents() { 
            document.getElementById('userHouse').addEventListener('change', (e) => applyHouseTheme(e.target.value)); 
            document.getElementById('startAdventureBtn').addEventListener('click', async () => { 
                const lastName = document.getElementById('userLastName').value.trim(); 
                const firstName = document.getElementById('userFirstName').value.trim(); 
                const userProfile = { 
                    id: 'main',
                    lastName: lastName, 
                    firstName: firstName, 
                    nameFormat: 'chinese', 
                    gender: document.getElementById('userGender').value, 
                    house: document.getElementById('userHouse').value, 
                    blood: document.getElementById('userBlood').value, 
                    age: document.getElementById('userAgeYear').value,
                    wand: { 
                        core: document.getElementById('wandCore').value, 
                        wood: document.getElementById('wandWood').value||'æœªçŸ¥', 
                        length: document.getElementById('wandLength').value||'æœªçŸ¥', 
                        flex: document.getElementById('wandFlex').value||'æœªçŸ¥' 
                    }, 
                    patronus: document.getElementById('userPatronus').value||'æœªçŸ¥', 
                    pet: document.getElementById('userPet').value||'æ— ', 
                    appearance: document.getElementById('userAppearance').value||'æ™®é€š', 
                    personality: document.getElementById('userPersonality').value||'å‹å¥½', 
                    identity: document.getElementById('userIdentity').value||'æœªçŸ¥', 
                    signature: document.getElementById('userSignature').value||'è£è€€æ°¸æ’ï¼', 
                    avatar: null, 
                    fontUrl: null, 
                    fontFamily: null, 
                    customEmojis: {} 
                };
                
                userProfile.name = (userProfile.lastName + userProfile.firstName) || 'æ–°ç”Ÿ';
                
                state.userProfile = userProfile;
                state.appInitialized = true;
                state.currentView = 'messages';
                
                await db.userProfile.put(userProfile);
                await initializeDefaultData(userProfile.house);
                await db.appState.put({ id: 'main', initialized: true, currentView: 'messages' });
                renderApp(true);
            }); 
        }
        
        function addLongPressListener(element, callback) {
            let pressTimer = null;
            let longPressTriggered = false;
            const onTouchStart = (e) => {
                longPressTriggered = false;
                pressTimer = setTimeout(() => {
                    e.preventDefault();
                    callback(e);
                    longPressTriggered = true;
                }, 500);
            };
            const onTouchEnd = (e) => {
                if (pressTimer) clearTimeout(pressTimer);
                if (longPressTriggered) {
                    e.preventDefault(); 
                    e.stopPropagation(); 
                }
            };
            
            const onTouchMove = () => {
                if (pressTimer) clearTimeout(pressTimer);
            };
            const onContextMenu = (e) => {
                e.preventDefault();
                callback(e);
            };
            element.addEventListener('touchstart', onTouchStart, { passive: false });
            element.addEventListener('touchend', onTouchEnd);
            element.addEventListener('touchcancel', onTouchMove);
            element.addEventListener('touchmove', onTouchMove);
            element.addEventListener('contextmenu', onContextMenu);
        }
        function bindMainEvents() { 
            queryDOMElements(); 
            applyHouseTheme(state.userProfile.house); 
            if (state.userProfile.fontUrl || state.userProfile.fontFamily) { 
                applyCustomFont(state.userProfile.fontUrl, state.userProfile.fontFamily); 
            } 
            navItems.forEach(item => item.addEventListener('click', function() { switchView(this.dataset.view); })); 
            document.getElementById('settingsBtn').addEventListener('click', () => switchView('profile')); 
            backButton.addEventListener('click', () => {
                const previous = state.previousView || 'messages';
                if (state.currentView === 'chat' && state.currentChat.isTriwizard) {
                    switchView('triwizard');
                } else {
                    switchView(previous);
                }
            }); 
            switchView(state.currentView || 'messages'); 
            window.addEventListener('click', () => contextMenu.classList.add('hidden'));
        }
        window.bindMessagesEvents = function() {
            document.getElementById('startTriwizardBtn')?.addEventListener('click', () => switchView('triwizard'));
            document.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('click', async function() {
                    const chatId = this.dataset.chatId;
                    const chat = await db.chats.get(chatId);
                    if (chat) {
                        state.currentChat = chat;
                        switchView('chat');
                    } else {
                        state.currentChat = state.chats.find(c => c.id === chatId);
                        if (state.currentChat) switchView('chat');
                    }
                });
                addLongPressListener(item, (e) => {
                    e.preventDefault();
                    const chat = state.chats.find(c => c.id === item.dataset.chatId);
                    const type = chat.isGroup ? 'groupChatItem' : 'chatItem';
                    showContextMenu(e, type, item.dataset.chatId);
                });
            });
        }
        window.bindContactsEvents = function() {
            const tabs = document.querySelectorAll('.tab');
            const contactsContent = document.getElementById('contactsContent');
            
            function updateContactsTabView(activeTab) {
                tabs.forEach(t => t.classList.remove('active'));
                document.querySelector(`.tab[data-tab="${activeTab}"]`).classList.add('active');
                if (activeTab === 'friends') {
                    renderGroupedContacts();
                } else {
                    renderGroupsList();
                }
            }
            
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    updateContactsTabView(e.currentTarget.dataset.tab);
                });
            });
            
            updateContactsTabView('friends');
        }
        function bindFriendsTabEvents() {
            document.getElementById('manageGroupsBtn')?.addEventListener('click', showManageGroupsDialog);
        }
        function bindFriendItemEvents() {
             document.querySelectorAll('.friend-item').forEach(item => { 
                item.addEventListener('click', async function() { 
                    state.activeContactId = this.dataset.contactId; 
                    await updateAppState();
                    const contact = await db.contacts.get(state.activeContactId);
                    showDialog(`<div class="dialog-title">${contact.name}</div><div class="dialog-actions" style="flex-direction: column; gap: 10px;"><button class="dialog-btn" id="dialogStartChat">è¿›å…¥å¯¹è¯</button><button class="dialog-btn" id="dialogEditFriend">å¥½å‹ä»‹ç»</button></div>`); 
                    
                    document.getElementById('dialogStartChat').onclick = async () => { 
                        hideDialog(); 
                        const currentContact = await db.contacts.get(state.activeContactId);
                        let chat = await db.chats.where('contactId').equals(state.activeContactId).first();
                        
                        if (!chat) { 
                            chat = { id: `chat_${Date.now()}`, contactId: currentContact.id, name: currentContact.name, isGroup: false, members: [], lastMessage: 'å¯ä»¥å¼€å§‹èŠå¤©äº†', time: new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'}), messages: [], background: null, isPinned: false, summary: "", isHidden: false, isOfflineMode: false }; 
                            await db.chats.add(chat);
                            state.chats.unshift(chat);
                        } else { 
                            chat.isHidden = false; 
                            await db.chats.put(chat);
                            const existingChatIndex = state.chats.findIndex(m => m.id === chat.id);
                            if(existingChatIndex > -1) state.chats[existingChatIndex].isHidden = false;
                        } 
                        state.currentChat = chat; 
                        switchView('chat'); 
                    }; 
                    document.getElementById('dialogEditFriend').onclick = () => { 
                        hideDialog(); 
                        switchView('editFriend'); 
                    }; 
                });
                addLongPressListener(item, (e) => {
                    e.preventDefault();
                    showContextMenu(e, 'friendItem', item.dataset.contactId);
                });
            }); 
        }
        window.bindProfileEvents = function() {
            if (state.apiConfig.model) {
                const select = document.getElementById('apiModelSelect');
                if(select) {
                    select.innerHTML = `<option value="${state.apiConfig.model}">${state.apiConfig.model}</option>`;
                    select.value = state.apiConfig.model;
                }
            }
            document.getElementById('fetchModelsBtn').addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                btn.innerText = "è·å–ä¸­...";
                btn.disabled = true;
                const tempConfig = { url: document.getElementById('apiUrl').value.trim(), key: document.getElementById('apiKey').value.trim() };
                try {
                    const models = await fetchApiModels(tempConfig);
                    const select = document.getElementById('apiModelSelect');
                    select.innerHTML = '';
                    if (models.length > 0) {
                        models.forEach(modelName => {
                            const option = document.createElement('option');
                            option.value = modelName;
                            option.textContent = modelName;
                            select.appendChild(option);
                        });
                        if (state.apiConfig.model && models.includes(state.apiConfig.model)) {
                            select.value = state.apiConfig.model;
                        }
                        alert(`æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹ï¼`);
                    } else {
                        select.innerHTML = '<option value="">æœªèƒ½è·å–æ¨¡å‹</option>';
                         alert('æœªèƒ½è·å–ä»»ä½•æ¨¡å‹ï¼Œè¯·æ£€æŸ¥APIè®¾ç½®ã€‚');
                    }
                } catch (error) {
                    alert(`è·å–æ¨¡å‹å¤±è´¥: ${error.message}`);
                } finally {
                    btn.innerText = "è·å–æ¨¡å‹";
                    btn.disabled = false;
                }
            });
            document.getElementById('testApiBtn').addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                btn.innerText = "æµ‹è¯•ä¸­...";
                btn.disabled = true;
                const testConfig = { url: document.getElementById('apiUrl').value.trim(), key: document.getElementById('apiKey').value.trim(), model: document.getElementById('apiModelSelect').value };
                try {
                    const result = await callApi("ä½ å¥½", [], testConfig);
                    if (result) {
                        alert("âœ… è¿æ¥æˆåŠŸï¼");
                    } else {
                        alert("âŒ è¿æ¥å¤±è´¥ï¼APIè¿”å›äº†ç©ºå“åº”ï¼Œä½†æ²¡æœ‰æŠ¥é”™ã€‚è¯·æ£€æŸ¥æ¨¡å‹æ˜¯å¦å…¼å®¹ã€‚");
                    }
                } catch (error) {
                    let userFriendlyError = `âŒ è¿æ¥å¤±è´¥ï¼\nåŸå› : ${error.message}\n\n`;
                    if (error instanceof TypeError && error.message.includes("fetch")) {
                         userFriendlyError += "æç¤º: è¿™é€šå¸¸æ˜¯ç½‘ç»œé—®é¢˜æˆ–æµè§ˆå™¨çš„CORSè·¨åŸŸå®‰å…¨ç­–ç•¥å¯¼è‡´çš„ã€‚å¦‚æœæ‚¨æ­£åœ¨å°è¯•è¿æ¥å®˜æ–¹APIï¼ˆå¦‚api.openai.comï¼‰ï¼Œè¿™æ˜¯é¢„æœŸçš„è¡Œä¸ºï¼Œå› ä¸ºå®ƒä»¬ä¸å…è®¸ä»æµè§ˆå™¨ç›´æ¥è°ƒç”¨ã€‚è¯·æ”¹ç”¨æ”¯æŒCORSçš„ä¸­è½¬APIåœ°å€ã€‚";
                    } else {
                         userFriendlyError += "æç¤º: è¯·ä»”ç»†æ£€æŸ¥æ‚¨çš„API URLã€API Keyå’Œæ‰€é€‰çš„æ¨¡å‹åç§°æ˜¯å¦æ­£ç¡®æ— è¯¯ã€‚";
                    }
                    alert(userFriendlyError);
                } finally {
                    btn.innerText = "æµ‹è¯•è¿æ¥";
                    btn.disabled = false;
                }
            });
            
            document.querySelector('.profile-name').addEventListener('click', () => {
                const p = state.userProfile;
                const isChineseChecked = p.nameFormat === 'western' ? '' : 'checked'; 
                const isWesternChecked = p.nameFormat === 'western' ? 'checked' : '';
                const dialogHtml = `
                    <div class="dialog-title">ä¿®æ”¹å§“å</div>
                    <div class="form-group">
                        <label for="dialogLastName">å§“</label>
                        <input type="text" id="dialogLastName" value="${p.lastName || ''}" style="-webkit-user-select: text; user-select: text;">
                    </div>
                    <div class="form-group">
                        <label for="dialogFirstName">å</label>
                        <input type="text" id="dialogFirstName" value="${p.firstName || ''}" style="-webkit-user-select: text; user-select: text;">
                    </div>
                    <div class="form-group">
                        <label>æ˜¾ç¤ºæ ¼å¼</label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label style="display: flex; align-items: center;"><input type="radio" name="nameFormat" value="chinese" ${isChineseChecked} style="width: 20px; height: 20px; margin-right: 8px;"> å§“+å (ä¾‹å¦‚ï¼šå¸ƒè±å…‹å¥¥åˆ©ç»´å¨…)</label>
                            <label style="display: flex; align-items: center;"><input type="radio" name="nameFormat" value="western" ${isWesternChecked} style="width: 20px; height: 20px; margin-right: 8px;"> åÂ·å§“ (ä¾‹å¦‚ï¼šå¥¥åˆ©ç»´å¨…Â·å¸ƒè±å…‹)</label>
                        </div>
                    </div>
                    <div class="dialog-actions">
                        <button class="dialog-btn cancel-btn" id="dialog-name-cancel">å–æ¶ˆ</button>
                        <button class="dialog-btn" id="dialog-name-save">ä¿å­˜</button>
                    </div>
                `;
                showDialog(dialogHtml);
                
                document.getElementById('dialog-name-save').onclick = async () => {
                    const newLastName = document.getElementById('dialogLastName').value.trim();
                    const newFirstName = document.getElementById('dialogFirstName').value.trim();
                    const newFormat = document.querySelector('input[name="nameFormat"]:checked').value;
                    if (!newLastName && !newFirstName) {
                        alert("å§“å’Œåè‡³å°‘éœ€è¦å¡«å†™ä¸€ä¸ªï¼");
                        return;
                    }
                    const profile = state.userProfile;
                    profile.lastName = newLastName;
                    profile.firstName = newFirstName;
                    profile.nameFormat = newFormat;
                    
                    if (newFormat === 'western' && newFirstName && newLastName) {
                        profile.name = `${newFirstName}Â·${newLastName}`;
                    } else {
                        profile.name = newLastName + newFirstName;
                    }
                    if (!profile.name) {
                        profile.name = "æ–°ç”Ÿ"; 
                    }
                    await db.userProfile.put(profile);
                    hideDialog();
                    switchView('profile', true);
                };
                
                document.getElementById('dialog-name-cancel').onclick = hideDialog;
            });
            document.querySelectorAll('.editable').forEach(el => {
                el.addEventListener('click', async e => {
                    const target = e.currentTarget;
                    const parentKey = target.dataset.parentKey;
                    const key = target.dataset.key;
                    if (!key) return;
                    const promptTitle = target.title || `ä¿®æ”¹ ${key}`;
                    const oldValue = target.textContent;
                    
                    const dialogHtml = `
                        <div class="dialog-title">${promptTitle}</div>
                        <div class="form-group">
                            <textarea id="dialog-edit-input" rows="4" style="-webkit-user-select: text; user-select: text;">${oldValue}</textarea>
                        </div>
                        <div class="dialog-actions">
                            <button class="dialog-btn cancel-btn" id="dialog-edit-cancel">å–æ¶ˆ</button>
                            <button class="dialog-btn" id="dialog-edit-save">ä¿å­˜</button>
                        </div>
                    `;
                    showDialog(dialogHtml);
                    
                    document.getElementById('dialog-edit-save').onclick = async () => {
                        const newValue = document.getElementById('dialog-edit-input').value;
                        if (newValue.trim() !== oldValue) {
                            if (parentKey && state.userProfile[parentKey]) {
                                state.userProfile[parentKey][key] = newValue.trim();
                            } else {
                                state.userProfile[key] = newValue.trim();
                            }
                            await db.userProfile.put(state.userProfile);
                            hideDialog();
                            switchView('profile', true);
                        } else {
                            hideDialog();
                        }
                    };
                    document.getElementById('dialog-edit-cancel').onclick = hideDialog;
                });
            });
            
            document.getElementById('logoutBtn').addEventListener('click', async () => { if (confirm('å°†æ¸…é™¤æ‰€æœ‰æ•°æ®å¹¶é‡å¯ï¼Œç¡®å®šå—ï¼Ÿ')) { await db.delete(); window.location.reload(); } });
            
            document.getElementById('saveApiConfig').addEventListener('click', async () => {
                try {
                    const newConfig = {
                        id: 'main',
                        provider: document.getElementById('apiProvider').value,
                        url: document.getElementById('apiUrl').value.trim(),
                        key: document.getElementById('apiKey').value.trim(),
                        model: document.getElementById('apiModelSelect').value
                    };
                    state.apiConfig = newConfig;
                    await db.apiConfig.put(newConfig);
                    alert('APIè®¾ç½®å·²ä¿å­˜ï¼');
                } catch (error) {
                    console.error("Failed to save API config:", error);
                    alert("é”™è¯¯ï¼šAPIè®¾ç½®ä¿å­˜å¤±è´¥ï¼è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚");
                }
            });
            document.getElementById('profileAvatarUpload').addEventListener('change', e => handleAvatarUpload(e, async dataUrl => { 
                state.userProfile.avatar = dataUrl; 
                await db.userProfile.put(state.userProfile);
                switchView('profile', true); 
            })); 
            document.getElementById('applyFontBtn').addEventListener('click', async () => { 
                const fontUrl = document.getElementById('fontUrlInput').value.trim(); 
                const fontFamily = document.getElementById('fontFamilyInput').value.trim(); 
                await applyCustomFont(fontUrl, fontFamily); 
                alert('å­—ä½“å·²åº”ç”¨ï¼'); 
            });
            
            document.getElementById('exportDataBtn').addEventListener('click', async () => {
                try {
                    const allData = {};
                    for (const table of db.tables) {
                        allData[table.name] = await table.toArray();
                    }
                    const dataStr = JSON.stringify(allData, null, 2);
                    const filename = `hogwarts_qq_save_${new Date().toISOString().slice(0,10)}.json`;
                    const blob = new Blob([dataStr], {type: "application/json"});
                    const fileToShare = new File([blob], filename, { type: 'application/json' });
                    
                    if (navigator.canShare && navigator.canShare({ files: [fileToShare] })) {
                        try {
                            await navigator.share({
                                files: [fileToShare],
                                title: 'éœæ ¼æ²ƒèŒ¨QQæ•°æ®å¤‡ä»½',
                                text: `å¤‡ä»½æ–‡ä»¶: ${filename}`
                            });
                            return;
                        } catch (err) {
                            console.error("Web Share API å¤±è´¥:", err);
                        }
                    }
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                    
                    if (isIOS) {
                        showDialog(`
                            <div class="dialog-title">iOS å¯¼å‡º (å¤‡ç”¨æ–¹æ¡ˆ)</div>
                            <p style="text-align: left; line-height: 1.6; margin-bottom: 20px;">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥ä¿å­˜æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ‰‹åŠ¨æ­¥éª¤ï¼š<br><br>
                                <strong>1. ç‚¹å‡»â€œä¸€é”®å¤åˆ¶â€æŒ‰é’®ã€‚</strong><br>
                                <strong>2. æ‰“å¼€æ‰‹æœºçš„â€œå¤‡å¿˜å½•â€Appã€‚</strong><br>
                                <strong>3. æ–°å»ºä¸€ä¸ªå¤‡å¿˜å½•ï¼Œé•¿æŒ‰å¹¶â€œç²˜è´´â€ã€‚</strong><br>
                                <strong>4. ç‚¹å‡»å¤‡å¿˜å½•å³ä¸Šè§’çš„åˆ†äº«æŒ‰é’®ï¼Œé€‰æ‹©â€œå­˜å‚¨åˆ°â€˜æ–‡ä»¶â€™â€ã€‚</strong><br>
                                <strong>5. å°†æ–‡ä»¶åä¿®æ”¹ä¸º <code style="background: #555; padding: 2px 5px; border-radius: 4px;">${filename}</code> å¹¶ä¿å­˜ã€‚</strong>
                            </p>
                            <div class="form-group">
                                <textarea id="ios-export-textarea" rows="5" readonly style="background: #111; -webkit-user-select: text; user-select: text;">${dataStr}</textarea>
                            </div>
                            <div class="dialog-actions" style="justify-content: center;">
                                <button id="ios-copy-btn" class="dialog-btn">ä¸€é”®å¤åˆ¶</button>
                            </div>
                        `);
                        document.getElementById('ios-copy-btn').onclick = () => {
                            const textarea = document.getElementById('ios-export-textarea');
                            textarea.select();
                            textarea.setSelectionRange(0, 99999);
                            try {
                                document.execCommand('copy');
                                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ç°åœ¨å¯ä»¥å»å¤‡å¿˜å½•ç²˜è´´äº†ã€‚');
                            } catch (err) {
                                alert('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰æ–‡æœ¬æ¡†è¿›è¡Œå¤åˆ¶ã€‚');
                            }
                        };
                    } else {
                        const a = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }
                } catch (e) {
                    console.error("å¯¼å‡ºæ•°æ®å¤±è´¥:", e);
                    alert("å¯¼å‡ºæ•°æ®å¤±è´¥ï¼");
                }
            });
            const importDataInput = document.getElementById('importDataInput');
            document.getElementById('importDataBtn').addEventListener('click', () => {
                importDataInput.click();
            });
            importDataInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if (confirm('è­¦å‘Šï¼šå¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰è¿›åº¦å’Œè®¾ç½®ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            let importedData = JSON.parse(e.target.result);
                            
                            if (importedData.appInitialized && importedData.userProfile && !Array.isArray(importedData.userProfile)) {
                                console.log("æ£€æµ‹åˆ°æ—§ç‰ˆlocalStorageæ•°æ®æ ¼å¼ï¼Œæ­£åœ¨è½¬æ¢...");
                                const oldState = importedData;
                                const migratedData = {
                                    appState: [{ id: 'main', initialized: oldState.appInitialized, currentView: oldState.currentView, activeContactId: oldState.activeContactId, previousView: oldState.previousView, replyingTo: oldState.replyingTo }],
                                    userProfile: [{ id: 'main', ...oldState.userProfile }],
                                    apiConfig: [{ id: 'main', ...oldState.apiConfig }],
                                    contacts: oldState.contacts || [],
                                    chats: oldState.messages || [], 
                                    myMoments: oldState.myMoments || [],
                                    friendMoments: oldState.friendMoments || [],
                                    groups: [],
                                    triwizardChapters: oldState.triwizardChapters || []
                                };
                                importedData = migratedData;
                                console.log("æ•°æ®è½¬æ¢å®Œæˆã€‚");
                            }
                            if ((!importedData.triwizardChapters || importedData.triwizardChapters.length === 0) && importedData.userProfile && importedData.userProfile[0]) {
                                console.log("ä¸‰å¼ºäº‰éœ¸èµ›æ•°æ®ç¼ºå¤±ï¼Œæ­£åœ¨ä¸ºå¯¼å…¥çš„æ•°æ®ç”Ÿæˆé»˜è®¤ç« èŠ‚...");
                                const playerHouse = importedData.userProfile[0].house || 'slytherin';
                                importedData.triwizardChapters = generateDefaultTriwizardChapters(playerHouse);
                            }
                             
                            const allDefaultContacts = Object.values(getDefaultContacts()).flat();
                            if (importedData.contacts && Array.isArray(importedData.contacts)) {
                                const importedContactIds = new Set(importedData.contacts.map(c => c.id));
                                const missingContacts = allDefaultContacts.filter(c => !c.id.startsWith('oc') && !importedContactIds.has(c.id));
                                if (missingContacts.length > 0) {
                                    importedData.contacts.push(...missingContacts);
                                }
                            } else {
                                importedData.contacts = allDefaultContacts;
                            }
                            if ((!importedData.groups || importedData.groups.length === 0) && importedData.userProfile[0]) {
                                const playerHouse = importedData.userProfile[0].house;
                                const d = getDefaultContacts();
                                const allHouses = ['slytherin', 'gryffindor', 'ravenclaw', 'hufflepuff'];
                                const otherHouses = allHouses.filter(h => h !== playerHouse);
                                importedData.groups = [
                                    { id: 'group_professors', name: 'æ•™æˆ', contactIds: d.professors.map(c => c.id), isDeletable: true, isRenamable: true, isPinned: false },
                                    { id: `group_${playerHouse}`, name: HOUSE_INFO[playerHouse].name, contactIds: d[playerHouse].map(c => c.id), isDeletable: true, isRenamable: true, isPinned: false },
                                    { id: 'group_other_houses', name: 'å…¶ä»–å­¦é™¢', contactIds: otherHouses.flatMap(h => d[h].map(c => c.id)), isDeletable: true, isRenamable: true, isPinned: false },
                                    { id: 'group_oc', name: 'åŸåˆ›è§’è‰²', contactIds: (importedData.contacts || []).filter(c => c.oc).map(c => c.id), isDeletable: true, isRenamable: true, isPinned: false }
                                ];
                            } else if (importedData.groups) {
                                importedData.groups.forEach(g => {
                                    if(g.isPinned === undefined) g.isPinned = false;
                                });
                            }
                            const tablesToMigrateKey = ['appState', 'userProfile', 'apiConfig'];
                            for (const tableName of tablesToMigrateKey) {
                                if (importedData[tableName] && Array.isArray(importedData[tableName])) {
                                    importedData[tableName].forEach(item => {
                                        if (item.key && item.id === undefined) {
                                            item.id = item.key;
                                            delete item.key;
                                        }
                                    });
                                }
                            }
                            
                            if (importedData.userProfile && importedData.userProfile[0]) {
                                const p = importedData.userProfile[0];
                                if (!p.customEmojis) p.customEmojis = {};
                                if (p.nameFormat === undefined) p.nameFormat = 'chinese'; 
                                if (p.lastName === undefined) p.lastName = '';
                                if (p.firstName === undefined) p.firstName = '';
                            }
                            if (importedData.chats && Array.isArray(importedData.chats)) {
                                importedData.chats.forEach(chat => {
                                    if (chat.isPinned === undefined) chat.isPinned = false;
                                    if (chat.isHidden === undefined) chat.isHidden = false;
                                    if (chat.summary === undefined) chat.summary = "";
                                    if (chat.isOfflineMode === undefined) chat.isOfflineMode = false;
                                    if (chat.isGroup === undefined) chat.isGroup = false; 
                                    if (chat.members === undefined) chat.members = []; 
                                    if (chat.isGroup) {
                                        if (chat.avatar === undefined) chat.avatar = null;
                                        if (chat.myNickname === undefined) chat.myNickname = null;
                                        if (Array.isArray(chat.members)) {
                                            chat.members.forEach(m => {
                                                if (m.nickname === undefined) m.nickname = null;
                                                if (m.persona === undefined) m.persona = null;
                                                if (m.sharedHistory === undefined) m.sharedHistory = null;
                                            });
                                        }
                                    }
                                });
                            }
                            if (importedData.contacts && Array.isArray(importedData.contacts)) {
                                importedData.contacts.forEach(c => {
                                    if (c.isPinned === undefined) c.isPinned = false;
                                });
                            }
                            await db.transaction('rw', db.tables, async () => {
                                for (const tableName in importedData) {
                                    if (db[tableName]) {
                                        await db[tableName].clear();
                                        if (importedData[tableName].length > 0) {
                                            await db[tableName].bulkPut(importedData[tableName]);
                                        }
                                    }
                                }
                            });
                            alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼åº”ç”¨å°†é‡æ–°åŠ è½½ã€‚');
                            window.location.reload();
                        } catch (error) {
                            alert(`å¯¼å…¥å¤±è´¥ï¼šæ— æ³•è§£ææ–‡ä»¶ã€‚\né”™è¯¯: ${error.message}`);
                        }
                    };
                    reader.readAsText(file);
                }
                event.target.value = '';
            });
        }
        window.bindChatEvents = function() {
            // âœ¨ æ–°å¢çš„æœç´¢æŒ‰é’®äº‹ä»¶ç»‘å®š
            document.getElementById('searchChatBtn')?.addEventListener('click', () => {
                showSearchDialog();
            });
            const chatHistoryEl = document.getElementById('chatHistory');
            const emojiPanel = document.getElementById('emojiPanel');
            if (chatHistoryEl) {
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
            }
            
            document.getElementById('memoryBtn')?.addEventListener('click', () => {
                showDialog(`
                    <div class="dialog-title">ç¼–è¾‘è®°å¿†æ¦‚è¦</div>
                    <div class="form-group">
                        <label>æ‰‹åŠ¨æ€»ç»“ä½ ä»¬çš„æ•…äº‹è¿›å±•ï¼š</label>
                        <textarea id="memorySummary" rows="8" style="font-size: 14px;">${state.currentChat.summary || ''}</textarea>
                    </div>
                    <div class="dialog-actions">
                        <button class="dialog-btn cancel-btn">å–æ¶ˆ</button>
                        <button id="saveMemoryBtn" class="dialog-btn">ä¿å­˜</button>
                    </div>
                `);
                document.querySelector('.dialog-btn.cancel-btn').onclick = hideDialog;
                document.getElementById('saveMemoryBtn').onclick = async () => {
                    state.currentChat.summary = document.getElementById('memorySummary').value;
                    await db.chats.put(state.currentChat);
                    hideDialog();
                    alert("è®°å¿†å·²æ›´æ–°ï¼");
                };
            });
            const applyChatBackground = () => { if (!chatHistoryEl) return; if (state.currentChat.background) { chatHistoryEl.style.backgroundImage = `url(${state.currentChat.background})`; chatHistoryEl.style.backgroundSize = 'cover'; chatHistoryEl.style.backgroundPosition = 'center'; chatHistoryEl.classList.add('has-custom-bg'); } else { chatHistoryEl.style.backgroundImage = 'none'; chatHistoryEl.classList.remove('has-custom-bg'); } };
            if (!state.currentChat.isTriwizard) applyChatBackground();
            const sendText = async () => { const text = document.getElementById('messageInput').value.trim(); if (text === '') return; await addMessageToChat({ type: 'text', text, quote: state.replyingTo }); document.getElementById('messageInput').value = ''; state.replyingTo = null; await updateAppState(); };
            
            const offlineModeBtn = document.getElementById('offlineModeBtn');
            if (offlineModeBtn) {
                if (state.currentChat.isOfflineMode) {
                    offlineModeBtn.classList.add('active');
                }
                offlineModeBtn.addEventListener('click', async () => {
                    state.currentChat.isOfflineMode = !state.currentChat.isOfflineMode;
                    offlineModeBtn.classList.toggle('active');
                    await db.chats.put(state.currentChat);
                    alert(state.currentChat.isOfflineMode ? 'çº¿ä¸‹æ¨¡å¼å·²å¼€å¯' : 'çº¿ä¸‹æ¨¡å¼å·²å…³é—­');
                });
            }
            document.getElementById('messageInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendText(); } });
            document.getElementById('sendMessageBtn').addEventListener('click', sendText);
            document.getElementById('aiInitiateMessageBtn').addEventListener('click', () => getApiResponse("ai_initiate"));
            document.getElementById('saveStoryBtn')?.addEventListener('click', () => showSaveStoryDialog(state.currentChat.id));
            document.getElementById('sendImageBtn')?.addEventListener('click', () => { showDialog(`<div class="dialog-title">å‘é€å›¾ç‰‡</div><div class="form-group"><label>å›¾ç‰‡æè¿°</label><textarea id="imageDesc" rows="3"></textarea></div><div class="form-group"><label>ä¸Šä¼ å›¾ç‰‡</label><input type="file" id="imageUpload" accept="image/*"><img id="imagePreview" class="image-preview hidden"></div><div class="dialog-actions"><button class="dialog-btn cancel-btn">å–æ¶ˆ</button><button id="confirmSendImage" class="dialog-btn">å‘é€</button></div>`); document.getElementById('imageUpload').onchange = e => handleAvatarUpload(e, dataUrl => { document.getElementById('imagePreview').src = dataUrl; document.getElementById('imagePreview').classList.remove('hidden'); }); document.querySelector('.dialog-btn.cancel-btn').onclick = hideDialog; document.getElementById('confirmSendImage').onclick = async () => { const text = document.getElementById('imageDesc').value; const imageData = document.getElementById('imagePreview').src; if(imageData) { await addMessageToChat({type:'image', text, imageData}); hideDialog(); } else { alert("è¯·ä¸Šä¼ å›¾ç‰‡"); } }; });
            
            document.getElementById('sendGiftBtn')?.addEventListener('click', () => {
                const isGroup = state.currentChat.isGroup;
                let recipientHtml = '';
                if(isGroup) {
                    recipientHtml = `<div class="form-group"><label>èµ é€å¯¹è±¡</label><select id="giftRecipient">`;
                    state.currentChat.members.forEach(member => {
                        recipientHtml += `<option value="${member.name}">${member.nickname || member.name}</option>`;
                    });
                    recipientHtml += `</select></div>`;
                }
                showDialog(`<div class="dialog-title">èµ é€ç¤¼ç‰©</div>
                            ${recipientHtml}
                            <div class="form-group"><label>ç¤¼ç‰©å¤–è§‚ (å¯é€‰)</label><input type="file" id="giftImageUpload" accept="image/*"><img id="giftImagePreview" class="image-preview hidden"></div>
                            <div class="form-group"><label>ç¤¼ç‰©ç®€ä»‹</label><input type="text" id="giftName"></div>
                            <div class="form-group"><label>ç¤¼ç‰©ä»·æ ¼</label><input type="text" id="giftPrice"></div>
                            <div class="form-group"><label>èµ é€å¿ƒæ„</label><textarea id="giftMessage" rows="2"></textarea></div>
                            <div class="dialog-actions"><button class="dialog-btn cancel-btn">å–æ¶ˆ</button><button id="confirmSendGift" class="dialog-btn">èµ é€</button></div>`);
                
                document.getElementById('giftImageUpload').onchange = e => handleAvatarUpload(e, dataUrl => { document.getElementById('giftImagePreview').src = dataUrl; document.getElementById('giftImagePreview').classList.remove('hidden'); });
                document.querySelector('.dialog-btn.cancel-btn').onclick = hideDialog;
                document.getElementById('confirmSendGift').onclick = async () => {
                    const gift = { 
                        image: document.getElementById('giftImagePreview').src || null, 
                        name: document.getElementById('giftName').value, 
                        price: document.getElementById('giftPrice').value, 
                        message: document.getElementById('giftMessage').value,
                        recipient: isGroup ? document.getElementById('giftRecipient').value : null
                    };
                    if(gift.name) { 
                        await addMessageToChat({type: 'gift', gift});
                        hideDialog();
                    } else { 
                        alert("è¯·å¡«å†™ç¤¼ç‰©ç®€ä»‹");
                    }
                };
            });
            document.getElementById('chatSettingsBtn')?.addEventListener('click', () => { showDialog(`<div class="dialog-title">èŠå¤©è®¾ç½®</div><div class="dialog-actions" style="flex-direction: column; gap: 10px;"><button class="dialog-btn" id="setBgBtn">è®¾ç½®èƒŒæ™¯</button><input type="file" id="bgUpload" class="hidden" accept="image/*"><button class="dialog-btn" id="resetBgBtn">æ¢å¤é»˜è®¤</button></div>`); document.getElementById('setBgBtn').onclick = () => document.getElementById('bgUpload').click(); document.getElementById('resetBgBtn').onclick = async () => { state.currentChat.background = null; applyChatBackground(); await db.chats.put(state.currentChat); hideDialog(); }; document.getElementById('bgUpload').onchange = e => handleAvatarUpload(e, async dataUrl => { state.currentChat.background = dataUrl; applyChatBackground(); await db.chats.put(state.currentChat); hideDialog(); }); });
            
            const groupSettingsBtn = document.getElementById('groupSettingsBtn');
            if (groupSettingsBtn) {
                groupSettingsBtn.addEventListener('click', () => showGroupSettingsDialog());
            }
            const addEmojiBtn = document.getElementById('addEmojiBtn');
            if (addEmojiBtn) {
                addEmojiBtn.addEventListener('click', () => {
                    showAddEmojiModal();
                });
            }
            const deleteEmojiBtn = document.getElementById('deleteEmojiBtn');
            if (deleteEmojiBtn) {
                deleteEmojiBtn.addEventListener('click', () => {
                    showDeleteEmojiModal();
                });
            }
            const emojiBtn = document.getElementById('emojiBtn');
            if(emojiBtn) {
                emojiBtn.addEventListener('click', (e) => { e.stopPropagation(); renderEmojiPanel(); emojiPanel.style.display = emojiPanel.style.display === 'block' ? 'none' : 'block'; });
                document.addEventListener('click', (e) => { if (emojiPanel && !emojiPanel.contains(e.target) && e.target.id !== 'emojiBtn' && !e.target.closest('#emojiBtn')) { emojiPanel.style.display = 'none'; } });
            }
            document.querySelectorAll('.message').forEach(el => {
                addLongPressListener(el, (e) => {
                    showContextMenu(e, 'message', el.dataset.messageId);
                });
            });
        }
        // âœ¨ --- æ–°å¢çš„æœç´¢åŠŸèƒ½ä»£ç  START ---
        /**
         * æ˜¾ç¤ºæœç´¢è¾“å…¥å¯¹è¯æ¡†
         */
        function showSearchDialog() {
            const dialogHtml = `
                <div class="dialog-title">æœç´¢èŠå¤©è®°å½•</div>
                <div class="form-group">
                    <label for="searchInput">å…³é”®è¯</label>
                    <input type="text" id="searchInput" placeholder="è¾“å…¥è¦æœç´¢çš„å†…å®¹..." style="-webkit-user-select: text; user-select: text;">
                </div>
                <div class="dialog-actions">
                    <button class="dialog-btn cancel-btn">å–æ¶ˆ</button>
                    <button class="dialog-btn" id="executeSearchBtn">æœç´¢</button>
                </div>
            `;
            showDialog(dialogHtml);
            document.querySelector('.dialog-btn.cancel-btn').onclick = hideDialog;
            document.getElementById('executeSearchBtn').onclick = executeSearch;
            // ä¸ºè¾“å…¥æ¡†æ·»åŠ å›è½¦é”®ç›‘å¬ï¼Œæ–¹ä¾¿æ“ä½œ
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    executeSearch();
                }
            });
            document.getElementById('searchInput').focus();
        }
        /**
         * æ‰§è¡Œæœç´¢å¹¶æ˜¾ç¤ºç»“æœ
         */
        function executeSearch() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) {
                alert('è¯·è¾“å…¥å…³é”®è¯ï¼');
                return;
            }
            // ç­›é€‰ä»…åŒ…å«æ–‡æœ¬ç±»å‹çš„æ¶ˆæ¯ï¼Œå¹¶è¿›è¡Œä¸åŒºåˆ†å¤§å°å†™çš„æœç´¢
            const results = state.currentChat.messages.filter(msg => 
                (msg.type === 'text' || !msg.type) && msg.text && msg.text.toLowerCase().includes(keyword.toLowerCase())
            );
            if (results.length === 0) {
                alert('æœªæ‰¾åˆ°åŒ…å«è¯¥å…³é”®è¯çš„è®°å½•ã€‚');
            } else {
                showSearchResults(results, keyword);
            }
        }
        /**
         * åœ¨å¯¹è¯æ¡†ä¸­æ˜¾ç¤ºæœç´¢ç»“æœ
         * @param {Array} results - æœç´¢åˆ°çš„æ¶ˆæ¯å¯¹è±¡æ•°ç»„
         * @param {string} keyword - ç”¨äºé«˜äº®çš„å…³é”®è¯
         */
        function showSearchResults(results, keyword) {
            // æŒ‰æ—¶é—´å€’åºæ˜¾ç¤ºï¼Œæœ€è¿‘çš„è®°å½•åœ¨æœ€ä¸Šé¢
            results.reverse();
            let resultsHtml = `
                <div class="dialog-title">æœç´¢ç»“æœ (${results.length}æ¡)</div>
                <div class="search-results-container">`;
            
            const keywordRegex = new RegExp(keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
            results.forEach(msg => {
                // é«˜äº®å…³é”®è¯
                const highlightedText = msg.text.replace(keywordRegex, match => `<strong class="highlight">${match}</strong>`);
                resultsHtml += `
                    <div class="search-result-item" data-message-id="${msg.id}">
                        <div class="search-result-header">
                            <strong>${msg.sender || 'æœªçŸ¥å‘é€è€…'}</strong>
                            <span class="time">${msg.time}</span>
                        </div>
                        <div class="search-result-content">${highlightedText}</div>
                    </div>
                `;
            });
            resultsHtml += `</div>`;
            // ç›´æ¥æ›´æ–°å½“å‰å¯¹è¯æ¡†çš„å†…å®¹
            const dialogContent = document.getElementById('dialogContent');
            dialogContent.innerHTML = `<button class="close-dialog-btn">&times;</button>${resultsHtml}`;
            wizardDialog.querySelector('.close-dialog-btn').onclick = hideDialog;
            // ä¸ºæ¯ä¸€æ¡ç»“æœç»‘å®šç‚¹å‡»è·³è½¬äº‹ä»¶
            document.querySelectorAll('.search-result-item').forEach(item => {
                item.onclick = () => {
                    const messageId = item.dataset.messageId;
                    hideDialog(); // å…³é—­æœç´¢ç»“æœæ¡†
                    // åœ¨èŠå¤©è®°å½•ä¸­æ‰¾åˆ°å¯¹åº”çš„æ¶ˆæ¯å…ƒç´ 
                    const targetMessage = document.querySelector(`.message[data-message-id="${messageId}"]`);
                    if (targetMessage) {
                        // æ»šåŠ¨åˆ°è¯¥æ¶ˆæ¯çš„ä½ç½®
                        targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // æ·»åŠ ä¸€ä¸ªä¸´æ—¶çš„é—ªçƒæˆ–é«˜äº®æ•ˆæœï¼Œä»¥ç¤ºæé†’
                        targetMessage.style.transition = 'background-color 0.5s ease-in-out';
                        targetMessage.style.backgroundColor = 'var(--theme-accent)';
                        setTimeout(() => {
                            targetMessage.style.backgroundColor = '';
                        }, 2000);
                    }
                };
            });
        }
        // âœ¨ --- æ–°å¢çš„æœç´¢åŠŸèƒ½ä»£ç  END ---
        window.bindMomentsEvents = function() {
            const renderMomentsList = (moments) => {
                if (!moments || moments.length === 0) return `<div class="card">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿ...</div>`;
                
                const sortedMoments = [...moments].sort((a, b) => {
                    const timeA = parseInt(a.id.split('_')[1]);
                    const timeB = parseInt(b.id.split('_')[1]);
                    return timeB - timeA;
                });
                return sortedMoments.map((moment, momentIndex) => {
                    const contact = state.contacts.find(c => c.name === moment.name) || { house: moment.house, avatar: null, icon: 'ğŸ°' };
                    const house = contact.house || 'hogwarts';
                    const colors = HOUSE_INFO[house].colors;
                    const playerHasLiked = (moment.likedBy || []).includes(state.userProfile.name);
                    const commentsHtml = (moment.comments || []).map((comment, commentIndex) => `
                        <div class="comment" data-moment-id="${moment.id}" data-comment-index="${commentIndex}">
                            <strong>${comment.author}</strong>
                            ${comment.replyTo ? `<span class="reply-to"> @ ${comment.replyTo}</span>` : ''}: 
                            ${comment.text}
                        </div>
                    `).join('');
                    return `<div class="moment-item" data-moment-id="${moment.id}">
                                <div class="moment-header">
                                    <div class="moment-avatar avatar" style="${getAvatarStyle(contact.avatar, colors.dark)}">${!contact.avatar ? contact.icon : ''}</div>
                                    <div class="moment-user"><div>${moment.name}</div><div class="moment-time">${moment.time}</div></div>
                                </div>
                                <div class="moment-content">${moment.content}</div>
                                ${moment.image ? `<img src="${moment.image}" class="moment-image">` : ''}
                                <div class="moment-footer">
                                    <div class="moment-footer-action like-btn ${playerHasLiked ? 'liked' : ''}"><i class="fas fa-heart"></i> ${(moment.likedBy || []).length}</div>
                                    <div class="moment-footer-action reply-btn"><i class="fas fa-comment"></i> å›å¤</div>
                                    <div class="moment-footer-action ai-reply-btn"><i class="fas fa-users"></i> æŸ¥çœ‹å¥½å‹å›å¤</div>
                                </div>
                                <div class="moment-comments">${commentsHtml}</div>
                                <div class="moment-comment-input-wrapper">
                                    <input type="text" placeholder="æ·»åŠ è¯„è®º...">
                                    <button data-moment-id="${moment.id}">å‘é€</button>
                                </div>
                            </div>`;
                }).join('');
            };
            const momentsContent = document.getElementById('momentsContent');
            const updateTabView = (activeTab) => {
                document.querySelector('.tab.active')?.classList.remove('active'); document.querySelector(`.tab[data-tab="${activeTab}"]`)?.classList.add('active');
                if (activeTab === 'friends') { momentsContent.innerHTML = `<button class="btn primary" id="generateMomentsBtn" style="width:100%; margin-bottom: 15px;">åˆ·æ–°å¥½å‹åŠ¨æ€</button><div id="friendMomentsList">${renderMomentsList(state.friendMoments)}</div>`; document.getElementById('generateMomentsBtn').onclick = () => generateAIFriendMoments(); } 
                else { momentsContent.innerHTML = `<button class="btn primary" id="newMomentBtn" style="width:100%; margin-bottom: 15px;">å‘å¸ƒæ–°åŠ¨æ€</button><div id="myMomentsList">${renderMomentsList(state.myMoments)}</div>`; document.getElementById('newMomentBtn').onclick = () => switchView('newMoment'); }
                
                momentsContent.querySelectorAll('.like-btn').forEach(btn => btn.onclick = async (e) => {
                    const id = e.currentTarget.closest('.moment-item').dataset.momentId;
                    const isMyMoment = state.myMoments.some(m => m.id === id);
                    const moment = isMyMoment ? state.myMoments.find(m => m.id === id) : state.friendMoments.find(m => m.id === id);
                    if (moment) {
                        if (!moment.likedBy) moment.likedBy = [];
                        const userIndex = moment.likedBy.indexOf(state.userProfile.name);
                        if (userIndex > -1) {
                            moment.likedBy.splice(userIndex, 1);
                        } else {
                            moment.likedBy.push(state.userProfile.name);
                        }
                        if (isMyMoment) await db.myMoments.put(moment);
                        else await db.friendMoments.put(moment);
                        await getApiCommentForMoment(moment);
                        switchView('moments', true);
                    }
                });
                
                momentsContent.querySelectorAll('.reply-btn, .comment').forEach(el => el.onclick = (e) => {
                    const momentItem = e.currentTarget.closest('.moment-item');
                    const inputWrapper = momentItem.querySelector('.moment-comment-input-wrapper');
                    const inputField = inputWrapper.querySelector('input');
                    inputWrapper.classList.toggle('active');
                    if (inputWrapper.classList.contains('active')) {
                        inputField.focus();
                        if (e.currentTarget.classList.contains('comment')) {
                            const author = e.currentTarget.querySelector('strong').textContent;
                            if (author !== state.userProfile.name) {
                                inputField.value = `@${author} `;
                                inputField.dataset.replyTo = author;
                            }
                        } else {
                            inputField.value = '';
                            delete inputField.dataset.replyTo;
                        }
                    }
                });
                momentsContent.querySelectorAll('.ai-reply-btn').forEach(btn => btn.onclick = (e) => {
                    const id = e.currentTarget.closest('.moment-item').dataset.momentId;
                    const m = (state.friendMoments || []).concat(state.myMoments || []).find(m=>m.id==id);
                    if(m) getApiCommentForMoment(m);
                });
                momentsContent.querySelectorAll('.moment-comment-input-wrapper button').forEach(btn => btn.onclick = async (e) => {
                    const id = e.currentTarget.dataset.momentId;
                    const isMyMoment = state.myMoments.some(m => m.id === id);
                    const moment = isMyMoment ? state.myMoments.find(m => m.id === id) : state.friendMoments.find(m => m.id === id);
                    if (moment) {
                        const inputField = e.currentTarget.previousElementSibling;
                        const content = inputField.value.trim();
                        if (content) {
                            if (!moment.comments) moment.comments = [];
                            const replyTo = inputField.dataset.replyTo;
                            let text = content;
                            if (replyTo && content.startsWith(`@${replyTo} `)) {
                                text = content.substring(`@${replyTo} `.length);
                            }
                            moment.comments.push({ author: state.userProfile.name, text: text, replyTo: replyTo || null });
                            
                            await getApiCommentForMoment(moment);
                            
                            if (isMyMoment) await db.myMoments.put(moment);
                            else await db.friendMoments.put(moment);
                            
                            switchView('moments', true);
                        }
                    }
                });
                
                momentsContent.querySelectorAll('.moment-item').forEach(el => {
                    addLongPressListener(el, (e) => {
                        if (e.target.closest('.comment')) {
                            return;
                        }
                        e.stopPropagation();
                        const id = el.dataset.momentId;
                        showContextMenu(e, 'moment', id);
                    });
                });
                momentsContent.querySelectorAll('.comment').forEach(el => {
                    addLongPressListener(el, (e) => {
                        e.stopPropagation();
                        const id = el.dataset.momentId;
                        const commentIndex = el.dataset.commentIndex;
                        showContextMenu(e, 'comment', id, commentIndex);
                    });
                });
            };
            
            if (!state.activeMomentsTab) {
                state.activeMomentsTab = 'friends';
            }
            document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', (e) => {
                state.activeMomentsTab = e.currentTarget.dataset.tab;
                updateTabView(state.activeMomentsTab);
            }));
            updateTabView(state.activeMomentsTab);
        }
        function showMomentVisibilityDialog(currentBlockedIds = []) {
            let contactsHtml = '<div style="max-height: 40vh; overflow-y: auto; text-align: left;">';
            state.contacts.forEach(contact => {
                const isChecked = currentBlockedIds.includes(contact.id);
                contactsHtml += `
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <input type="checkbox" id="block_${contact.id}" value="${contact.id}" name="contact-to-block" ${isChecked ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px;">
                        <label for="block_${contact.id}" style="display: flex; align-items: center; gap: 8px;">
                            <div class="chat-avatar avatar" style="${getAvatarStyle(contact.avatar, '#ccc')}; width:30px; height:30px; font-size: 16px; flex-shrink: 0;">${!contact.avatar ? contact.icon : ''}</div>
                            <span>${contact.name}</span>
                        </label>
                    </div>`;
            });
            contactsHtml += '</div>';
            showDialog(`
                <div class="dialog-title">é€‰æ‹©ä¸å¯è§çš„è§’è‰²</div>
                ${contactsHtml}
                <div class="dialog-actions">
                    <button class="dialog-btn" id="confirmVisibility">ç¡®è®¤</button>
                </div>
            `);
            document.getElementById('confirmVisibility').onclick = () => {
                const selected = document.querySelectorAll('input[name="contact-to-block"]:checked');
                const blockedIds = Array.from(selected).map(cb => cb.value);
                
                const publishBtn = document.getElementById('publishMoment');
                publishBtn.dataset.blockedIds = JSON.stringify(blockedIds);
                const visibilityBtn = document.getElementById('momentVisibilityBtn');
                if (blockedIds.length === 0) {
                    visibilityBtn.textContent = 'å…¬å¼€';
                } else {
                    visibilityBtn.textContent = `å¯¹ ${blockedIds.length} äººä¸å¯è§`;
                }
                
                hideDialog();
            };
        }
        window.bindNewMomentEvents = function() { 
            const publishBtn = document.getElementById('publishMoment');
            publishBtn.dataset.blockedIds = '[]'; 
            document.getElementById('momentVisibilityBtn').addEventListener('click', () => {
                const currentBlockedIds = JSON.parse(publishBtn.dataset.blockedIds || '[]' );
                showMomentVisibilityDialog(currentBlockedIds);
            });
            document.getElementById('cancelMoment').addEventListener('click', () => switchView('moments')); 
            
            publishBtn.addEventListener('click', async () => { 
                const content = document.getElementById('momentContent').value.trim(); 
                if (!content) return; 
                const blockedContactIds = JSON.parse(publishBtn.dataset.blockedIds || '[]');
                const newMoment = { 
                    id: `moment_${Date.now()}`, 
                    name: state.userProfile.name, 
                    house: state.userProfile.house, 
                    time: "åˆšåˆš", 
                    content, 
                    image: document.getElementById('momentImagePreview').src || null, 
                    comments: [], 
                    likedBy: [],
                    blockedContactIds: blockedContactIds
                }; 
                state.myMoments.unshift(newMoment);
                await db.myMoments.put(newMoment);
                await getApiCommentForMoment(newMoment);
                switchView('moments'); 
            }); 
            document.getElementById('momentImageUpload').onchange = e => handleAvatarUpload(e, dataUrl => { document.getElementById('momentImagePreview').src = dataUrl; document.getElementById('momentImagePreview').classList.remove('hidden'); }); 
        }
        window.bindEditFriendEvents = function() { 
            const c = state.contacts.find(c => c.id === state.activeContactId); 
            viewTitle.textContent = `ç¼–è¾‘ - ${c.name}`; 
            const tabContent = document.getElementById('tabContent'); 
            document.querySelectorAll('.tab').forEach(tab => { 
                tab.addEventListener('click', function() { 
                    document.querySelector('.tab.active').classList.remove('active'); 
                    this.classList.add('active'); 
                    tabContent.innerHTML = this.dataset.tab === 'info' ? `${c.oc ? `<div class="form-group"><label>è§’è‰²ID</label><input type="text" id="friendId" value="${c.id}"></div>` : ''}<div class="form-group"><label>åŸºæœ¬ä¿¡æ¯</label><textarea id="friendInfo" rows="6">${c.info}</textarea></div>` : `<div class="form-group"><label>å…±åŒç»å†</label><textarea id="friendHistory" rows="6">${c.sharedHistory}</textarea></div>`; 
                }); 
            }); 
            document.getElementById('friendAvatarUpload').addEventListener('change', e => handleAvatarUpload(e, async dataUrl => { 
                c.avatar = dataUrl; 
                await db.contacts.put(c);
                switchView('editFriend', true); 
            })); 
            document.getElementById('saveFriendInfoBtn').addEventListener('click', async () => { 
                const info = document.getElementById('friendInfo')?.value; 
                const history = document.getElementById('friendHistory')?.value; 
                if(info !== undefined) c.info = info; 
                if(history !== undefined) c.sharedHistory = history; 
                if(c.oc) { 
                    const newId = document.getElementById('friendId')?.value.trim(); 
                    if (newId && newId !== c.id) { 
                        const exists = await db.contacts.get(newId);
                        if(exists) { 
                            alert('é”™è¯¯ï¼šè¯¥IDå·²è¢«å…¶ä»–è”ç³»äººä½¿ç”¨ï¼Œè¯·è¾“å…¥ä¸€ä¸ªå”¯ä¸€çš„IDã€‚'); return; 
                        } 
                        await updateContactIdReferences(c.id, newId); 
                        await db.contacts.delete(c.id);
                        c.id = newId; c.name = newId; 
                    } 
                } 
                await db.contacts.put(c);
                alert('ä¿¡æ¯å·²ä¿å­˜ï¼'); 
            }); 
        }    
        window.bindTriwizardEvents = function() {
            document.querySelectorAll('.twt-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const chapterId = e.currentTarget.dataset.chapterId;
                    showChapterDialog(chapterId);
                });
            });
        }
        async function showChapterDialog(chapterId) {
            const chapter = await db.triwizardChapters.get(chapterId);
            if (!chapter) {
                console.error(`æ— æ³•åŠ è½½ç« èŠ‚ID: ${chapterId}ã€‚æ•°æ®å¯èƒ½å·²æŸåæˆ–æœªåˆå§‹åŒ–ã€‚`);
                alert("é”™è¯¯ï¼šæ— æ³•åŠ è½½ç« èŠ‚æ•°æ®ï¼");
                return;
            }
            showDialog(`
                <div class="dialog-title">${chapter.name}</div>
                <div class="dialog-actions" style="flex-direction: column; gap: 10px; align-items: stretch;">
                    <button class="dialog-btn" id="restartStoryBtn">é‡å¼€å‰§æƒ…</button>
                    <button class="dialog-btn" id="loadStoryBtn">è¯»å–è®°å½•</button>
                </div>
            `);
            document.getElementById('restartStoryBtn').onclick = () => startChapter(chapterId, false);
            document.getElementById('loadStoryBtn').onclick = () => startChapter(chapterId, true);
        }
        async function startChapter(chapterId, loadFromSave) {
            hideDialog();
            const chapter = await db.triwizardChapters.get(chapterId);
            let messages;
            if (loadFromSave) {
                const mainSaveSlot = chapter.savedSlots[chapter.mainSaveSlotIndex];
                if (mainSaveSlot && mainSaveSlot.messages) {
                    messages = mainSaveSlot.messages;
                } else {
                    alert("æ²¡æœ‰å¯è¯»å–çš„ä¸»è¦è®°å½•ã€‚å°†ä¸ºæ‚¨å¼€å¯æ–°å‰§æƒ…ã€‚");
                    messages = [{ id: `msg_${Date.now()}`, type: 'text', text: chapter.intro, time: '', incoming: true, sender: 'æ—ç™½' }];
                }
            } else {
                messages = [{ id: `msg_${Date.now()}`, type: 'text', text: chapter.intro, time: '', incoming: true, sender: 'æ—ç™½' }];
            }
            state.currentChat = {
                id: chapter.id,
                name: chapter.name,
                isTriwizard: true,
                messages: messages
            };
            switchView('chat');
        }
        async function showSaveStoryDialog(chapterId) {
            const chapter = await db.triwizardChapters.get(chapterId);
            let slotsHtml = '';
            for (let i = 0; i < 3; i++) {
                const slot = chapter.savedSlots[i];
                const isMain = chapter.mainSaveSlotIndex === i;
                const slotInfo = slot ? `å­˜æ¡£äº: ${new Date(slot.timestamp).toLocaleString()}` : 'ç©ºè®°å½•';
                const mainTag = isMain ? '<span class="main-record-tag">ä¸»è¦è®°å½•</span>' : '';
                slotsHtml += `
                    <div class="save-slot-item">
                        <label>
                            <input type="radio" name="main-save-slot" value="${i}" ${isMain ? 'checked' : ''} style="width: 20px; height: 20px;">
                            <div class="save-slot-info">
                                <strong>è®°å½•æ§½ ${i + 1}</strong>
                                <span style="font-size: 12px; opacity: 0.8;">${slotInfo}</span>
                                ${mainTag}
                            </div>
                        </label>
                        <button class="btn primary" data-slot-index="${i}" style="padding: 5px 10px; font-size: 14px;">å­˜æ¡£</button>
                    </div>
                `;
            }
            slotsHtml += `
                <div class="save-slot-item">
                    <label>
                        <input type="radio" name="main-save-slot" value="-1" ${chapter.mainSaveSlotIndex === -1 ? 'checked' : ''} style="width: 20px; height: 20px;">
                        <div class="save-slot-info">
                            <strong>æš‚ä¸ç¡®å®šä¸»è¦å­˜æ¡£</strong>
                            <span style="font-size: 12px; opacity: 0.8;">AIå°†ä¸ä¼šè¯»å–æœ¬ç« çš„ä»»ä½•è®°å½•</span>
                        </div>
                    </label>
                </div>
            `;
            showDialog(`
                <div class="dialog-title">ä¿å­˜å‰§æƒ…è®°å½•</div>
                <p style="text-align: center; font-size: 14px; margin-bottom: 15px;">é€‰æ‹©ä¸€ä¸ªè®°å½•æ§½è¿›è¡Œè¦†ç›–ï¼Œå¹¶æŒ‡å®šä¸€ä¸ªä½œä¸ºAIè®°å¿†çš„ã€ä¸»è¦è®°å½•ã€‘ã€‚</p>
                ${slotsHtml}
                <div class="dialog-actions">
                    <button class="dialog-btn" id="confirmSaveSettings">ç¡®è®¤è®¾ç½®</button>
                </div>
            `);
            
            document.querySelectorAll('.save-slot-item .btn').forEach(button => {
                button.onclick = async (e) => {
                    const slotIndex = parseInt(e.currentTarget.dataset.slotIndex);
                    if (confirm(`ç¡®å®šè¦è¦†ç›–è®°å½•æ§½ ${slotIndex + 1} å—ï¼Ÿ`)) {
                        chapter.savedSlots[slotIndex] = {
                            messages: JSON.parse(JSON.stringify(state.currentChat.messages)),
                            timestamp: Date.now()
                        };
                        await db.triwizardChapters.put(chapter);
                        alert(`å·²æˆåŠŸä¿å­˜è‡³è®°å½•æ§½ ${slotIndex + 1}ï¼`);
                        hideDialog();
                        showSaveStoryDialog(chapterId);
                    }
                };
            });
            document.getElementById('confirmSaveSettings').onclick = async () => {
                const selectedRadio = document.querySelector('input[name="main-save-slot"]:checked');
                if (!selectedRadio) {
                    return alert("è¯·é€‰æ‹©ä¸€ä¸ªä¸»è¦è®°å½•é€‰é¡¹ï¼");
                }
                const newMainIndex = parseInt(selectedRadio.value);
                if (newMainIndex !== -1 && !chapter.savedSlots[newMainIndex]) {
                    return alert("ä¸èƒ½å°†ä¸€ä¸ªç©ºçš„è®°å½•æ§½è®¾ä¸ºä¸»è¦è®°å½•ï¼è¯·å…ˆå­˜æ¡£ã€‚");
                }
                chapter.mainSaveSlotIndex = newMainIndex;
                await db.triwizardChapters.put(chapter);
                alert("ä¸»è¦è®°å½•è®¾ç½®å·²æ›´æ–°ï¼");
                hideDialog();
            };
        }
        async function moveContactToGroup(contactId, newGroupId) {
            state.groups.forEach(group => {
                const index = group.contactIds.indexOf(contactId);
                if (index > -1) {
                    group.contactIds.splice(index, 1);
                }
            });
            if (newGroupId !== 'ungrouped') {
                const newGroup = state.groups.find(g => g.id === newGroupId);
                if (newGroup) {
                    newGroup.contactIds.push(contactId);
                }
            }
            await db.groups.bulkPut(state.groups);
            renderGroupedContacts();
        }
        function showContextMenu(e, type, id, commentIndex) {
            let items = '';
            
            if (type === 'message') {
                const msg = state.currentChat.messages.find(m => m.id === id); if (!msg) return;
                items = `<div class="context-menu-item" data-action="quote">å¼•ç”¨</div>`;
                if (msg.type === 'text' || msg.type === undefined) {
                     items += `<div class="context-menu-item" data-action="modify">ä¿®æ”¹</div>`;
                }
                items += `<div class="context-menu-item" data-action="delete">åˆ é™¤</div>`;
            } 
            else if (type === 'chatItem') {
                const chat = state.chats.find(c => c.id === id); if (!chat) return;
                const pinAction = chat.isPinned ? 'unpinChat' : 'pinChat';
                const pinText = chat.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶';
                items = `<div class="context-menu-item" data-action="${pinAction}">${pinText}</div>`;
                items += `<div class="context-menu-item" data-action="deleteChat">åˆ é™¤</div>`;
            }
            else if (type === 'groupChatItem') {
                const chat = state.chats.find(c => c.id === id); if (!chat) return;
                const pinAction = chat.isPinned ? 'unpinChat' : 'pinChat';
                const pinText = chat.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶';
                items = `<div class="context-menu-item" data-action="${pinAction}">${pinText}</div>`;
                if (state.currentView === 'contacts') {
                    items += `<div class="context-menu-item" data-action="deleteGroup">åˆ é™¤ç¾¤èŠ</div>`;
                } else {
                    items += `<div class="context-menu-item" data-action="deleteChat">åˆ é™¤</div>`;
                }
            }
            else if (type === 'friendItem') {
                const contact = state.contacts.find(c => c.id === id); if (!contact) return;
                const pinAction = contact.isPinned ? 'unpinContact' : 'pinContact';
                const pinText = contact.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶';
                items = `<div class="context-menu-item" data-action="${pinAction}">${pinText}</div>
                         <div class="context-menu-item" data-action="showMoveToGroupDialog">ç§»åŠ¨åˆ°...</div>`;
            }
             else if (type === 'manageGroupHeader') {
                const group = state.groups.find(g => g.id === id); if (!group) return;
                const pinText = group.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶';
                 items = `<div class="context-menu-item" data-action="renameGroup">é‡å‘½å</div>
                         <div class="context-menu-item" data-action="pinGroup">${pinText}</div>
                         <div class="context-menu-item" data-action="deleteGroupHeader">åˆ é™¤</div>`;
            }
            else if (type === 'moment' || type === 'comment') {
                items += `<div class="context-menu-item" data-action="delete">åˆ é™¤</div>`;
            }
            contextMenu.innerHTML = items;
            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.classList.remove('hidden');
            
            contextMenu.querySelector('[data-action="showMoveToGroupDialog"]')?.addEventListener('click', () => {
                showMoveToGroupDialog(id);
                contextMenu.classList.add('hidden');
            });
            contextMenu.querySelector('[data-action="renameGroup"]')?.addEventListener('click', () => {
                const group = state.groups.find(g => g.id === id);
                if (group) showGroupRenameDialog(id);
                contextMenu.classList.add('hidden');
            });
            contextMenu.querySelector('[data-action="pinGroup"]')?.addEventListener('click', async () => {
                const group = state.groups.find(g => g.id === id);
                if (group) {
                    group.isPinned = !group.isPinned;
                    await db.groups.put(group);
                    showManageGroupsDialog();
                    renderGroupedContacts();
                }
                contextMenu.classList.add('hidden');
            });
            contextMenu.querySelector('[data-action="deleteGroupHeader"]')?.addEventListener('click', async () => {
                const group = state.groups.find(g => g.id === id);
                if (group) {
                    if (confirm(`ç¡®è®¤åˆ é™¤åˆ†ç»„ â€œ${group.name}â€ å—ï¼Ÿ\nåˆ†ç»„å†…çš„å¥½å‹å°†å˜ä¸ºæœªåˆ†ç»„ã€‚`)) {
                        await db.groups.delete(id);
                        state.groups = state.groups.filter(g => g.id !== id);
                        showManageGroupsDialog();
                        renderGroupedContacts();
                    }
                }
                contextMenu.classList.add('hidden');
            });
            contextMenu.querySelector('[data-action="delete"]')?.addEventListener('click', () => { 
                if (type === 'comment') deleteComment(id, commentIndex);
                else if (type === 'moment') deleteMoment(id);
                else if (type === 'message') deleteMessage(id);
                contextMenu.classList.add('hidden'); 
            });
            contextMenu.querySelector('[data-action="quote"]')?.addEventListener('click', async () => { const msg = state.currentChat.messages.find(m => m.id === id); state.replyingTo = { sender: msg.sender, text: msg.text }; await updateAppState(); document.getElementById('messageInput').focus(); contextMenu.classList.add('hidden'); });
            contextMenu.querySelector('[data-action="modify"]')?.addEventListener('click', () => { modifyMessage(id); contextMenu.classList.add('hidden'); });
            
            contextMenu.querySelector('[data-action="pinChat"]')?.addEventListener('click', async () => { 
                const chat = state.chats.find(c=>c.id===id); if(chat) chat.isPinned = true; await db.chats.put(chat);
                if (state.currentView === 'contacts') renderGroupsList(); else switchView('messages', true);
                contextMenu.classList.add('hidden'); 
            });
            contextMenu.querySelector('[data-action="unpinChat"]')?.addEventListener('click', async () => { 
                const chat = state.chats.find(c=>c.id===id); if(chat) chat.isPinned = false; await db.chats.put(chat);
                if (state.currentView === 'contacts') renderGroupsList(); else switchView('messages', true);
                contextMenu.classList.add('hidden'); 
            });
            contextMenu.querySelector('[data-action="pinContact"]')?.addEventListener('click', async () => { 
                const contact = state.contacts.find(c=>c.id===id); if(contact) contact.isPinned = true; await db.contacts.put(contact);
                if (state.currentView === 'contacts') renderGroupedContacts();
                contextMenu.classList.add('hidden'); 
            });
             contextMenu.querySelector('[data-action="unpinContact"]')?.addEventListener('click', async () => { 
                const contact = state.contacts.find(c=>c.id===id); if(contact) contact.isPinned = false; await db.contacts.put(contact);
                if (state.currentView === 'contacts') renderGroupedContacts();
                contextMenu.classList.add('hidden'); 
            });
            contextMenu.querySelector('[data-action="deleteChat"]')?.addEventListener('click', () => { showDeleteChatDialog(id); contextMenu.classList.add('hidden'); });
            contextMenu.querySelector('[data-action="deleteGroup"]')?.addEventListener('click', () => { deleteGroupChat(id); contextMenu.classList.add('hidden'); });
        }
        function showDeleteChatDialog(id) {
            const dialogHtml = `
                <div class="dialog-title">ç¡®è®¤åˆ é™¤</div>
                <p style="text-align: center; margin-bottom: 20px;">è¯·é€‰æ‹©åˆ é™¤æ–¹å¼ï¼š</p>
                <div class="dialog-actions" style="flex-direction: column; gap: 10px; align-items: stretch;">
                    <button class="dialog-btn" id="deleteChatSoft">ä»…ä»åˆ—è¡¨ç§»é™¤ (ä¿ç•™è®°å½•)</button>
                    <button class="dialog-btn logout" id="deleteChatHard">æ¸…ç©ºå…¨éƒ¨èŠå¤©è®°å½• (ä¸å¯æ¢å¤)</button>
                </div>
            `;
            showDialog(dialogHtml);
            document.getElementById('deleteChatSoft').onclick = async () => {
                const chat = state.chats.find(c => c.id === id);
                if (chat) chat.isHidden = true;
                await db.chats.put(chat);
                hideDialog();
                switchView('messages', true);
            };
            document.getElementById('deleteChatHard').onclick = async () => {
                const chat = state.chats.find(c => c.id === id);
                if (chat) {
                    chat.messages = [];
                    chat.lastMessage = 'å¯ä»¥å¼€å§‹èŠå¤©äº†';
                    chat.isHidden = true;
                }
                await db.chats.put(chat);
                hideDialog();
                switchView('messages', true);
            };
        }
        async function deleteMessage(id) { 
            const index = state.currentChat.messages.findIndex(m=>m.id===id); 
            if (index > -1) { 
                state.currentChat.messages.splice(index, 1);
                if (!state.currentChat.isTriwizard) {
                    await db.chats.put(state.currentChat);
                }
                switchView('chat', true);
            }
        }
        async function modifyMessage(id) { 
            const msg = state.currentChat.messages.find(m => m.id === id); 
            if(!msg || (msg.type && msg.type !== 'text')) return alert("åªèƒ½ä¿®æ”¹æ–‡æœ¬æ¶ˆæ¯"); 
            const dialogHtml = `
                <div class="dialog-title">ä¿®æ”¹æ¶ˆæ¯</div>
                <div class="form-group">
                    <textarea id="dialog-edit-input" rows="4" style="-webkit-user-select: text; user-select: text;">${msg.text}</textarea>
                </div>
                <div class="dialog-actions">
                    <button class="dialog-btn cancel-btn" id="dialog-edit-cancel">å–æ¶ˆ</button>
                    <button class="dialog-btn" id="dialog-edit-save">ä¿å­˜</button>
                </div>
            `;
            showDialog(dialogHtml);
            
            document.getElementById('dialog-edit-save').onclick = async () => {
                const newText = document.getElementById('dialog-edit-input').value;
                msg.text = newText;
                if (!state.currentChat.isTriwizard) {
                    await db.chats.put(state.currentChat);
                }
                hideDialog();
                switchView('chat', true);
            };
            document.getElementById('dialog-edit-cancel').onclick = hideDialog;
        }
        async function deleteMoment(id) { let index = (state.myMoments||[]).findIndex(m=>m.id===id); if(index > -1) { state.myMoments.splice(index, 1); await db.myMoments.delete(id); } else { index = (state.friendMoments||[]).findIndex(m=>m.id===id); if(index > -1) { state.friendMoments.splice(index, 1); await db.friendMoments.delete(id); }} switchView('moments', true); }
        async function deleteComment(momentId, commentIndex) {
            const isMyMoment = state.myMoments.some(m => m.id === momentId);
            const moment = isMyMoment ? state.myMoments.find(m => m.id === momentId) : state.friendMoments.find(m => m.id === momentId);
            if (moment && moment.comments && moment.comments[commentIndex]) {
                moment.comments.splice(commentIndex, 1);
                if (isMyMoment) await db.myMoments.put(moment);
                else await db.friendMoments.put(moment);
                switchView('moments', true);
            }
        }
        
        function messageToText(msg) {
            if (state.currentChat.isTriwizard) {
                const sender = msg.incoming ? (msg.sender || 'æ—ç™½') : state.userProfile.name;
                return `${sender}: ${msg.text}`;
            }
            const senderName = msg.incoming ? msg.sender : (state.currentChat.myNickname || msg.sender);
            if (state.currentChat.isGroup) {
                if (state.currentChat.isOfflineMode && !msg.incoming) {
                    return `(${senderName} ${msg.text})`;
                }
                return `${senderName}: ${msg.text}`;
            }
            switch(msg.type) {
                case 'image': return `[æˆ‘å‘äº†ä¸€å¼ å›¾ç‰‡ï¼Œæè¿°æ˜¯ï¼šâ€œ${msg.text || 'æ— '}â€]`;
                case 'emoji': return `<${msg.id}>`;
                case 'gift': 
                    const recipient = msg.gift.recipient ? ` to ${msg.gift.recipient}` : '';
                    return `[æˆ‘é€äº†ä½ ä¸€ä¸ªç¤¼ç‰©ï¼šâ€œ${msg.gift.name}â€${recipient}ï¼Œå¿ƒæ„æ˜¯ï¼šâ€œ${msg.gift.message || 'æ— '}â€]`;
                case 'text': return msg.quote ? `(å›å¤ ${msg.quote.sender}: "${msg.quote.text}") ${msg.text}` : msg.text || "";
                default: return `[ä¸€æ¡${msg.type}ç±»å‹çš„æ¶ˆæ¯]`;
            }
        }
        
        async function fetchApiModels(config) {
            const { url, key } = config;
            if (!url || !key) throw new Error("API URL å’Œ Key ä¸èƒ½ä¸ºç©º");
            
            let fetchUrl, headers;
            if (url.includes('generativelanguage.googleapis.com')) {
                fetchUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${key}`;
                headers = { 'Content-Type': 'application/json' };
            } else {
                const baseUrl = new URL(url.replace(/\/$/, ''));
                fetchUrl = new URL('/v1/models', baseUrl).href;
                headers = { 'Authorization': `Bearer ${key}` };
            }
            try {
                const res = await fetch(fetchUrl, { headers });
                const data = await res.json();
                if (!res.ok) {
                    const errorMsg = data.error?.message || `æœåŠ¡å™¨è¿”å›é”™è¯¯: ${res.status}`;
                    throw new Error(errorMsg);
                }
                if (url.includes('generativelanguage.googleapis.com')) {
                    return data.models
                        .filter(m => m.supportedGenerationMethods.includes('generateContent'))
                        .map(m => m.name.replace('models/', ''));
                } else {
                    return data.data.map(m => m.id);
                }
            } catch (error) {
                if (error instanceof TypeError) {
                    throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥ (å¯èƒ½æ˜¯CORSè·¨åŸŸé—®é¢˜æˆ–URLæ— æ•ˆ)");
                }
                throw error;
            }
        }
        
        async function callApi(systemPrompt, history = [], config = state.apiConfig) {
            const { url, key, model } = config;
            if (!url || !key || !model) {
                throw new Error("API URL, Key, å’Œæ¨¡å‹åç§°æœªé…ç½®ã€‚");
            }
            
            try {
                let res, data;
                const processedHistory = history.map(m => ({
                    role: m.incoming ? 'model' : 'user',
                    content: messageToText(m)
                })).filter(m => m.content);
                
                const maxTokens = 400;
                if (url.includes('generativelanguage.googleapis.com')) {
                    const baseUrl = new URL(url);
                    const fullUrl = new URL(`v1beta/models/${model}:generateContent?key=${key}`, baseUrl).href;
                    const contents = [
                        { role: 'user', parts: [{ text: systemPrompt }] },
                        { role: 'model', parts: [{ text: "å¥½çš„ï¼Œæˆ‘æ˜ç™½äº†ã€‚æˆ‘ä¼šä¸¥æ ¼éµå®ˆæ‰€æœ‰æŒ‡ä»¤è¿›è¡Œè§’è‰²æ‰®æ¼”ã€‚" }] }
                    ].concat(processedHistory.map(m => ({ role: m.role, parts: [{ text: m.content }] })));
                    
                    res = await fetch(fullUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents, generationConfig: {maxOutputTokens: maxTokens} }) });
                    data = await res.json();
                    
                    if (!res.ok) throw new Error(data.error?.message || `HTTP ${res.status}`);
                    if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content.parts) return "(APIè¿”å›äº†ç©ºå“åº”æˆ–ä¸å®Œæ•´çš„æ•°æ®)";
                    return data.candidates[0].content.parts[0].text.trim();
                } else {
                    const baseUrl = new URL(url.replace(/\/$/, ''));
                    const completionUrl = new URL('/v1/chat/completions', baseUrl).href;
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    };
                    const messages = [
                        { role: "system", content: systemPrompt },
                        ...processedHistory.map(m => ({ 
                            role: m.role === 'model' ? 'assistant' : 'user', 
                            content: m.content
                        }))
                    ];
                    
                    res = await fetch(completionUrl, { method: 'POST', headers, body: JSON.stringify({ model: model, messages: messages, max_tokens: maxTokens }) });
                    data = await res.json();
                    
                    if (!res.ok) throw new Error(data.error?.message || `æœªçŸ¥çš„APIé”™è¯¯ (HTTP ${res.status})`);
                    if (!data.choices || data.choices.length === 0) return "(APIè¿”å›äº†ç©ºå“åº”)";
                    return data.choices[0].message.content.trim();
                }
            } catch (error) {
                if (error instanceof TypeError) {
                    throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥ (å¯èƒ½æ˜¯CORSè·¨åŸŸé—®é¢˜æˆ–URLæ ¼å¼é”™è¯¯)");
                }
                throw error;
            }
        }
        
        function parseHogwartsResponse(content) {
            const trimmedContent = content.trim();
            if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
                try {
                    const parsed = JSON.parse(trimmedContent);
                    if (Array.isArray(parsed) && parsed.every(item => typeof item === 'object' && item !== null && 'name' in item && 'content' in item)) {
                         console.log("è§£ææˆåŠŸï¼šæ ‡å‡†JSONæ•°ç»„æ ¼å¼(ç¾¤èŠ/ä¸‰å¼ºèµ›)ã€‚");
                         return parsed.map(p => ({ ...p, type: 'text' }));
                    }
                } catch (e) {
                    console.warn("æ ‡å‡†JSONæ•°ç»„è§£æå¤±è´¥ï¼Œå°†å°è¯•å¼ºåŠ›è§£æ...");
                }
            }
            const jsonMatches = trimmedContent.match(/{[^{}]*}/g);
            if (jsonMatches) {
                const results = [];
                for (const match of jsonMatches) {
                    try {
                        const parsedObject = JSON.parse(match);
                        if ('name' in parsedObject && 'content' in parsedObject) {
                             results.push({ ...parsedObject, type: 'text' });
                        } else if ('type' in parsedObject && 'content' in parsedObject) {
                             results.push(parsedObject);
                        }
                    } catch (e) {
                        console.warn("è·³è¿‡ä¸€ä¸ªæ— æ•ˆçš„JSONç‰‡æ®µ:", match);
                    }
                }
                if (results.length > 0) {
                    console.log("è§£ææˆåŠŸï¼šé€šè¿‡å¼ºåŠ›æå–JSONå¯¹è±¡æ¨¡å¼ã€‚");
                    return results;
                }
            }
            
            const legacyMatches = [...trimmedContent.matchAll(/\[([^\]]+)\]|<([^>]+)>/g)];
            if (legacyMatches.length > 0) {
                 console.log("è§£ææˆåŠŸï¼šé€šè¿‡æ—§ç‰ˆæ ¼å¼å…¼å®¹æ¨¡å¼ã€‚");
                 return legacyMatches.map(match => {
                    if (match[1]) return { type: 'text', content: match[1] };
                    if (match[2]) return { type: 'emoji', id: match[2] };
                 }).filter(Boolean);
            }
            console.error("æ‰€æœ‰è§£ææ–¹æ¡ˆå‡å¤±è´¥ï¼å°†è¿”å›åŸå§‹æ–‡æœ¬ä½œä¸ºå•æ¡æ¶ˆæ¯ã€‚");
            return [{ type: 'text', content: content }];
        }
        async function generateUnifiedHistoryText(contactId, totalLimit = 50) {
            if (!contactId) return "";
            const contact = state.contacts.find(c => c.id === contactId);
            if (!contact) return "";
            
            const allEvents = [];
            const p = state.userProfile;
        
            const privateChat = state.chats.find(c => c.contactId === contactId);
            if (privateChat && privateChat.messages) {
                privateChat.messages.forEach(m => {
                    if (!m.id || !m.id.includes('_')) return;
                    allEvents.push({
                        timestamp: parseInt(m.id.split('_')[1]),
                        text: `[ç§èŠ] ${m.incoming ? contact.name : p.name}: ${m.type === 'text' || !m.type ? m.text : `[${m.type}æ¶ˆæ¯]`}`
                    });
                });
            }
        
            const groupChats = state.chats.filter(c => c.isGroup && c.members.some(m => m.id === contactId));
            groupChats.forEach(group => {
                if (group.messages) {
                    group.messages.forEach(m => {
                         if (!m.id || !m.id.includes('_')) return;
                         allEvents.push({
                            timestamp: parseInt(m.id.split('_')[1]),
                            text: `[ç¾¤èŠ: ${group.name}] ${m.sender}: ${m.type === 'text' || !m.type ? m.text : `[${m.type}æ¶ˆæ¯]`}`
                        });
                    });
                }
            });
            try {
                const recentMoments = await db.myMoments.orderBy('id').reverse().limit(10).toArray();
                const recentFriendMoments = await db.friendMoments.orderBy('id').reverse().limit(20).toArray();
                
                recentMoments.forEach(moment => {
                    const hasInteraction = (moment.likedBy && moment.likedBy.includes(contact.name)) || (moment.comments && moment.comments.some(c => c.author === contact.name));
                    if(hasInteraction){
                        let interactionSummary = (moment.comments || []).filter(c => c.author === contact.name).map(c => `${c.author}: ${c.text}`).join('; ');
                        if((moment.likedBy || []).includes(contact.name)) interactionSummary = "[èµ] " + interactionSummary;
                        allEvents.push({
                            timestamp: parseInt(moment.id.split('_')[1]),
                            text: `[åŠ¨æ€äº’åŠ¨] ä½ å‘å¸ƒäº†åŠ¨æ€: "${moment.content}". ${contact.name} å›åº”: ${interactionSummary}`
                        });
                    }
                });
                recentFriendMoments.forEach(moment => {
                    if(moment.name === contact.name) {
                        allEvents.push({
                           timestamp: parseInt(moment.id.split('_')[1]),
                           text: `[åŠ¨æ€å‘å¸ƒ] ${contact.name} å‘å¸ƒäº†åŠ¨æ€: "${moment.content}"`
                        });
                    }
                });
            } catch (e) { console.error("Failed to fetch moments for memory:", e); }
        
            const sortedEvents = allEvents.sort((a, b) => b.timestamp - a.timestamp);
            const recentHistory = sortedEvents.slice(0, totalLimit).reverse();
        
            if (recentHistory.length === 0) {
                return "æœ€è¿‘æ²¡æœ‰ä¸æ­¤äººç›¸å…³çš„äº’åŠ¨è®°å½•ã€‚";
            }
            
            return recentHistory.map(m => m.text).join('\n\n');
        }
        async function getTriwizardMemoryPool() {
            try {
                const allChapters = await db.triwizardChapters.toArray();
                if (!allChapters || allChapters.length === 0) return "";
        
                let memoryPoolText = "";
                for (const chapter of allChapters) {
                    if (chapter.mainSaveSlotIndex > -1 && chapter.savedSlots[chapter.mainSaveSlotIndex]) {
                        const mainSave = chapter.savedSlots[chapter.mainSaveSlotIndex];
                        const chapterHistory = mainSave.messages
                            .map(msg => {
                                const sender = msg.incoming ? (msg.sender || 'æ—ç™½') : state.userProfile.name;
                                return `${sender}: ${msg.text}`;
                            })
                            .join('\n');
                        memoryPoolText += `--- ç« èŠ‚ã€Š${chapter.name}ã€‹çš„ä¸»è¦è®°å¿† ---\n${chapterHistory}\n\n`;
                    }
                }
                return memoryPoolText.trim() || "ç©å®¶å°šæœªåœ¨ä»»ä½•ä¸‰å¼ºäº‰éœ¸èµ›ç« èŠ‚ä¸­è®¾å®šä¸»è¦å­˜æ¡£ã€‚";
            } catch (error) {
                console.error("Error building Triwizard memory pool:", error);
                return "ï¼ˆè¯»å–ä¸‰å¼ºäº‰éœ¸èµ›è®°å¿†æ—¶å‘ç”Ÿé”™è¯¯ï¼‰";
            }
        }
        async function getApiResponse(mode = "reply") {
            const historyEl = document.getElementById('chatHistory');
            const scroll = () => { if(historyEl) historyEl.scrollTop = historyEl.scrollHeight; };
            const isGroup = state.currentChat.isGroup;
            const isTriwizard = state.currentChat.isTriwizard;
            const contact = isGroup || isTriwizard ? null : state.contacts.find(c => c.id === state.currentChat.contactId);
            const contactName = isGroup ? state.currentChat.name : (isTriwizard ? "å‰§æƒ…" : contact.name);
            
            const showError = async (text) => {
                const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                const reply = { id: `msg_${Date.now()}`, type:'text', text, time, incoming: true, sender: "ç³»ç»Ÿ" };
                state.currentChat.messages.push(reply);
                if(historyEl) {
                    const errorEl = document.createElement('div');
                    errorEl.className = 'message incoming';
                    errorEl.innerHTML = `<div class="message-sender">ç³»ç»Ÿ</div><div class="message-text">${text}</div><span class="message-time">${time}</span>`;
                    historyEl.appendChild(errorEl);
                    scroll();
                }
                if (!isTriwizard) await updateChatList(text, true);
            };
            if (!state.apiConfig.key) {
                await showError("ï¼ˆAPIæœªé…ç½®ï¼Œè¯·åœ¨â€œæˆ‘â€çš„é¡µé¢è®¾ç½®ï¼‰");
                return;
            }
            const typingEl = document.createElement('div');
            typingEl.className = 'message incoming';
            typingEl.innerHTML = `<div class="message-sender">${contactName}</div><div style="padding: 8px 15px;"><div style="width: 8px; height: 8px; background-color: #f0e6d2; border-radius: 50%; display:inline-block; animation: typing 1.5s infinite ease-in-out;"></div> <div style="width: 8px; height: 8px; background-color: #f0e6d2; border-radius: 50%; display:inline-block; animation: typing 1.5s infinite ease-in-out 0.15s;"></div> <div style="width: 8px; height: 8px; background-color: #f0e6d2; border-radius: 50%; display:inline-block; animation: typing 1.5s infinite ease-in-out 0.3s;"></div></div>`;
            if(historyEl) { historyEl.appendChild(typingEl); scroll(); }
            const p = state.userProfile;
            const triwizardMemoryPool = await getTriwizardMemoryPool();
            
            let systemPrompt;
            const isOffline = !!state.currentChat.isOfflineMode;
            if (isTriwizard) {
                systemPrompt = `ä½ æ˜¯ä¸€ä¸ªäº’åŠ¨å°è¯´æ¸¸æˆçš„ä¸»æŒäººï¼ˆGame Masterï¼‰ï¼Œéœ€è¦æ‰®æ¼”å¤šä¸ªè§’è‰²ã€‚
# æ¸¸æˆèƒŒæ™¯ï¼š
å“ˆåˆ©æ³¢ç‰¹ä¸–ç•Œï¼Œä¸‰å¼ºäº‰éœ¸èµ›æœŸé—´ã€‚
# ç©å®¶ä¿¡æ¯ï¼š
å§“å: ${p.name} (å§“: ${p.lastName}, å: ${p.firstName})
å­¦é™¢: ${HOUSE_INFO[p.house].name}
æ€§æ ¼: ${p.personality}
# æ¸¸æˆæ€»è®°å¿† (æ¥è‡ªç©å®¶åœ¨æ‰€æœ‰ç« èŠ‚ä¸­é€‰æ‹©çš„ä¸»è¦å­˜æ¡£):
${triwizardMemoryPool}
# ä½ çš„ä»»åŠ¡ï¼š
1.  **å¤šè§’è‰²æ‰®æ¼”**ï¼šä½ å°†æ‰®æ¼”ã€é™¤äº†ç©å®¶ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå“ˆåˆ©Â·æ³¢ç‰¹ã€èµ«æ•ã€ç½—æ©ã€é©¬å°”ç¦ã€æ–¯å†…æ™®ã€é‚“å¸ƒåˆ©å¤šç­‰ã€‚
2.  **æ‰®æ¼”æ—ç™½**ï¼šå½“éœ€è¦æè¿°ç¾¤ä½“è¡Œä¸ºã€æ™¯ç‰©ã€æ°”æ°›æˆ–éç‰¹å®šè§’è‰²çš„åŠ¨ä½œæ—¶ï¼Œä½ å°†ä½¿ç”¨ â€œæ—ç™½â€ ä½œä¸ºè§’è‰²åã€‚æ—ç™½åº”ä½¿ç”¨ç¬¬äºŒäººç§°â€œä½ â€æ¥ä¸ç©å®¶äº’åŠ¨ã€‚
3.  **æ¨åŠ¨å‰§æƒ…**ï¼šæ ¹æ®ç©å®¶çš„è¡ŒåŠ¨å’Œå¯¹è¯ï¼Œä»¥åŠæ€»è®°å¿†ä¸­çš„å†…å®¹ï¼Œè‡ªç„¶åœ°æ¨è¿›æ•…äº‹å‘å±•ã€‚
4.  **ç»´æŒä¸–ç•Œè§‚**ï¼šä¸¥æ ¼éµå®ˆå“ˆåˆ©æ³¢ç‰¹çš„ä¸–ç•Œè§‚å’Œæ‰€æœ‰è§’è‰²çš„æ—¢å®šäººè®¾ï¼Œã€ç»å¯¹ä¸èƒ½å´©äººè®¾ã€‘ã€‚
5.  **äº’åŠ¨è¦æ±‚**ï¼šæ¯ä¸€æ¬¡å›å¤ï¼Œåº”è‡³å°‘æœ‰ã€äº”ä¸ªã€‘è§’è‰²ï¼ˆåŒ…æ‹¬â€œæ—ç™½â€ï¼‰è¿›è¡Œå‘è¨€æˆ–è¡ŒåŠ¨æè¿°ï¼Œä»¥è¥é€ ä¸°å¯Œçš„äº’åŠ¨åœºæ™¯ã€‚
# ***æœ€æœ€æœ€é‡è¦çš„è¾“å‡ºè§„åˆ™ (ABSOLUTE MANDATORY RULES)***
1.  **ã€æ ¼å¼é“åˆ™ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚: \`[{"name": "æ—ç™½", "content": "ä½ èµ°è¿›äº†å¤§å…ã€‚"}, {"name": "èµ«æ•Â·æ ¼å…°æ°", "content": "ä½ ç»ˆäºæ¥äº†ï¼"}, {"name": "ç½—æ©Â·éŸ¦æ–¯è±", "content": "æˆ‘ä»¬ç­‰ä½ å¾ˆä¹…äº†ã€‚"}]\`
2.  **ã€å…ƒç´ é“åˆ™ã€‘**: æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ã€‘ï¼Œä¸”ã€å¿…é¡»ã€‘åŒ…å« "name" å’Œ "content" ä¸¤ä¸ªå­—æ®µã€‚
3.  **ã€ç¦æ­¢ã€‘**: ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„ä¹‹å¤–è¾“å‡ºä»»ä½•å…¶ä»–æ–‡å­—ã€è§£é‡Šæˆ–æ³¨é‡Šã€‚
4.  **ã€ç¦æ­¢ã€‘**: ã€ç»å¯¹ç¦æ­¢ã€‘æ‰®æ¼”ç©å®¶ï¼ˆ${p.name}ï¼‰çš„è§’è‰²ã€‚
ç°åœ¨ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°ã€æ‰€æœ‰é“åˆ™ã€‘ï¼Œæ ¹æ®ä¸‹æ–¹çš„æœ€æ–°å¯¹è¯å†å²ï¼Œç»§ç»­è¿™ä¸ªæ•…äº‹ã€‚`;
            }
            else if(isGroup) {
                const myNickname = state.currentChat.myNickname || p.name;
                const membersListPromises = state.currentChat.members.map(async m => {
                    const contact = state.contacts.find(c => c.id === m.id);
                    const persona = m.persona || (contact ? contact.info : '');
                    const history = contact ? (contact.sharedHistory || 'æ— å…±åŒè®°å¿†') : 'æ— å…±åŒè®°å¿†';
                    const recentChatHistory = contact ? await generateUnifiedHistoryText(contact.id) : 'æ— ç›¸å…³èŠå¤©è®°å½•';
                    const indentedRecentHistory = recentChatHistory.split('\n').map(line => `    ${line}`).join('\n');
                    const displayName = m.nickname || m.name;
                    if (!persona || persona.trim() === '') {
                        return `- **${displayName}** (åŸå: ${m.name}):\n  - äººè®¾: (æ— å¯ç”¨äººè®¾ï¼Œè¯¥è§’è‰²ä¸ä¼šå‘è¨€)`;
                    }
                    return `- **${displayName}** (åŸå: ${m.name}):
    - äººè®¾: ${persona}
    - å’Œç©å®¶çš„é•¿æœŸè®°å¿†: ${history}
    - æœ€è¿‘çš„è·¨èŠå¤©/äº‹ä»¶è®°å½•:
${indentedRecentHistory}`;
                });
                const membersList = (await Promise.all(membersListPromises)).join('\n');
                
                if (isOffline) {
                    systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¾¤èŠåœºæ™¯çš„AIå™äº‹è€…ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **ã€å™äº‹è€…èº«ä»½ã€‘**: ä½ ä¸æ˜¯ä»»ä½•ä¸€ä¸ªè§’è‰²ï¼Œè€Œæ˜¯ä¸Šå¸è§†è§’çš„å™äº‹è€…/å‰§æœ¬ä½œè€…ã€‚ä½ çš„ä»»åŠ¡æ˜¯ç”ŸåŠ¨åœ°æç»˜ã€é™¤äº†ç©å®¶ä»¥å¤–ã€‘æ‰€æœ‰è§’è‰²çš„ã€è¯­è¨€ã€åŠ¨ä½œã€ç¥æ€ã€å¿ƒç†æ´»åŠ¨ã€åœºæ™¯ã€‘ã€‚
2.  **ã€ç©å®¶èº«ä»½ã€‘**: ç©å®¶çš„è§’è‰²æ˜¯ã€${myNickname}ã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘æ›¿ç©å®¶åšä»»ä½•å†³å®šæˆ–æå†™ã€‚æ‰€æœ‰å¯¹ç©å®¶çš„æè¿°éƒ½åº”ä½¿ç”¨ç¬¬äºŒäººç§°â€œä½ â€ã€‚
3.  **ã€è¾“å‡ºæ ¼å¼ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªã€å•ä¸€çš„ã€è¿ç»­çš„æ–‡æœ¬å—ã€‘ã€‚æ‰€æœ‰éå¯¹è¯å†…å®¹ã€å¿…é¡»ã€‘ç”¨ä¸­æ–‡æ‹¬å·ï¼ˆï¼‰æ‹¬èµ·æ¥ã€‚å¯¹è¯å†…å®¹åˆ™ä¸éœ€è¦æ‹¬å·ï¼Œä½†ã€å¿…é¡»ã€‘åœ¨å¯¹è¯å‰æ˜ç¡®æ ‡æ³¨è¯´è¯è€…çš„å§“åæˆ–æ˜µç§°ã€‚ä¾‹å¦‚: \`å¾·æ‹‰ç§‘: â€œè¿™çœŸæ˜¯è’è°¬ã€‚â€ï¼ˆä»–è½»è½»åœ°å“¼äº†ä¸€å£°ã€‚ï¼‰\`
4.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾â€ä¸­çš„æ¯ä¸€ä¸ªè§’è‰²çš„è®¾å®šã€‚
5.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIã€æ¨¡å‹æˆ–å™äº‹è€…ã€‚
# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾
${membersList}
# ç©å®¶çš„è§’è‰²
- **${myNickname}** (åŸå: ${p.name}): ${p.personality}
# ä¼šè¯æ¦‚è¦ (ç©å®¶æ‰‹åŠ¨æ€»ç»“):
${state.currentChat.summary || "æš‚æ— æ¦‚è¦ã€‚"}
# (èƒŒæ™¯ä¿¡æ¯) ä¸‰å¼ºäº‰éœ¸èµ›ä¸»è¦è®°å¿†:
${triwizardMemoryPool}
ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œä¸‹æ–¹çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿™åœºçº¿ä¸‹ç¾¤èŠåœºæ™¯ã€‚`;
                } else {
                    systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¾¤èŠAIï¼Œè´Ÿè´£æ‰®æ¼”ã€é™¤äº†ç©å®¶ä»¥å¤–ã€‘çš„æ‰€æœ‰è§’è‰²ã€‚
# æ ¸å¿ƒè§„åˆ™
1.  **ã€èº«ä»½é“å¾‹ã€‘**: ç©å®¶çš„èº«ä»½æ˜¯ã€${myNickname}ã€‘ã€‚ä½ ã€ç»å¯¹ä¸èƒ½ã€‘ç”Ÿæˆ name å­—æ®µä¸º "${myNickname}" çš„æ¶ˆæ¯ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æ‰®æ¼”ä¸”ä»…èƒ½æ‰®æ¼”ä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨â€ä¸­æ˜ç¡®åˆ—å‡ºçš„è§’è‰²ã€‚
2.  **ã€è¾“å‡ºæ ¼å¼ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªå¸¦æœ‰ "name" å’Œ "content" å­—æ®µçš„JSONå¯¹è±¡ã€‘ã€‚nameå­—æ®µå¿…é¡»æ˜¯è§’è‰²çš„ã€ç¾¤æ˜µç§°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰æˆ–åŸåã€‘ã€‚ä¾‹å¦‚: \`[{"name": "é©¬å°”ç¦", "content": "è¿™çœŸæ˜¯è’è°¬ã€‚"}, {"name": "èµ«æ•Â·æ ¼å…°æ°", "content": "å¾·æ‹‰ç§‘,æ³¨æ„ä½ çš„è¨€è¾ï¼"}]\`
3.  **è§’è‰²æ‰®æ¼”**: ä¸¥æ ¼éµå®ˆä¸‹æ–¹â€œç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾â€ä¸­çš„æ¯ä¸€ä¸ªè§’è‰²çš„è®¾å®šï¼Œå°¤å…¶æ˜¯ä»–ä»¬çš„é•¿æœŸå’ŒçŸ­æœŸè®°å¿†ã€‚
4.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIæˆ–æ¨¡å‹ã€‚
5.  **ã€å‘è¨€èµ„æ ¼ã€‘**: ä½ åªèƒ½ä¸ºé‚£äº›åœ¨ä¸‹æ–¹åˆ—è¡¨ä¸­æ‹¥æœ‰æ˜ç¡®â€œäººè®¾â€çš„è§’è‰²ç”Ÿæˆå‘è¨€ã€‚å¦‚æœä¸€ä¸ªè§’è‰²çš„äººè®¾æ˜¯â€œ(æ— å¯ç”¨äººè®¾...)"ï¼Œåˆ™ã€ç»å¯¹ä¸èƒ½ã€‘ä¸ºè¯¥è§’è‰²ç”Ÿæˆä»»ä½•å‘è¨€ã€‚
# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾
${membersList}
# ç©å®¶çš„è§’è‰²
- **${myNickname}** (åŸå: ${p.name}): ${p.personality}
# ä¼šè¯æ¦‚è¦ (ç©å®¶æ‰‹åŠ¨æ€»ç»“):
${state.currentChat.summary || "æš‚æ— æ¦‚è¦ã€‚"}
# (èƒŒæ™¯ä¿¡æ¯) ä¸‰å¼ºäº‰éœ¸èµ›ä¸»è¦è®°å¿†:
${triwizardMemoryPool}
ç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šæ‰€æœ‰è§„åˆ™å’Œä¸‹æ–¹çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿™åœºç¾¤èŠã€‚`;
                }
            } else {
                let playerAddressName = '';
                const isProfessor = contact.id.startsWith('prof');
                if (isProfessor) {
                    playerAddressName = p.lastName ? (p.gender === 'å¥³' ? `${p.lastName}å°å§` : `${p.lastName}å…ˆç”Ÿ`) : p.name;
                } else {
                    playerAddressName = p.firstName || p.name;
                }
                const wandInfo = `æœ¨æ: ${p.wand.wood}, æ–èŠ¯: ${p.wand.core}, é•¿åº¦: ${p.wand.length}, æŸ”éŸ§åº¦: ${p.wand.flex}`;
                const customEmojis = p.customEmojis || {};
                const emojiListString = Object.entries(customEmojis).map(([id, data]) => `${id}ï¼š${data.name}`).join('\n');
                
                const recentChatHistory = await generateUnifiedHistoryText(contact.id);
                
                let modeInstructions = '';
                let outputRules = '';
                if (isOffline) {
                    modeInstructions = `# å½“å‰æ¨¡å¼ï¼šçº¿ä¸‹æ¨¡å¼
    ä½ å’Œæˆ‘çš„äº¤æµå¤„äºã€çº¿ä¸‹æ¨¡å¼ã€‘ï¼Œè¯·ç”¨å‰§æœ¬ä½“å›å¤ã€‚`;
                    outputRules = `# ***æœ€æœ€æœ€é‡è¦çš„è¾“å‡ºè§„åˆ™ (ABSOLUTE MANDATORY RULES)***
    ä½ æ¥ä¸‹æ¥çš„æ¯ä¸€æ¬¡å›å¤éƒ½ã€å¿…é¡»ã€‘ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è§„åˆ™ï¼Œæ²¡æœ‰ä»»ä½•ä¾‹å¤–ï¼
    1.  **ã€å†…å®¹æ ¸å¿ƒã€‘**: ä½ çš„å›å¤å¿…é¡»æ˜¯è¯¦ç»†ä¸”ä¼˜ç¾çš„ã€è¯­è¨€ã€åŠ¨ä½œã€ç¥æ€ã€å¿ƒç†æ´»åŠ¨ã€åœºæ™¯æå†™ã€‘çš„ç»“åˆã€‚
    2.  **ã€æ ¼å¼ã€‘**: æ‰€æœ‰éå¯¹è¯å†…å®¹ã€å¿…é¡»ã€‘ç”¨ä¸­æ–‡æ‹¬å·ï¼ˆï¼‰æ‹¬èµ·æ¥ã€‚å¯¹è¯å†…å®¹åˆ™ä¸éœ€è¦æ‹¬å·ã€‚éå¯¹è¯å†…å®¹ä¸å¯¹è¯å†…å®¹ä¹‹é—´ã€å¿…é¡»ã€‘å¦èµ·ä¸€æ®µã€‚
    3.  **ã€äººç§°ã€‘**: å¯¹äºä½ è‡ªå·±ï¼Œã€å¿…é¡»ã€‘ä½¿ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚å¯¹äºæˆ‘ï¼ˆç©å®¶ï¼‰ï¼Œã€å¿…é¡»ã€‘ä½¿ç”¨ç¬¬äºŒäººç§°â€œä½ â€ã€‚ä¾‹å¦‚ï¼šï¼ˆæˆ‘è½»è½»æ‹‰èµ·äº†ä½ çš„æ‰‹ã€‚ï¼‰
    4.  **ã€é•¿åº¦é“åˆ™ã€‘**: ä½ çš„æ€»å›å¤å†…å®¹ã€å¿…é¡»è¶…è¿‡100å­—ã€‘ã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯æå†™çš„ä¸°å¯Œæ€§ã€‚**ã€ç»å¯¹ç¦æ­¢ã€‘** ç”Ÿæˆå°‘äº100å­—çš„æ€»å›å¤ã€‚
    5.  **ã€è¾“å‡ºæ ¼å¼ã€‘**: **ã€ä¸¥ç¦ã€‘** å°†ä½ çš„å›å¤æ‹†åˆ†æˆå¤šæ¡æ¶ˆæ¯ã€‚ä½ å¿…é¡»ç”Ÿæˆä¸€ä¸ªã€å•ä¸€çš„ã€è¿ç»­çš„æ–‡æœ¬å—ã€‘ä½œä¸ºå›å¤ã€‚
    6.  **ã€ç¦æ­¢ã€‘**: ã€ä¸¥ç¦ã€‘ä½¿ç”¨è¡¨æƒ…åŒ…æˆ–ä»»ä½•JSONæ ¼å¼ã€‚`;
                } else {
                    modeInstructions = `# å½“å‰æ¨¡å¼ï¼šçº¿ä¸Šæ¨¡å¼
    ä½ å’Œæˆ‘çš„äº¤æµå¤„äºã€çº¿ä¸Šæ¨¡å¼ã€‘ï¼Œè¯·åƒä½¿ç”¨èŠå¤©è½¯ä»¶ä¸€æ ·å›å¤ã€‚`;
                    outputRules = `# ***æœ€æœ€æœ€é‡è¦çš„è¾“å‡ºè§„åˆ™ (ABSOLUTE MANDATORY RULES)***
    ä½ æ¥ä¸‹æ¥çš„æ¯ä¸€æ¬¡å›å¤éƒ½ã€å¿…é¡»ã€‘ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è§„åˆ™ï¼Œæ²¡æœ‰ä»»ä½•ä¾‹å¤–ï¼
    1.  **ã€æ ¼å¼é“åˆ™ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚: \`[{"type":"text", "content":"ä½ å¥½å‘€ï¼"}, {"type":"text", "content":"ä»Šå¤©å¤©æ°”çœŸä¸é”™"}]\`
    2.  **ã€å…ƒç´ é“åˆ™ã€‘**: æ•°ç»„ä¸­çš„ã€æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªJSONå¯¹è±¡ã€‘ã€‚
    3.  **ã€å¯¹è¯èŠ‚å¥é“åˆ™ã€‘**: ä½ çš„å›å¤ã€å¿…é¡»ã€‘ä¸¥æ ¼éµå®ˆæ€»æ•°50å­—å·¦å³ï¼Œä¸”å¿…é¡»åˆ†æˆã€ä¸‰æ¡åŠä»¥ä¸Šã€‘ç‹¬ç«‹æ¶ˆæ¯çš„æ ¼å¼å‘å‡ºã€‚å•æ¡æ¶ˆæ¯åº”ç®€çŸ­ç²¾ç‚¼ã€‚ä¾‹å¦‚ï¼Œä¸è¦å‘ä¸€æ¡é•¿æ¶ˆæ¯ \`[{"type":"text", "content":"ä½ å¥½å‘€ï¼Œä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼Œæˆ‘ä»¬ä¸€èµ·å‡ºå»ç©å§æ€ä¹ˆæ ·ï¼Ÿ"}]\`ï¼Œè€Œæ˜¯è¦æ‹†åˆ†æˆ \`[{"type":"text", "content":"ä½ å¥½å‘€ï¼"}, {"type":"text", "content":"ä»Šå¤©å¤©æ°”çœŸä¸é”™"}, {"type":"text", "content":"æˆ‘ä»¬å‡ºå»ç©å§ï¼Ÿ"}]\`ã€‚
    4.  **ã€ç¦æ­¢ã€‘**: ã€ç»å¯¹ç¦æ­¢ã€‘è¾“å‡ºä»»ä½•æ‹¬å·å†…çš„åŠ¨ä½œã€ç¥æ€ã€å¿ƒç†æˆ–åœºæ™¯æå†™ã€‚æ‰€æœ‰å›å¤éƒ½åº”æ˜¯è§’è‰²ä¼šç›´æ¥é€šè¿‡èŠå¤©è½¯ä»¶è¯´å‡ºçš„è¯ã€‚
    5.  **ã€ç¦æ­¢ã€‘**: ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨JSONæ•°ç»„ä¹‹å¤–è¾“å‡ºä»»ä½•å…¶ä»–æ–‡å­—ã€è§£é‡Šæˆ–æ³¨é‡Šã€‚
    ## ä½ å¯ä»¥ä½¿ç”¨çš„æ“ä½œæŒ‡ä»¤ (JSONæ•°ç»„ä¸­çš„å…ƒç´ ):
    -   **å‘é€æ–‡æœ¬**: \`{"type": "text", "content": "æ¶ˆæ¯å†…å®¹"}\`
    -   **å‘é€è¡¨æƒ…**: \`{"type": "emoji", "id": "è¡¨æƒ…åŒ…ID"}\` (IDå¿…é¡»ä»ä¸‹é¢çš„åˆ—è¡¨ä¸­é€‰æ‹©)
    # å¯ç”¨è¡¨æƒ…åŒ…åˆ—è¡¨:
    ${emojiListString || '(æ— å¯ç”¨è¡¨æƒ…åŒ…)'}`;
                }
                systemPrompt = `ä½ æ­£åœ¨æ‰®æ¼”ã€Šå“ˆåˆ©Â·æ³¢ç‰¹ã€‹ä¸–ç•Œä¸­çš„è§’è‰²ã€‚
    ${modeInstructions}
    # ä½ çš„è§’è‰²ä¿¡æ¯:
    å§“å: ${contact.name}
    ${contact.info}
    # ä½ æ­£åœ¨ä¸æˆ‘å¯¹è¯ï¼Œæˆ‘çš„è§’è‰²ä¿¡æ¯ (å·«å¸ˆæ¡£æ¡ˆ):
    å§“å: ${p.name} (å§“: ${p.lastName}, å: ${p.firstName}) æ€§åˆ«: ${p.gender} å¹´é¾„: ${p.age || 'æœªçŸ¥'} å­¦é™¢: ${HOUSE_INFO[p.house].name} è¡€ç»Ÿ: ${p.blood} é­”æ–: ${wandInfo} å®ˆæŠ¤ç¥: ${p.patronus} å® ç‰©: ${p.pet} å¤–è²Œ: ${p.appearance} æ€§æ ¼: ${p.personality} èº«ä»½èƒŒæ™¯: ${p.identity}
    # æˆ‘ä»¬ä¹‹é—´å‘ç”Ÿè¿‡ä»¥ä¸‹äº‹æƒ… (å…±åŒç»å† - é•¿æœŸè®°å¿†):
    ${contact.sharedHistory || "æˆ‘ä»¬æ˜¯åˆšè®¤è¯†çš„åŒå­¦ã€‚"}
    # æœ€è¿‘çš„è·¨èŠå¤©/äº‹ä»¶è®°å½• (è‡ªåŠ¨æå– - çŸ­æœŸè®°å¿†):
    ${recentChatHistory}
    # ä¼šè¯æ¦‚è¦ (å½“å‰èŠå¤©æ‰‹åŠ¨æ€»ç»“):
    ${state.currentChat.summary || "æš‚æ— æ¦‚è¦ã€‚"}
    # (èƒŒæ™¯ä¿¡æ¯) ä¸‰å¼ºäº‰éœ¸èµ›ä¸»è¦è®°å¿†:
    ${triwizardMemoryPool}
    # é‡è¦ç§°å‘¼è§„åˆ™:
    ä½ åº”è¯¥ç§°å‘¼æˆ‘ä¸ºâ€œ${playerAddressName}â€ã€‚é™¤éè¯­å¢ƒç‰¹æ®Šéœ€è¦ï¼Œå¦åˆ™è¯·é¿å…ä½¿ç”¨æˆ‘çš„å…¨åâ€œ${p.name}â€ã€‚
    ${outputRules}
    # é€šç”¨è§„åˆ™:
    **ã€ç¦æ­¢ä»£å…¥ã€‘**: ã€ä¸¥ç¦ã€‘ä»£å…¥ç©å®¶ï¼ˆâ€œ${p.name}â€ï¼‰çš„è§’è‰²å‘è¨€æˆ–è¿›è¡Œå¿ƒç†æå†™ã€‚
    ç°åœ¨ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°ã€æ‰€æœ‰é“åˆ™ã€‘ï¼ŒåŸºäºå¯¹è¯å†å²ï¼Œç”Ÿæˆä½ çš„å›å¤ã€‚`;
            }
            const historyForApi = state.currentChat.messages.slice(-150);
            
            try {
                const rawReply = await callApi(systemPrompt, historyForApi);
                if(historyEl && historyEl.contains(typingEl)) historyEl.removeChild(typingEl);
                
                if (isTriwizard) {
                    const responseActions = parseHogwartsResponse(rawReply);
                    const newMessages = [];
                    for (const action of responseActions) {
                        const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                        if (action.name && action.content) {
                            newMessages.push({ id: `msg_${Date.now()}_${newMessages.length}`, type: 'text', text: action.content, time, incoming: true, sender: action.name });
                        }
                    }
                    if (newMessages.length > 0) {
                        state.currentChat.messages.push(...newMessages);
                        switchView('chat', true);
                    } else {
                        await showError("ï¼ˆé­”æ³•é€šè®¯å—åˆ°äº†å¹²æ‰°... AIè¿”å›äº†æ— æ³•è§£ææˆ–ç©ºçš„å†…å®¹ã€‚ï¼‰");
                    }
                }
                else if(isGroup && isOffline) {
                    if (rawReply) {
                        const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                        const reply = { id: `msg_${Date.now()}`, type:'text', text: rawReply, time, incoming: true, sender: "åœºæ™¯" };
                        state.currentChat.messages.push(reply);
                        await updateChatList("[åœºæ™¯æè¿°]", true);
                        switchView('chat', true);
                    } else {
                        await showError("ï¼ˆé­”æ³•é€šè®¯å—åˆ°äº†å¹²æ‰°...ï¼‰");
                    }
                }
                else if(isGroup) {
                    const responseActions = parseHogwartsResponse(rawReply);
                    const newMessages = [];
                    for (const action of responseActions) {
                         const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                         if (action.name && action.content) {
                            newMessages.push({ id: `msg_${Date.now()}_${newMessages.length}`, type: 'text', text: action.content, time, incoming: true, sender: action.name });
                         }
                    }
                    state.currentChat.messages.push(...newMessages);
                    await updateChatList(newMessages.length > 0 ? `${newMessages[newMessages.length-1].sender}: ${newMessages[newMessages.length-1].text}` : '...', true);
                    switchView('chat', true);
                }
                else if (isOffline) {
                    if (rawReply) {
                        const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                        const reply = { id: `msg_${Date.now()}`, type:'text', text: rawReply, time, incoming: true, sender: contact.name };
                        state.currentChat.messages.push(reply);
                        await updateChatList(rawReply, true);
                        switchView('chat', true);
                    } else {
                        await showError("ï¼ˆé­”æ³•é€šè®¯å—åˆ°äº†å¹²æ‰°...ï¼‰");
                    }
                } else {
                    const responseActions = parseHogwartsResponse(rawReply);
                    if (responseActions.length > 0) {
                        const newMessages = [];
                        for (const action of responseActions) {
                            const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                            if (action.type === 'text' && action.content) { 
                                newMessages.push({ id: `msg_${Date.now()}_${newMessages.length}`, type: 'text', text: action.content, time, incoming: true, sender: contact.name });
                            } else if (action.type === 'emoji' && action.id) {
                                const emojiData = (state.userProfile.customEmojis || {})[action.id];
                                if (emojiData) {
                                    newMessages.push({ id: `msg_${Date.now()}_${newMessages.length}`, type: 'emoji', url: emojiData.url, name: emojiData.name, time, incoming: true, sender: contact.name });
                                }
                            }
                        }
                        
                        state.currentChat.messages.push(...newMessages);
                        await updateChatList(newMessages.length > 0 ? (newMessages[newMessages.length-1].type === 'text' ? newMessages[newMessages.length-1].text : '[è¡¨æƒ…]') : '...', true);
                        switchView('chat', true);
                    } else if (rawReply) {
                         const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                         const reply = { id: `msg_${Date.now()}`, type:'text', text: rawReply, time, incoming: true, sender: contact.name };
                         state.currentChat.messages.push(reply);
                         await updateChatList(rawReply, true);
                         switchView('chat', true);
                    } else {
                        await showError("ï¼ˆé­”æ³•é€šè®¯å—åˆ°äº†å¹²æ‰°...ï¼‰");
                    }
                }
            } catch (e) {
                if(historyEl && historyEl.contains(typingEl)) historyEl.removeChild(typingEl);
                await showError(`ï¼ˆé­”æ³•é€šè®¯å¹²æ‰°: ${e.message}ï¼‰`);
            }
        }
        
        async function addMessageToChat(msgData) {
            const time = new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'});
            const myNickname = state.currentChat.isTriwizard ? state.userProfile.name : (state.currentChat.myNickname || state.userProfile.name);
            const msg = { ...msgData, id: `msg_${Date.now()}`, time, incoming: false, sender: myNickname };
            state.currentChat.messages.push(msg);
            
            if (!state.currentChat.isTriwizard) {
                let lastMessageText = '[æ¶ˆæ¯]';
                switch (msg.type) {
                    case 'text': lastMessageText = msg.text; break;
                    case 'image': lastMessageText = '[å›¾ç‰‡]'; break;
                    case 'emoji': lastMessageText = '[è¡¨æƒ…]'; break;
                    case 'gift': lastMessageText = '[ç¤¼ç‰©]'; break;
                }
                await updateChatList(lastMessageText, false);
            }
            switchView('chat', true);
        }
        async function updateContactIdReferences(oldId, newId) { 
            state.chats.forEach(chat => { if (chat.contactId === oldId) { chat.contactId = newId; chat.name = newId; } }); 
            await db.chats.where({ contactId: oldId }).modify({ contactId: newId, name: newId });
        }
        
        async function updateChatList(lastMessage, isIncoming) {
            const chat = state.currentChat;
            chat.lastMessage = lastMessage.length > 20 ? lastMessage.substring(0, 20) + "..." : lastMessage;
            chat.time = new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'});
            if (isIncoming) chat.unread = (chat.unread || 0) + 1;
            
            chat.isHidden = false;
            await db.chats.put(chat);
            state.chats = await db.chats.toArray();
        }
        
        async function generateAIFriendMoments() {
            const btn = document.getElementById('generateMomentsBtn');
            if(btn) { btn.innerText = "ç”Ÿæˆä¸­..."; btn.disabled = true; }
            const potentialPosters = state.contacts.filter(c => 
                !c.oc || (c.oc && c.info && c.info.trim() !== '')
            );
            if (potentialPosters.length === 0) {
                alert("æ²¡æœ‰å¯å‘å¸ƒåŠ¨æ€çš„å¥½å‹ï¼ˆè¯·ç¡®ä¿åŸåˆ›è§’è‰²çš„â€œåŸºæœ¬ä¿¡æ¯â€å·²å¡«å†™ï¼Œæ‰èƒ½æ¿€æ´»ä»–ä»¬ï¼‰ã€‚");
                if(btn) { btn.innerText = "åˆ·æ–°å¥½å‹åŠ¨æ€"; btn.disabled = false; }
                return;
            }
            const triwizardMemoryPool = await getTriwizardMemoryPool();
            for (let i = 0; i < 3; i++) {
                const friend = potentialPosters[Math.floor(Math.random() * potentialPosters.length)];
                
                const recentHistory = await generateUnifiedHistoryText(friend.id, 15);
                
                const prompt = `# ä»»åŠ¡ï¼šæ‰®æ¼”è§’è‰²å¹¶å‘å¸ƒä¸€æ¡åŠ¨æ€
    ä½ æ­£åœ¨æ‰®æ¼”ã€Šå“ˆåˆ©Â·æ³¢ç‰¹ã€‹é‡Œçš„è§’è‰²ï¼š${friend.name}ã€‚
    # è§’è‰²è®¾å®š
    ${friend.info}
    # ä½ å’Œç©å®¶æœ€è¿‘çš„å…±åŒè®°å¿†:
    ${recentHistory}
    # (èƒŒæ™¯ä¿¡æ¯) ä¸‰å¼ºäº‰éœ¸èµ›ä¸»è¦è®°å¿†:
    ${triwizardMemoryPool}
    # ä½ çš„ä»»åŠ¡
    åŸºäºä½ çš„è§’è‰²è®¾å®šå’Œæ‰€æœ‰è®°å¿†ï¼Œç”Ÿæˆä¸€æ¡å®Œå…¨ç¬¦åˆä½ äººè®¾å’Œå½“å‰å¿ƒå¢ƒçš„åŠ¨æ€ã€çº¯æ–‡æœ¬å†…å®¹ã€‘ã€‚
    # è¾“å‡ºé“åˆ™ (ABSOLUTE MANDATORY RULES)
    1.  ã€ç»å¯¹ç¦æ­¢ã€‘è¾“å‡ºä»»ä½•ä¸åŠ¨æ€å†…å®¹æ— å…³çš„æ–‡å­—ã€‚
    2.  ã€ç»å¯¹ç¦æ­¢ã€‘ä½¿ç”¨æ˜Ÿå·(*)æè¿°åŠ¨ä½œæˆ–å¿ƒç†ã€‚
    3.  ã€ç»å¯¹ç¦æ­¢ã€‘åœ¨å†…å®¹å‰åæ·»åŠ ä»»ä½•æ ‡ç­¾ã€è§’è‰²åæˆ–å¼•å·ã€‚
    4.  ã€ç»å¯¹ç¦æ­¢ã€‘è¾“å‡ºä»»ä½•JSONæˆ–Markdownæ ¼å¼ã€‚
    # ç°åœ¨ï¼Œåªè¾“å‡ºçº¯æ–‡æœ¬åŠ¨æ€ã€‚`;
                
                try {
                    const content = await callApi(prompt);
                    if(content) {
                        const cleanedContent = content.replace(/^(åŠ¨æ€|å†…å®¹|å›å¤|æˆ‘çš„åŠ¨æ€)[:ï¼š\s]*/, '').trim();
                        if (cleanedContent) { 
                            const newMoment = { id: `fm_${Date.now()}_${i}`, name: friend.name, house: friend.house, time: `${Math.floor(Math.random()*50)+10}åˆ†é’Ÿå‰`, content: cleanedContent, comments: [], likedBy: [] };
                            state.friendMoments.unshift(newMoment);
                            await db.friendMoments.put(newMoment);
                        }
                    }
                } catch (e) {
                    alert(`ç”ŸæˆåŠ¨æ€å¤±è´¥: ${e.message}`);
                    break;
                }
            }
            if(state.currentView === 'moments') switchView('moments', true);
            if(btn) { btn.innerText = "åˆ·æ–°å¥½å‹åŠ¨æ€"; btn.disabled = false; }
        }
        async function getApiCommentForMoment(moment) {
            const p = state.userProfile;
            let commenter, prompt;
            const lastComment = moment.comments && moment.comments.length > 0 ? moment.comments[moment.comments.length - 1] : null;
            const triwizardMemoryPool = await getTriwizardMemoryPool();
            
            if (lastComment && lastComment.author === p.name && moment.name !== p.name) {
                commenter = state.contacts.find(c => c.name === moment.name);
                if (!commenter) return; 
                
                const sharedHistoryWithPlayer = await generateUnifiedHistoryText(commenter.id);
                prompt = `# ä»»åŠ¡ï¼šæ‰®æ¼”è§’è‰²å¹¶å›å¤è¯„è®º
ä½ ã€å¿…é¡»ã€‘æ‰®æ¼”ã€Šå“ˆåˆ©Â·æ³¢ç‰¹ã€‹ä¸–ç•Œé‡Œçš„è§’è‰²ï¼š${commenter.name}ã€‚
# ä½ å’Œç©å®¶ (${p.name}) çš„å…±åŒè®°å¿†å’Œæœ€è¿‘äº‹ä»¶:
${sharedHistoryWithPlayer || 'æ— '}
# (èƒŒæ™¯ä¿¡æ¯) ä¸‰å¼ºäº‰éœ¸èµ›ä¸»è¦è®°å¿†:
${triwizardMemoryPool}
# æƒ…æ™¯
è¿™æ˜¯ä½ ä¹‹å‰å‘å¸ƒçš„åŠ¨æ€: "${moment.content}"
ä½ çš„æœ‹å‹ ${p.name} åˆšåˆšè¯„è®ºäº†: "${lastComment.text}"
# ä½ çš„ä»»åŠ¡
ä»¥ ${commenter.name} çš„èº«ä»½å’Œå£å»ï¼Œã€åªé’ˆå¯¹ã€‘${p.name} çš„è¿™æ¡æœ€æ–°è¯„è®ºè¿›è¡Œå›å¤ã€‚
# è¾“å‡ºé“åˆ™ (ABSOLUTE MANDATORY RULES)
1.  ä½ çš„æœ€ç»ˆè¾“å‡ºã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯å›å¤çš„ã€çº¯æ–‡æœ¬å†…å®¹ã€‘ã€‚
2.  ã€ç»å¯¹ç¦æ­¢ã€‘æ·»åŠ ä»»ä½•å‰ç¼€ï¼Œå¦‚â€œè¯„è®º:â€æˆ–ä½ è‡ªå·±çš„åå­—ã€‚
3.  ã€ç»å¯¹ç¦æ­¢ã€‘è¾“å‡ºä»»ä½•JSONæˆ–Markdownæ ¼å¼ã€‚
# ç°åœ¨ï¼Œåªè¾“å‡ºçº¯æ–‡æœ¬è¯„è®ºã€‚`;
                 try {
                    const rawResponse = await callApi(prompt);
                    if (rawResponse) {
                        const text = rawResponse.trim().replace(/^.*?:/, '').trim();
                        if (text) {
                            if (!moment.comments) moment.comments = [];
                            moment.comments.push({ author: commenter.name, text: text, replyTo: p.name });
                        }
                    }
                } catch(e) { console.error("ç”ŸæˆAIè¯„è®ºå¤±è´¥(åœºæ™¯1):", e); }
            } else {
                const potentialCommenters = state.contacts.filter(c => 
                    c.name !== moment.name && 
                    c.name !== p.name && 
                    !(moment.comments || []).some(com => com.author === c.name) &&
                    (!c.oc || (c.oc && c.info && c.info.trim() !== '')) &&
                    !(moment.blockedContactIds || []).includes(c.id) 
                ).sort(() => 0.5 - Math.random()); 
                if (potentialCommenters.length === 0) return;
                
                const replyCount = Math.min(potentialCommenters.length, Math.floor(Math.random() * 3) + 3); 
                const commentersToReply = potentialCommenters.slice(0, replyCount);
                for (const commenter of commentersToReply) {
                    const commentsContext = (moment.comments || []).map(c => `${c.author}${c.replyTo ? ` @ ${c.replyTo}`: ''}: ${c.text}`).join('\n');
                    
                    const sharedHistoryWithPlayer = await generateUnifiedHistoryText(commenter.id);
                    prompt = `# ä»»åŠ¡ï¼šæ‰®æ¼”è§’è‰²å¹¶è¯„è®ºåŠ¨æ€
ä½ ã€å¿…é¡»ã€‘æ‰®æ¼”ã€Šå“ˆåˆ©Â·æ³¢ç‰¹ã€‹ä¸–ç•Œé‡Œçš„è§’è‰²ï¼š${commenter.name}ã€‚
# è§’è‰²è®¾å®š
${commenter.info}
# ä½ å’Œç©å®¶ (${p.name}) çš„å…±åŒè®°å¿†å’Œæœ€è¿‘äº‹ä»¶:
${sharedHistoryWithPlayer || 'æ— '}
# (èƒŒæ™¯ä¿¡æ¯) ä¸‰å¼ºäº‰éœ¸èµ›ä¸»è¦è®°å¿†:
${triwizardMemoryPool}
# æƒ…æ™¯
ä½ çš„æœ‹å‹ ${moment.name} å‘å¸ƒäº†ä¸€æ¡åŠ¨æ€ã€‚
- åŠ¨æ€å†…å®¹: "${moment.content}"
- å·²æœ‰è¯„è®º:
${commentsContext || 'ï¼ˆè¿˜æ²¡æœ‰è¯„è®ºï¼‰'}
# ä½ çš„ä»»åŠ¡
ä»¥ ${commenter.name} çš„èº«ä»½å’Œå£å»ï¼Œé’ˆå¯¹ã€åŠ¨æ€å†…å®¹ã€‘æˆ–ã€å·²æœ‰è¯„è®ºã€‘ï¼Œæ’°å†™ä¸€æ¡å”¯ä¸€çš„ã€ç¬¦åˆäººè®¾çš„è¯„è®ºã€‚
# è¾“å‡ºé“åˆ™ (ABSOLUTE MANDATORY RULES)
1.  ä½ çš„æœ€ç»ˆè¾“å‡ºã€å¿…é¡»ä¸”åªèƒ½ã€‘æ˜¯è¯„è®ºçš„ã€çº¯æ–‡æœ¬å†…å®¹ã€‘ã€‚
2.  ã€ç»å¯¹ç¦æ­¢ã€‘æ·»åŠ ä»»ä½•å‰ç¼€ï¼Œæ¯”å¦‚ä½ çš„åå­—ã€"è¯„è®º:" ç­‰ã€‚
3.  ã€ç»å¯¹ç¦æ­¢ã€‘è¾“å‡ºä»»ä½•JSONæˆ–Markdownæ ¼å¼ã€‚
# ç°åœ¨ï¼Œåªè¾“å‡ºçº¯æ–‡æœ¬è¯„è®ºã€‚`;
                     try {
                        const rawResponse = await callApi(prompt);
                        if (rawResponse) {
                            let text = rawResponse.trim().replace(/^.*?:/, '').trim();
                            let replyTo = null;
                            const replyMatch = text.match(/^@(\S+)\s/);
                            if (replyMatch) {
                                replyTo = replyMatch[1];
                                text = text.substring(replyMatch[0].length);
                            }
                            if (text) {
                                if (!moment.comments) moment.comments = [];
                                moment.comments.push({ author: commenter.name, text: text, replyTo: replyTo });
                            }
                        }
                    } catch(e) { console.error("ç”ŸæˆAIè¯„è®ºå¤±è´¥(åœºæ™¯2):", e); }
                }
            }
            
            const isMyMoment = state.myMoments.some(m => m.id === moment.id);
            if (isMyMoment) await db.myMoments.put(moment);
            else await db.friendMoments.put(moment);
            if(state.currentView === 'moments') switchView('moments', true);
        }
        
        function renderEmojiPanel() {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = '';
            const emojis = state.userProfile.customEmojis || {};
            Object.entries(emojis).forEach(([id, data]) => {
                const item = document.createElement('img');
                item.src = data.url;
                item.title = data.name;
                item.className = 'emoji-item';
                item.onclick = () => sendEmojiMessage(id);
                grid.appendChild(item);
            });
            const addBtn = document.createElement('div');
            addBtn.className = 'emoji-item emoji-item-add';
            addBtn.innerHTML = '<i class="fas fa-plus"></i>';
            addBtn.onclick = () => showAddEmojiModal();
            grid.prepend(addBtn);
        }
        function showAddEmojiModal() {
            showDialog(`<div class="dialog-title">æ·»åŠ è¡¨æƒ…åŒ…</div>
                        <div class="form-group"><label>è¡¨æƒ…åç§°/æè¿°</label><input type="text" id="emojiName" placeholder="ä¾‹å¦‚ï¼šå¼€å¿ƒ"></div>
                        <div class="form-group"><label>è¡¨æƒ…å›¾ç‰‡URL</label><input type="text" id="emojiUrl" placeholder="https://..."></div>
                        <div style="text-align:center; margin: 10px 0;">æˆ–</div>
                        <div class="form-group"><label>ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶</label><input type="file" id="emojiUpload" accept="image/*"></div>
                        <div class="dialog-actions"><button class="dialog-btn cancel-btn">å–æ¶ˆ</button><button id="confirmAddEmoji" class="dialog-btn">æ·»åŠ </button></div>`);
            
            document.querySelector('.dialog-btn.cancel-btn').onclick = hideDialog;
            document.getElementById('confirmAddEmoji').onclick = async () => {
                const name = document.getElementById('emojiName').value.trim();
                let url = document.getElementById('emojiUrl').value.trim();
                const file = document.getElementById('emojiUpload').files[0];
                if (!name) return alert('è¡¨æƒ…åç§°ä¸èƒ½ä¸ºç©º');
                if (!url && !file) return alert('è¯·æä¾›URLæˆ–ä¸Šä¼ æ–‡ä»¶');
                if (file) {
                    url = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                }
                const id = `emoji_${Date.now()}`;
                if (!state.userProfile.customEmojis) state.userProfile.customEmojis = {};
                state.userProfile.customEmojis[id] = { name, url };
                await db.userProfile.put({id: 'main', ...state.userProfile});
                hideDialog();
                renderEmojiPanel();
            };
        }
        function showDeleteEmojiModal() {
            const emojis = state.userProfile.customEmojis || {};
            if (Object.keys(emojis).length === 0) {
                return alert("æ²¡æœ‰å¯åˆ é™¤çš„è‡ªå®šä¹‰è¡¨æƒ…ã€‚");
            }
            
            let emojiChecklistHtml = '<div style="max-height: 30vh; overflow-y: auto;">';
            Object.entries(emojis).forEach(([id, data]) => {
                emojiChecklistHtml += `<div style="display: flex; align-items: center; margin-bottom: 8px;">
                                           <input type="checkbox" id="del_${id}" value="${id}" name="emoji-to-delete" style="margin-right: 10px;">
                                           <label for="del_${id}" style="display: flex; align-items: center; gap: 8px;">
                                               <img src="${data.url}" style="width: 30px; height: 30px; object-fit: contain;">
                                               <span>${data.name}</span>
                                           </label>
                                       </div>`;
            });
            emojiChecklistHtml += '</div>';
            showDialog(`<div class="dialog-title">åˆ é™¤è¡¨æƒ…åŒ…</div>
                        ${emojiChecklistHtml}
                        <div class="dialog-actions">
                            <button class="dialog-btn cancel-btn">å–æ¶ˆ</button>
                            <button id="confirmDeleteEmoji" class="dialog-btn logout">åˆ é™¤é€‰ä¸­</button>
                        </div>`);
            
            document.querySelector('.dialog-btn.cancel-btn').onclick = hideDialog;
            document.getElementById('confirmDeleteEmoji').onclick = async () => {
                const selected = document.querySelectorAll('input[name="emoji-to-delete"]:checked');
                if (selected.length === 0) return alert("è¯·é€‰æ‹©è¦åˆ é™¤çš„è¡¨æƒ…ã€‚");
                selected.forEach(checkbox => {
                    delete state.userProfile.customEmojis[checkbox.value];
                });
                
                await db.userProfile.put({id: 'main', ...state.userProfile});
                hideDialog();
                renderEmojiPanel();
                alert(`${selected.length}ä¸ªè¡¨æƒ…å·²åˆ é™¤ã€‚`);
            };
        }
        async function sendEmojiMessage(id) {
            const emojiData = (state.userProfile.customEmojis || {})[id];
            if (emojiData) {
                await addMessageToChat({ type: 'emoji', ...emojiData, id: id });
                document.getElementById('emojiPanel').style.display = 'none';
            }
        }
        
        function showGroupCreationDialog() {
            const singleContacts = state.contacts; 
            if (singleContacts.length < 2) {
                return alert("è‡³å°‘éœ€è¦2ä¸ªå¥½å‹æ‰èƒ½åˆ›å»ºç¾¤èŠã€‚");
            }
            let contactsHtml = '<div style="max-height: 40vh; overflow-y: auto; text-align: left;">';
            singleContacts.forEach(contact => {
                contactsHtml += `
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <input type="checkbox" id="member_${contact.id}" value="${contact.id}" name="group-member" style="margin-right: 10px; width: 18px; height: 18px;">
                        <label for="member_${contact.id}" style="display: flex; align-items: center; gap: 8px;">
                            <div class="chat-avatar avatar" style="${getAvatarStyle(contact.avatar, '#ccc')}; width:30px; height:30px; font-size: 16px; flex-shrink: 0;">${!contact.avatar ? contact.icon : ''}</div>
                            <span>${contact.name}</span>
                        </label>
                    </div>`;
            });
            contactsHtml += '</div>';
            showDialog(`
                <div class="dialog-title">åˆ›å»ºç¾¤èŠ</div>
                <div class="form-group">
                    <label>ç¾¤èŠåç§°</label>
                    <input type="text" id="groupNameInput" placeholder="ä¾‹å¦‚ï¼šæ–¯è±ç‰¹æ—å››å¹´çº§">
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©ç¾¤æˆå‘˜ (è‡³å°‘2ä½)</label>
                    ${contactsHtml}
                </div>
                <div class="dialog-actions">
                    <button class="dialog-btn cancel-btn">å–æ¶ˆ</button>
                    <button class="dialog-btn" id="confirmCreateGroup">åˆ›å»º</button>
                </div>
            `);
            document.querySelector('.dialog-btn.cancel-btn').onclick = hideDialog;
            document.getElementById('confirmCreateGroup').onclick = createGroupChat;
        }
        async function createGroupChat() {
            const groupName = document.getElementById('groupNameInput').value.trim();
            if (!groupName) {
                return alert("è¯·è¾“å…¥ç¾¤èŠåç§°ã€‚");
            }
            const selected = document.querySelectorAll('input[name="group-member"]:checked');
            if (selected.length < 2) {
                return alert("è‡³å°‘éœ€è¦é€‰æ‹©2ä½æˆå‘˜ã€‚");
            }
            const memberIds = Array.from(selected).map(cb => cb.value);
            const members = memberIds.map(id => {
                const contact = state.contacts.find(c => c.id === id);
                return { 
                    id: contact.id, 
                    name: contact.name,
                    nickname: null,
                    persona: contact.info,
                    sharedHistory: contact.sharedHistory,
                };
            });
            const newGroup = {
                id: `group_${Date.now()}`,
                name: groupName,
                isGroup: true,
                members: members,
                contactId: null, 
                lastMessage: 'ç¾¤èŠå·²åˆ›å»º',
                time: new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                messages: [],
                background: null,
                isPinned: false,
                summary: "",
                isHidden: false,
                isOfflineMode: false,
                avatar: null,
                myNickname: null
            };
            await db.chats.add(newGroup);
            state.chats.push(newGroup);
            hideDialog();
            const contactsContent = document.getElementById('contactsContent');
            if(contactsContent) {
                document.querySelector('.tab[data-tab="groups"]').click();
            }
        }
        function showManageGroupsDialog() {
            let dialogHtml = `<div class="dialog-title">ç®¡ç†åˆ†ç»„</div><div class="manage-groups-list">`;
        
            const sortedGroups = [...state.groups].sort((a, b) => (b.isPinned || 0) - (a.isPinned || 0));
            const allContactIdsInGroups = new Set(state.groups.flatMap(g => g.contactIds));
            const ungroupedContacts = state.contacts.filter(contact => !allContactIdsInGroups.has(contact.id));
        
            sortedGroups.forEach(group => {
                dialogHtml += generateGroupManageItemHtml(group);
            });
            dialogHtml += generateGroupManageItemHtml({ name: 'æœªåˆ†ç»„', id: 'ungrouped' }, ungroupedContacts);
        
            dialogHtml += `</div>
                <div class="dialog-actions">
                    <button class="dialog-btn" id="addNewGroupInDialog">æ·»åŠ åˆ†ç»„</button>
                </div>`;
            showDialog(dialogHtml, '600px');
        
            document.querySelectorAll('.group-manage-header').forEach(header => {
                header.addEventListener('click', () => {
                    const membersDiv = header.nextElementSibling;
                    const arrow = header.querySelector('.header-arrow');
                    membersDiv.classList.toggle('expanded');
                    arrow.classList.toggle('expanded');
                });
                const groupId = header.dataset.groupId;
                if (groupId !== 'ungrouped') {
                     addLongPressListener(header, (e) => {
                        showContextMenu(e, 'manageGroupHeader', groupId);
                    });
                }
            });
            
            document.getElementById('addNewGroupInDialog').onclick = () => {
                 showAddGroupDialog();
            };
        }
        
        function generateGroupManageItemHtml(group, membersOverride = null) {
            let members;
            if (membersOverride) {
                members = membersOverride;
            } else {
                members = state.contacts.filter(c => group.contactIds.includes(c.id));
            }
            const pinIcon = group.isPinned ? '<i class="fas fa-thumbtack"></i>' : '';
            let membersHtml = members.map(contact => `
                <div class="group-member-item">
                    <div class="avatar group-member-avatar" style="${getAvatarStyle(contact.avatar, 'var(--theme-bubble)')}">${!contact.avatar ? contact.icon : ''}</div>
                    <span>${contact.name}</span>
                </div>
            `).join('');
        
            if (members.length === 0) {
                membersHtml = `<div class="group-member-item" style="opacity:0.7;">ï¼ˆç©ºï¼‰</div>`;
            }
        
            return `
                <div class="group-manage-item">
                    <div class="group-manage-header" data-group-id="${group.id}">
                        <span class="group-manage-header-name">${pinIcon} ${group.name} (${members.length})</span>
                        <i class="fas fa-chevron-down header-arrow"></i>
                    </div>
                    <div class="group-manage-members">
                        ${membersHtml}
                    </div>
                </div>`;
        }
        
        function showAddGroupDialog() {
            const dialogHtml = `
                <div class="dialog-title">æ·»åŠ åˆ†ç»„</div>
                <div class="form-group">
                    <label for="newGroupName">åˆ†ç»„åç§°</label>
                    <input type="text" id="newGroupName" placeholder="è¯·è¾“å…¥æ–°åˆ†ç»„çš„åç§°">
                </div>
                <div class="dialog-actions">
                    <button class="dialog-btn cancel-btn">å–æ¶ˆ</button>
                    <button class="dialog-btn" id="confirmAddGroup">ç¡®è®¤</button>
                </div>
            `;
            showDialog(dialogHtml);
            document.querySelector('.dialog-btn.cancel-btn').onclick = hideDialog;
            document.getElementById('confirmAddGroup').onclick = async () => {
                const groupName = document.getElementById('newGroupName').value.trim();
                if (groupName) {
                    const newGroup = {
                        id: `group_custom_${Date.now()}`, name: groupName, contactIds: [],
                        isDeletable: true, isRenamable: true, isPinned: false
                    };
                    await db.groups.put(newGroup);
                    state.groups.push(newGroup);
                    hideDialog();
                    showManageGroupsDialog();
                    renderGroupedContacts();
                } else {
                    alert("åˆ†ç»„åç§°ä¸èƒ½ä¸ºç©ºã€‚");
                }
            };
        }
        function showGroupRenameDialog(groupId) {
            const group = state.groups.find(g => g.id === groupId);
            if (!group) return;
            const dialogHtml = `
                <div class="dialog-title">é‡å‘½ååˆ†ç»„</div>
                <div class="form-group">
                    <label for="newGroupName">åˆ†ç»„åç§°</label>
                    <input type="text" id="newGroupName" value="${group.name}">
                </div>
                <div class="dialog-actions">
                    <button class="dialog-btn cancel-btn">å–æ¶ˆ</button>
                    <button class="dialog-btn" id="confirmRenameGroup">ç¡®è®¤</button>
                </div>
            `;
            showDialog(dialogHtml);
            document.querySelector('.dialog-btn.cancel-btn').onclick = hideDialog;
            document.getElementById('confirmRenameGroup').onclick = async () => {
                const newName = document.getElementById('newGroupName').value.trim();
                if (newName) {
                    group.name = newName;
                    await db.groups.put(group);
                    hideDialog();
                    showManageGroupsDialog();
                    renderGroupedContacts();
                } else {
                     alert("åˆ†ç»„åç§°ä¸èƒ½ä¸ºç©ºã€‚");
                }
            };
        }
        function showMoveToGroupDialog(contactId) {
            const contact = state.contacts.find(c => c.id === contactId);
            if (!contact) return;
        
            let currentGroupId = 'ungrouped';
            for (const group of state.groups) {
                if (group.contactIds.includes(contactId)) {
                    currentGroupId = group.id;
                    break;
                }
            }
        
            let groupsHtml = `<div style="max-height: 50vh; overflow-y: auto;">`;
            state.groups.forEach(group => {
                const isCurrent = group.id === currentGroupId;
                groupsHtml += `<div class="move-to-group-option ${isCurrent ? 'current' : ''}" data-group-id="${group.id}">
                                ${group.name} ${isCurrent ? '<i class="fas fa-check"></i>' : ''}
                               </div>`;
            });
            const isUngrouped = currentGroupId === 'ungrouped';
            groupsHtml += `<div class="move-to-group-option ${isUngrouped ? 'current' : ''}" data-group-id="ungrouped">
                           æœªåˆ†ç»„ ${isUngrouped ? '<i class="fas fa-check"></i>' : ''}
                           </div>`;
            groupsHtml += `</div>`;
        
            const dialogHtml = `<div class="dialog-title">ç§»åŠ¨ ${contact.name} åˆ°</div>${groupsHtml}`;
            showDialog(dialogHtml);
        
            document.querySelectorAll('.move-to-group-option').forEach(option => {
                option.onclick = async () => {
                    const newGroupId = option.dataset.groupId;
                    if (newGroupId !== currentGroupId) {
                        await moveContactToGroup(contactId, newGroupId);
                    }
                    hideDialog();
                };
            });
        }
        function showGroupSettingsDialog() {
            const chat = state.currentChat;
            const dialogHtml = `
                <div class="dialog-title">${chat.name} è®¾ç½®</div>
                <div class="tabs" id="group-settings-tabs">
                    <div class="tab active" data-tab-content="group-general-settings">å¸¸è§„</div>
                    <div class="tab" data-tab-content="group-members-list">æˆå‘˜</div>
                </div>
                <div id="group-settings-content"></div>
            `;
            showDialog(dialogHtml);
            renderGroupSettingsContent('group-general-settings');
            document.querySelectorAll('#group-settings-tabs .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelector('#group-settings-tabs .tab.active').classList.remove('active');
                    this.classList.add('active');
                    renderGroupSettingsContent(this.dataset.tabContent);
                });
            });
        }
        
        function renderGroupSettingsContent(tabId) {
            const contentEl = document.getElementById('group-settings-content');
            const chat = state.currentChat;
            let html = '';
        
            if (tabId === 'group-general-settings') {
                html = `
                    <div class="form-group">
                        <label for="groupNameEdit">ç¾¤å</label>
                        <input type="text" id="groupNameEdit" value="${chat.name}">
                    </div>
                    <div class="form-group">
                        <label for="myNicknameEdit">æˆ‘çš„ç¾¤æ˜µç§°</label>
                        <input type="text" id="myNicknameEdit" value="${chat.myNickname || ''}" placeholder="é»˜è®¤ä½¿ç”¨è§’è‰²å">
                    </div>
                    <div class="form-group">
                        <label>ç¾¤å¤´åƒ</label>
                        <div style="display:flex; align-items:center; gap: 15px;">
                            <div class="chat-avatar avatar" id="groupAvatarPreview" style="${getAvatarStyle(chat.avatar, '#333')}">${!chat.avatar ? 'ğŸ‘¥' : ''}</div>
                            <input type="file" id="groupAvatarUpload" class="hidden" accept="image/*">
                            <button class="btn primary" onclick="document.getElementById('groupAvatarUpload').click()">ä¸Šä¼ å¤´åƒ</button>
                        </div>
                    </div>
                    <div class="dialog-actions">
                        <button class="dialog-btn" id="saveGeneralGroupSettings">ä¿å­˜</button>
                    </div>
                `;
                contentEl.innerHTML = html;
        
                document.getElementById('groupAvatarUpload').onchange = (e) => handleAvatarUpload(e, dataUrl => {
                    document.getElementById('groupAvatarPreview').style.backgroundImage = `url(${dataUrl})`;
                    document.getElementById('groupAvatarPreview').textContent = '';
                    document.getElementById('groupAvatarPreview').dataset.newAvatar = dataUrl;
                });
        
                document.getElementById('saveGeneralGroupSettings').onclick = async () => {
                    chat.name = document.getElementById('groupNameEdit').value.trim();
                    chat.myNickname = document.getElementById('myNicknameEdit').value.trim() || null;
                    const newAvatar = document.getElementById('groupAvatarPreview').dataset.newAvatar;
                    if (newAvatar) {
                        chat.avatar = newAvatar;
                    }
                    await db.chats.put(chat);
                    hideDialog();
                    alert("ç¾¤è®¾ç½®å·²ä¿å­˜ï¼");
                    switchView('chat', true); 
                };
            } else if (tabId === 'group-members-list') {
                 html = `<div style="max-height: 40vh; overflow-y: auto;">`;
                chat.members.forEach(member => {
                    let addFriendButtonHtml = '';
                    if (chat.id === 'group_hogwarts_default') {
                        const isDumbledore = member.id === 'virtual_dumbledore';
                        const isFriend = state.contacts.some(c => c.id === member.id);
                        if (!isDumbledore && !isFriend) {
                            addFriendButtonHtml = `<button class="add-friend-btn" data-member-id="${member.id}" style="background: var(--theme-light); color: white; border: none; border-radius: 8px; padding: 4px 8px; font-size: 12px; cursor: pointer;">æ·»åŠ å¥½å‹</button>`;
                        }
                    }
                    html += `
                        <div class="chat-item" style="padding: 8px; cursor: default; display: flex; justify-content: space-between; align-items: center;">
                            <div class="chat-content" data-member-id="${member.id}" style="cursor: pointer;">
                                <strong>${member.nickname || member.name}</strong>
                                ${member.nickname ? `<div style="font-size: 12px; opacity: 0.7;">${member.name}</div>` : ''}
                            </div>
                            ${addFriendButtonHtml}
                        </div>
                    `;
                });
                html += `</div>`;
                if (chat.id.startsWith('group_') && !chat.id.endsWith('_default')) {
                    html += `<div class="dialog-actions"><button class="dialog-btn" id="manageMembersBtn">ç®¡ç†ç¾¤æˆå‘˜</button></div>`;
                }
                contentEl.innerHTML = html;
                
                contentEl.querySelectorAll('.chat-content[data-member-id]').forEach(item => {
                    item.onclick = () => showEditGroupMemberDialog(item.dataset.memberId);
                });
                if (chat.id.startsWith('group_') && !chat.id.endsWith('_default')) {
                    document.getElementById('manageMembersBtn').onclick = () => showManageMembersDialog();
                }
                contentEl.querySelectorAll('.add-friend-btn').forEach(button => {
                    button.onclick = async (e) => {
                        const memberId = e.currentTarget.dataset.memberId;
                        await addFriendFromGroup(memberId);
                        renderGroupSettingsContent('group-members-list'); 
                    };
                });
            }
        }
        
        function showEditGroupMemberDialog(memberId) {
            const chat = state.currentChat;
            const member = chat.members.find(m => m.id === memberId);
            const contact = state.contacts.find(c => c.id === memberId);
            const initialPersona = contact ? contact.info : '';
            const masterHistory = contact ? contact.sharedHistory : '';
        
            const dialogHtml = `
                <div class="dialog-title">ç¼–è¾‘æˆå‘˜ - ${member.name}</div>
                <div class="form-group">
                    <label>ç¾¤æ˜µç§°</label>
                    <input type="text" id="memberNicknameEdit" value="${member.nickname || ''}">
                </div>
                <div class="form-group">
                    <label>ç¾¤æˆå‘˜äººè®¾ (ä¼šè¦†ç›–å¥½å‹ä¿¡æ¯)</label>
                    <textarea id="memberPersonaEdit" rows="4" placeholder="é»˜è®¤: ${initialPersona}">${member.persona || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>å…±åŒç»å† (å°†åŒæ­¥æ›´æ–°è‡³è¯¥è§’è‰²çš„æ‰€æœ‰èŠå¤©ä¸­)</label>
                    <textarea id="memberHistoryEdit" rows="3" placeholder="æ— å…±åŒè®°å¿†">${masterHistory || ''}</textarea>
                </div>
                <div class="dialog-actions">
                    <button class="dialog-btn" id="saveMemberSettings">ä¿å­˜</button>
                </div>
            `;
            showDialog(dialogHtml);
        
            document.getElementById('saveMemberSettings').onclick = async () => {
                member.nickname = document.getElementById('memberNicknameEdit').value.trim() || null;
                member.persona = document.getElementById('memberPersonaEdit').value.trim() || null;
                const newHistory = document.getElementById('memberHistoryEdit').value.trim() || null;
                const contactToUpdate = state.contacts.find(c => c.id === member.id);
                if (contactToUpdate) {
                    contactToUpdate.sharedHistory = newHistory;
                    await db.contacts.put(contactToUpdate);
                }
                
                member.sharedHistory = null; 
                
                await db.chats.put(chat);
                hideDialog();
                showGroupSettingsDialog(); 
            };
        }
        
               function showManageMembersDialog() {
            const chat = state.currentChat;
            let membersHtml = `<div style="max-height: 25vh; overflow-y: auto;">`;
            chat.members.forEach(member => {
                membersHtml += `
                    <div style="display:flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid var(--theme-bubble);">
                        <span>${member.nickname || member.name}</span>
                        <button class="btn logout" data-member-id="${member.id}" style="padding: 4px 8px; font-size: 12px;">åˆ é™¤</button>
                    </div>
                `;
            });
            membersHtml += `</div>`;
        
            const dialogHtml = `
                <div class="dialog-title">ç®¡ç†ç¾¤æˆå‘˜</div>
                ${membersHtml}
                <div class="dialog-actions" style="margin-top: 25px;">
                    <button class="dialog-btn" id="addFromFriendsBtn">æ·»åŠ å¥½å‹</button>
                    <button class="dialog-btn" id="addVirtualBtn">æ·»åŠ è™šæ‹Ÿäººå‘˜</button>
                </div>
            `;
            showDialog(dialogHtml, '600px');
        
            document.querySelectorAll('.btn.logout[data-member-id]').forEach(btn => {
                btn.onclick = async (e) => {
                    const memberId = e.currentTarget.dataset.memberId;
                    const memberIndex = chat.members.findIndex(m => m.id === memberId);
                    if (memberIndex > -1) {
                        chat.members.splice(memberIndex, 1);
                        await db.chats.put(chat);
                        showManageMembersDialog(); 
                    }
                };
            });
        
            document.getElementById('addFromFriendsBtn').onclick = () => {
                const availableFriends = state.contacts.filter(c => !chat.members.some(m => m.id === c.id));
                let friendsHtml = `<div style="max-height: 40vh; overflow-y: auto;">`;
                availableFriends.forEach(friend => {
                    friendsHtml += `
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="add_${friend.id}" value="${friend.id}" name="friend-to-add" style="margin-right: 10px;">
                            <label for="add_${friend.id}">${friend.name}</label>
                        </div>`;
                });
                friendsHtml += `</div>`;
                showDialog(`
                    <div class="dialog-title">ä»å¥½å‹åˆ—è¡¨æ·»åŠ </div>
                    ${friendsHtml}
                    <div class="dialog-actions">
                        <button class="dialog-btn" id="confirmAddFriends">ç¡®è®¤æ·»åŠ </button>
                    </div>
                `);
                document.getElementById('confirmAddFriends').onclick = async () => {
                    const selected = document.querySelectorAll('input[name="friend-to-add"]:checked');
                    selected.forEach(checkbox => {
                        const contact = state.contacts.find(c => c.id === checkbox.value);
                        if (contact) {
                            chat.members.push({ id: contact.id, name: contact.name, nickname: null, persona: contact.info, sharedHistory: contact.sharedHistory });
                        }
                    });
                    await db.chats.put(chat);
                    hideDialog();
                    showManageMembersDialog();
                };
            };
        
            document.getElementById('addVirtualBtn').onclick = () => {
                const dialogHtml = `
                    <div class="dialog-title">æ·»åŠ è™šæ‹Ÿäººå‘˜</div>
                    <div class="form-group">
                        <label>å§“å</label>
                        <input type="text" id="virtualMemberNameInput" placeholder="è¾“å…¥å§“å">
                    </div>
                    <div class="dialog-actions">
                        <button class="dialog-btn cancel-btn" id="cancelAddVirtual">å–æ¶ˆ</button>
                        <button class="dialog-btn" id="confirmAddVirtualMember">ç¡®è®¤</button>
                    </div>`;
                showDialog(dialogHtml);
                document.getElementById('cancelAddVirtual').onclick = hideDialog;
                document.getElementById('confirmAddVirtualMember').onclick = async () => {
                    const name = document.getElementById('virtualMemberNameInput').value.trim();
                    if (name) {
                        const newMember = {
                            id: `virtual_${Date.now()}`,
                            name: name,
                            nickname: null, persona: null, sharedHistory: null
                        };
                        chat.members.push(newMember);
                        await db.chats.put(chat);
                        hideDialog();
                        showManageMembersDialog();
                    } else {
                        alert("å§“åä¸èƒ½ä¸ºç©ºã€‚");
                    }
                };
            };
        }
        async function deleteGroupChat(chatId) {
             if (confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä¸ªç¾¤èŠå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                await db.chats.delete(chatId);
                state.chats = state.chats.filter(c => c.id !== chatId);
                alert("ç¾¤èŠå·²åˆ é™¤ã€‚");
                if (state.currentView === 'contacts') {
                    renderGroupsList();
                } else {
                    switchView('messages', true);
                }
            }
        }
        async function addFriendFromGroup(memberId) {
            if (state.contacts.some(c => c.id === memberId)) {
                alert("æ­¤äººå·²æ˜¯æ‚¨çš„å¥½å‹ã€‚");
                return;
            }
            const allDefaultContacts = Object.values(getDefaultContacts()).flat();
            const contactDataToAdd = allDefaultContacts.find(c => c.id === memberId);
            if (!contactDataToAdd) {
                alert("é”™è¯¯ï¼šæœªæ‰¾åˆ°è¦æ·»åŠ çš„è§’è‰²æ•°æ®ã€‚");
                console.error("æœªèƒ½ä»é»˜è®¤è”ç³»äººä¸­æ‰¾åˆ°IDä¸º: ", memberId, " çš„è§’è‰²");
                return;
            }
            
            contactDataToAdd.isPinned = false;
            state.contacts.push(contactDataToAdd);
            await db.contacts.put(contactDataToAdd);
            alert(`${contactDataToAdd.name} å·²æˆåŠŸæ·»åŠ åˆ°æ‚¨çš„å¥½å‹åˆ—è¡¨ï¼`);
        }
        
        function renderApp(appInitialized) { 
            if (!appInitialized) {
                appRoot.innerHTML = setupTemplate; 
                bindSetupEvents(); 
                applyHouseTheme('slytherin'); 
            } else { 
                appRoot.innerHTML = mainTemplate; 
                bindMainEvents(); 
            } 
        }
        
        async function initialize() {
            try {
                const isInitialized = await loadDataFromDB();
                renderApp(isInitialized);
                
                appHasInitialized = true;
                const splashScreen = document.getElementById('splash-screen');
                if (splashScreen) {
                    splashScreen.classList.add('hidden');
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 500);
                }
            } catch (error) {
                 const splashScreen = document.getElementById('splash-screen');
                 if(splashScreen){
                    splashScreen.innerHTML = `<div style="color: #ff4d4d; text-align: center; padding: 20px;"><h3>åº”ç”¨åˆå§‹åŒ–å¤±è´¥</h3><p style="font-size: 12px; margin-top: 15px;">${error.stack}</p></div>`;
                 }
            }
        }
        initialize();
    })();
}
window.onload = startApp;
</script>
</body>
</html>